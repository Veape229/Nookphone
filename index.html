<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NookPhone</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%233DAA86%22 stroke-width=%222.5%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z%22/><path d=%22M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12%22/></svg>">
    
    <meta name="theme-color" content="#7FE2C3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <style>
        :root {
            --theme-bg: #7FE2C3;
            --theme-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' fill='%23ffffff' fill-opacity='0.25' fill-rule='evenodd'/%3E%3C/svg%3E");
            --theme-primary: #3DAA86; 
            --theme-secondary: #FDFDF6;
            --theme-text: #59584D;
            --theme-btn-shadow: #2D8666;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Varela Round', 'Kosugi Maru', sans-serif;
            background-color: var(--theme-bg);
            background-image: var(--theme-pattern);
            background-size: 40px 40px; 
            color: var(--theme-text);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nook-card {
            background-color: #FDFDF6;
            border-radius: 28px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.05), 0 12px 20px rgba(0,0,0,0.05); 
            padding: 16px;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .nook-btn {
            background-color: var(--theme-primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 999px;
            font-weight: 800;
            box-shadow: 0 5px 0 var(--theme-btn-shadow);
            transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            top: 0;
            transform: scale(1);
        }
        .nook-btn:active { top: 5px; box-shadow: 0 0 0 var(--theme-btn-shadow); transform: scale(0.95); }
        .nook-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); transform: none; top:0; box-shadow: none;}

        .nook-btn-secondary {
            background-color: #E0E0E0;
            color: #7A7A7A;
            box-shadow: 0 5px 0 #BDBDBD;
        }
        .nook-btn-secondary:active { top: 5px; box-shadow: none; transform: scale(0.95); }

        .nook-input {
            width: 100%;
            background: #F0F0F0;
            border: 3px solid transparent;
            padding: 12px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: #59584D;
            outline: none;
            transition: all 0.2s ease;
        }
        .nook-input:focus {
            background: #FFFFFF;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 4px rgba(61, 170, 134, 0.15);
            transform: scale(1.02);
        }

        .app-icon-container {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .app-icon-container:hover { transform: scale(1.1) rotate(3deg); }
        .app-icon-container:active { transform: scale(0.9) rotate(-3deg); filter: brightness(0.9); }

        .app-icon {
            width: 64px; height: 64px;
            border-radius: 24px;
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 10px rgba(0,0,0,0.08), inset 0 2px 4px rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }
        .app-icon::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom right, rgba(255,255,255,0.8), rgba(255,255,255,0));
            opacity: 0.6; pointer-events: none;
        }

        .screen-enter { animation: screen-zoom-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .screen-exit { animation: screen-zoom-out 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        @keyframes screen-zoom-in {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes screen-zoom-out {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.1); }
        }
        
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes pop-in { 
            0% { transform: scale(0.8) translateY(10px); opacity: 0; } 
            100% { transform: scale(1) translateY(0); opacity: 1; } 
        }

        @keyframes stamp-in {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(0.8); opacity: 1; }
            75% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes float-up-fade {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }

        @keyframes toast-slide-down {
            0% { transform: translate(-50%, -100%); opacity: 0; }
            20% { transform: translate(-50%, 10px); opacity: 1; }
            80% { transform: translate(-50%, 10px); opacity: 1; }
            100% { transform: translate(-50%, -100%); opacity: 0; }
        }

        @keyframes slide-out-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }

        .anim-stamp { animation: stamp-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .anim-float { animation: float-up-fade 1s ease-out forwards; }
        .anim-toast { animation: toast-slide-down 2.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
        .anim-slide-out { animation: slide-out-left 0.3s ease-out forwards; }

        .nook-spinner { animation: spin-bounce 2s infinite ease-in-out; }
		/* ... å…¶ä»–åŠ¨ç”» ... */
		        
		        .nook-spinner { animation: spin-bounce 2s infinite ease-in-out; }
		        @keyframes spin-bounce {
		            /* ... */
		        }
		
		        /* æ–°å¢ï¼šç¼“æ…¢æµ®åŠ¨åŠ¨ç”» */
		        @keyframes float-slow {
		            0%, 100% { transform: translateY(0); }
		            50% { transform: translateY(-10px); }
		        }
		        .animate-float-slow { animation: float-slow 4s ease-in-out infinite; }
		        
		        /* ... å…¶ä»–æ ·å¼ ... */
        @keyframes spin-bounce {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-bar-fill { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .nook-switch { position: relative; display: inline-block; width: 52px; height: 32px; }
        .nook-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: .3s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 34px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 4px; bottom: 4px; background-color: white; transition: .3s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #3DAA86; }
        input:checked + .slider:before { transform: translateX(20px); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
	
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // ==========================================
        // 1. LeanCloud é…ç½® (è¯·åœ¨æ­¤å¤„æ›¿æ¢ä½ çš„ AppID å’Œ AppKey)
        // ==========================================
        const APP_ID = "e1gyo4SNGndTb2pIWabwfpGQ-gzGzoHsz"; 
        const APP_KEY = "k1hvdfgR0R9TOdQHH7H2hh5i"; 
        const SERVER_URL = "https://e1gyo4sn.lc-cn-n1-shared.com"; 

        // åˆå§‹åŒ– LeanCloud
        const initLeanCloud = () => {
            if (typeof AV === 'undefined') {
                console.error("LeanCloud SDK åŠ è½½å¤±è´¥ã€‚");
                return false;
            }
            if (APP_ID !== "YOUR_APP_ID") {
                try {
                    AV.init({
                        appId: APP_ID,
                        appKey: APP_KEY,
                        serverURL: SERVER_URL
                    });
                    return true;
                } catch (e) {
                    console.error("LeanCloud åˆå§‹åŒ–é”™è¯¯:", e);
                    return false;
                }
            }
            return false;
        };

        const isCloudInitialized = initLeanCloud();

        // ==========================================
        // 2. å¸¸é‡ä¸è¾…åŠ©å‡½æ•°
        // ==========================================
        const MOCK_USER_ID = "local_user_001";
        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        const AVATAR_LIBRARY = [
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%8B%B8%E7%8C%AB.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E8%B1%86%E7%B2%92.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E8%A5%BF%E6%96%BD%E6%83%A0.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/KK.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E4%BC%81%E9%B9%85%E8%BE%BE.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E5%A4%A7%E5%90%89.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E5%B0%8F%E6%B6%A6.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%8B%971.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E9%B9%BF1.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E8%B5%B5%E5%A5%87.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%8C%AB1.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%8C%AB2.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E6%9C%88%E5%85%94.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E5%A8%83%E5%A8%831.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E5%A8%83%E5%A8%832.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%9C%BC%E9%95%9C%E7%BB%BF.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E7%BB%BF.jpg",
            "https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic1/%E5%A8%83%E5%A8%833.jpg"
        ];
        
        const DIFFICULTIES = {
            simple: { label: 'ç®€å•', xp: 2, color: 'bg-green-400', ring: 'ring-green-200' },
            normal: { label: 'æ™®é€š', xp: 5, color: 'bg-blue-400', ring: 'ring-blue-200' },
            hard: { label: 'å›°éš¾', xp: 10, color: 'bg-orange-400', ring: 'ring-orange-200' },
            hell: { label: 'åœ°ç‹±', xp: 20, color: 'bg-purple-500', ring: 'ring-purple-200' }
        };

        const THEMES = [
            { id: 'nook', name: 'Nook ç»å…¸', bg: '#7FE2C3', primary: '#3DAA86', text: '#59584D', shadow: '#2D8666' },
            { id: 'sakura', name: 'æ¨±èŠ±å­£', bg: '#FFC6D0', primary: '#FF7D9A', text: '#7A4A53', shadow: '#D65D7A' },
            { id: 'summer', name: 'å¤æ—¥è´å£³', bg: '#6AC4F6', primary: '#3490DC', text: '#2C5282', shadow: '#2173B0' },
            { id: 'dodo', name: 'DAL èˆªç©º', bg: '#2C5282', primary: '#ECC94B', text: '#ffffff', shadow: '#D69E2E' },
            { id: 'star', name: 'æµæ˜Ÿé›¨', bg: '#4834d4', primary: '#f9ca24', text: '#ffffff', shadow: '#b38f00' },
            { id: 'mush', name: 'è˜‘è‡å­£', bg: '#eccc68', primary: '#ff6348', text: '#2f3542', shadow: '#e55039' },
            { id: 'brewster', name: 'é¸½å·¢å’–å•¡', bg: '#1e272e', primary: '#27ae60', text: '#d2dae2', shadow: '#1e8045' },
            { id: 'snow', name: 'å†°é›ªå­£', bg: '#c7ecee', primary: '#130f40', text: '#130f40', shadow: '#485460' }
        ];

        const Icon = ({ path, size=24, color="currentColor", className="" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                {path}
            </svg>
        );

        const Icons = {
            Leaf: <><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            CreditCard: <><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></>,
            Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
            Cloud: <><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.1-2.9-5.5-6-5.5a6 6 0 0 0-5.6 8H17.5Z"/><path d="M12 2v8"/><path d="m9 7 3-3 3 3"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Book: <><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            Check: <><path d="M20 6 9 17l-5-5"/></>,
            Coin: <><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></>,
            ArrowLeft: <><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>,
            Activity: <><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></>,
            Scale: <><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M12 6a6 6 0 0 0 0 12 6 6 0 0 0 0-12zm0 2a4 4 0 0 1 0 8 4 4 0 0 1 0-8z"/><path d="M12 10l2 2"/></>,
            Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
            Refresh: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>,
            Danger: <><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            Mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>,
            ChevronLeft: <><polyline points="15 18 9 12 15 6" /></>,
            ChevronRight: <><polyline points="9 18 15 12 9 6" /></>,
            Radio: <><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></>,
            Mail: <><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>,
            Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
			ShoppingBag: <><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
			Dice: <><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></>,
            Bookmark: <><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></>,
			Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
			Megaphone: <><path d="M3 11l8-5v12l-8-5H2v-2h1z"/><path d="M11.6 16.8a5 5 0 1 0 5.8-5.8"/></>,
			Gift: <><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></>,
			Smile: <><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></>,
			Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
			Star: <><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></>,
			Clipboard: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></>,
			Box: <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></>
			        };
        

        const getLevelInfo = (totalXP) => {
            let level = 1;
            let xp = totalXP;
            while (level < 100) {
                const required = level * 256;
                if (xp >= required) { xp -= required; level++; } else { break; }
            }
            return { level, currentXP: xp, requiredXP: level * 256, progress: (xp / (level * 256)) * 100 };
        };

        // æ”¹è¿›çš„è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨åœ°å°† LeanCloud å¯¹è±¡è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
        const simplify = (obj) => {
            if (!obj) return null;
            return { ...obj.toJSON(), id: obj.id };
        };

        // ==========================================
        // 3. æ•°æ®å·¥å‚ (åå¤‡)
        // ==========================================

        const Factories = {
            Stats: () => ({ level: 1, miles: 500, pocket: 3000, savings: 50000, xp: 0 }),
            Passport: () => ({ title1: 'æœªæ¥å¯æœŸçš„', title2: 'å²›æ°‘', islandName: 'Nook å²›', fruit: 'ğŸ', birthday: '', comment: 'è¯·å¤šå…³ç…§ï¼' }),
            FitProfile: () => ({ height: '', weight: '', age: '', gender: 'male' })
        };

        // ==========================================
        // 4. ç»„ä»¶
        // ==========================================

        const AuthScreen = ({ onAuthSuccess }) => {
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [email, setEmail] = useState("");
            const [isRegister, setIsRegister] = useState(false);
            const [loading, setLoading] = useState(false); 
            const [error, setError] = useState("");
            
            const handleSubmit = async () => {
                if (!username || !password) return setError("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");
                setLoading(true);
                setError("");

                try {
                    let user;
                    if (isRegister) {
                        user = new AV.User();
                        user.setUsername(username);
                        user.setPassword(password);
                        if(email) user.setEmail(email);
                        await user.signUp();
                        // åˆå§‹æ•°æ®åˆ›å»ºç°åœ¨ç”± App çš„è‡ªåŠ¨ä¿®å¤é€»è¾‘å¤„ç†ï¼Œä»¥ç¡®ä¿ä¸€è‡´æ€§
                    } else {
                        user = await AV.User.logIn(username, password);
                    }
                    onAuthSuccess(user);
                } catch (err) {
                    console.error(err);
                    setError("é”™è¯¯: " + (err.message || "æœªçŸ¥é”™è¯¯"));
                    setLoading(false);
                }
            };

            return (
                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-[#7FE2C3] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTAgNDBMNDAgMEgyMEwwIDIwTTQwIDQwVjIwTjIwIDQwIiBmaWxsPSIjZmZmZmZmIiBmaWxsLW9wYWNpdHk9IjAuMiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+')] animate-pop">
                    <div className="mb-8 flex flex-col items-center">
                        <div className={`w-24 h-24 bg-white rounded-[30px] flex items-center justify-center shadow-lg mb-4 animate-bounce`}>
                            <Icon path={Icons.Leaf} size={60} color="#3DAA86"/>
                        </div>
                        <h1 className="text-3xl font-black text-[#59584D] tracking-wide">NookPhone </h1>
                        <p className="text-[#3DAA86] font-bold text-sm bg-white/50 px-3 py-1 rounded-full mt-2 backdrop-blur-sm shadow-sm">{isRegister ? "æ–°å±…æ°‘å…¥é©»" : "æ¬¢è¿å›å®¶"}</p>
                    </div>
                    <div className="nook-card w-full max-w-xs shadow-2xl border-[6px] border-white/40 backdrop-blur-sm bg-white/90">
                        {error && <div className="bg-red-100 text-red-500 text-xs font-bold p-3 rounded-xl mb-4 text-center border-l-4 border-red-500 animate-pop">{error}</div>}
                        <div className="space-y-4 mb-4">
                            <div><label className="text-xs font-bold text-gray-500 ml-2 mb-1 block">ç”¨æˆ·å</label><input className="nook-input" type="text" value={username} onChange={e=>setUsername(e.target.value)}/></div>
                            <div><label className="text-xs font-bold text-gray-500 ml-2 mb-1 block">å¯†ç </label><input className="nook-input" type="password" value={password} onChange={e=>setPassword(e.target.value)}/></div>
                            {isRegister && <div className="animate-pop"><label className="text-xs font-bold text-gray-500 ml-2 mb-1 block">é‚®ç®± (å¯é€‰)</label><input className="nook-input" type="email" value={email} onChange={e=>setEmail(e.target.value)}/></div>}
                        </div>
                        <button onClick={handleSubmit} disabled={loading} className="nook-btn w-full mt-2 flex justify-center items-center gap-2">
                            {loading ? "è¿æ¥ä¸­..." : (isRegister ? "æ³¨å†Œå¹¶å…¥é©»" : "ç™»å½•")}
                        </button>
                        <button onClick={() => { setIsRegister(!isRegister); setError(''); }} disabled={loading} className="w-full text-xs font-bold text-gray-400 mt-4 py-2 hover:text-gray-600 transition">
                            {isRegister ? "å·²æœ‰è´¦å·? è¿”å›ç™»å½•" : "æˆ‘æ˜¯æ–°å±…æ°‘? æ³¨å†Œè´¦å·"}
                        </button>
                    </div>
                    <div className="mt-8 text-white/60 font-bold text-xs">NOOK INC. CLOUD SERVICES</div>
                </div>
            );
        };

        const AppIcon = ({ icon, label, onClick }) => (
            <div className="flex flex-col items-center gap-2 cursor-pointer app-icon-container" onClick={onClick}>
                <div className="app-icon"><Icon path={icon} size={30} color="#59584D"/></div>
                <span className="text-xs font-bold bg-white/40 px-2 py-0.5 rounded-full text-[#59584D] shadow-sm backdrop-blur-sm select-none">{label}</span>
            </div>
        );

        const FeedbackToast = ({ message, type = 'success', onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 2500); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="absolute top-14 left-1/2 -translate-x-1/2 z-50 anim-toast pointer-events-none">
                    <div className={`px-5 py-3 rounded-full shadow-xl flex items-center gap-3 border-2 backdrop-blur-md ${type==='success' ? 'bg-white/90 border-[#3DAA86]' : 'bg-white/90 border-red-400'}`}>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center ${type==='success'?'bg-[#3DAA86] text-white':'bg-red-400 text-white'}`}><Icon path={type==='success' ? Icons.Check : Icons.Danger} size={14}/></div>
                        <span className="text-sm font-black text-[#59584D]">{message}</span>
                    </div>
                </div>
            );
        };

        // ==========================================
// ==========================================
        // Wiki App (å¸¦å°å±‹åŒæ­¥åŠŸèƒ½)
        // ==========================================
        const WikiApp = ({ items, add, update, remove, showFeedback, cabin }) => {
            const [view, setView] = useState('list');
            const [search, setSearch] = useState('');
            const [draft, setDraft] = useState({ id: null, title: '', content: '', image: null, cabinId: null });
            const [file, setFile] = useState(null); 
            const [preview, setPreview] = useState(null); 
            const [isUploading, setIsUploading] = useState(false); 
            const fileInputRef = useRef(null);
            
            // [æ–°å¢] å…±äº«çŠ¶æ€
            const [isShared, setIsShared] = useState(false);

            const filteredItems = useMemo(() => {
                if (!search) return items;
                const lowerSearch = search.toLowerCase();
                return items.filter(i => i.title.toLowerCase().includes(lowerSearch) || i.content.toLowerCase().includes(lowerSearch));
            }, [items, search]);

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    if (!selectedFile.type.startsWith('image/')) return alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                    setFile(selectedFile);
                    setPreview(URL.createObjectURL(selectedFile)); 
                }
            };

            const handleRemoveImage = (e) => {
                e && e.stopPropagation();
                setFile(null); setPreview(null);
                setDraft(prev => ({ ...prev, image: null })); 
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleSave = async () => {
                if (!draft.title.trim()) return alert("è¯·è¾“å…¥æ ‡é¢˜");
                setIsUploading(true);
                const cabinIdToSave = (isShared && cabin) ? cabin.id : null;
                try {
                    if (draft.id) { 
                        await update(draft.id, draft.title, draft.content, file, draft.image, cabinIdToSave); 
                    } else { 
                        await add(draft.title, draft.content, file, cabinIdToSave); 
                    }
                    setView('list'); 
                } catch (e) {
                    console.error(e);
                    showFeedback("ä¿å­˜å¤±è´¥", "error");
                } finally {
                    setIsUploading(false);
                }
            };

            const handleDelete = (id) => { if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) { remove(id); setView('list'); } };
            const handleViewDetail = (item) => { setDraft(item); setView('detail'); };
            const handleCreate = () => { setDraft({ id: null, title: '', content: '', image: null }); setPreview(null); setFile(null); setIsShared(false); setView('edit'); };
            const handleEditFromDetail = () => { setPreview(draft.image || null); setFile(null); setIsShared(!!draft.cabinId); setView('edit'); };

            useEffect(() => { return () => { if (file && preview) URL.revokeObjectURL(preview); }; }, [file, preview]);

            if (view === 'detail') return (<div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative"><div className="flex items-center justify-between mb-4 shrink-0"><button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">æŸ¥çœ‹è¯¦æƒ…</h2><button onClick={()=>handleDelete(draft.id)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><Icon path={Icons.Trash} size={20}/></button></div><div className="flex-1 overflow-y-auto no-scrollbar pb-20 animate-pop">{draft.image && (<div className="w-full rounded-2xl overflow-hidden shadow-sm mb-6 border-4 border-white bg-gray-100 relative group"><img src={draft.image} alt="detail" className="w-full h-auto object-contain max-h-[400px]" onClick={() => window.open(draft.image, '_blank')} /><div className="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-full backdrop-blur-md pointer-events-none">ç‚¹å‡»æŸ¥çœ‹åŸå›¾</div></div>)}<div className="px-2"><h1 className="text-2xl font-black text-[#59584D] mb-2 leading-tight flex items-center gap-2">{draft.title} {draft.cabinId && <Icon path={Icons.Home} size={16} className="text-[#E67E22]"/>}</h1><div className="text-xs font-bold text-gray-300 mb-6 flex items-center gap-2"><Icon path={Icons.Leaf} size={12}/>{new Date(draft.updatedTimestamp || draft.timestamp || Date.now()).toLocaleString()}</div><div className="text-sm font-medium text-[#59584D] leading-7 whitespace-pre-wrap select-text">{draft.content || "ï¼ˆæ²¡æœ‰å¡«å†™å†…å®¹ï¼‰"}</div></div></div><div className="absolute bottom-6 left-0 right-0 flex justify-center z-30"><button onClick={handleEditFromDetail} className="bg-[#667EEA] text-white px-8 py-3 rounded-full shadow-xl hover:bg-[#5A67D8] transition active:scale-95 flex items-center gap-2 font-bold animate-pop"><Icon path={Icons.Edit} size={18}/> ç¼–è¾‘å†…å®¹</button></div></div>);
            if (view === 'edit') return (<div className="flex flex-col flex-1 min-h-0 screen-enter h-full"><div className="flex items-center justify-between mb-4 shrink-0"><button onClick={()=>setView(draft.id ? 'detail' : 'list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">{draft.id ? 'ç¼–è¾‘è®°å½•' : 'æ–°è®°å½•'}</h2><div className="w-10"></div></div><div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4"><div className="nook-card p-4"><label className="text-xs font-bold text-gray-400 mb-1 block">æ ‡é¢˜</label><input value={draft.title} onChange={e=>setDraft({...draft, title: e.target.value})} className="w-full text-lg font-bold bg-transparent outline-none border-b-2 border-gray-100 py-2 placeholder-gray-300" placeholder="è¾“å…¥æ ‡é¢˜..."/></div><div className="nook-card p-4"><label className="text-xs font-bold text-gray-400 mb-2 block">é…å›¾ (å¯é€‰)</label><input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" hidden />{preview ? (<div className="relative rounded-2xl overflow-hidden border-2 border-gray-100 animate-pop group"><img src={preview} alt="preview" className="w-full max-h-[200px] object-cover bg-gray-50" /><button onClick={handleRemoveImage} className="absolute top-3 right-3 bg-black/40 text-white p-2 rounded-full backdrop-blur-md hover:bg-red-500 transition-all shadow-sm"><Icon path={Icons.Trash} size={18}/></button></div>) : (<button onClick={() => fileInputRef.current.click()} className="w-full h-32 border-3 border-dashed border-gray-200 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:border-[#667EEA] hover:text-[#667EEA] hover:bg-[#667EEA]/5 transition-all gap-2"><Icon path={Icons.Plus} size={24}/><span className="text-xs font-bold">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span></button>)}</div>{cabin && (<div className="nook-card border-l-8 border-[#FF9F43] flex items-center justify-between p-4"><div><div className="font-bold text-[#59584D] text-sm">åŒæ­¥åˆ°å°å±‹</div></div><label className="nook-switch scale-75"><input type="checkbox" checked={isShared} onChange={e=>setIsShared(e.target.checked)}/><span className="slider bg-gray-200"></span></label></div>)}<div className="nook-card p-4 flex-1 flex flex-col min-h-[150px]"><label className="text-xs font-bold text-gray-400 mb-2 block">å†…å®¹</label><textarea value={draft.content} onChange={e=>setDraft({...draft, content: e.target.value})} className="w-full flex-1 bg-transparent outline-none resize-none text-sm font-medium leading-relaxed text-[#59584D] min-h-[100px] placeholder-gray-300" placeholder="è®°å½•ä¸€ç‚¹æƒ³æ³•..."/></div><button onClick={handleSave} disabled={isUploading} className={`nook-btn w-full mt-2 bg-[#667EEA] shadow-[0_5px_0_#5A67D8] flex items-center justify-center gap-2 ${isUploading ? 'opacity-70 cursor-wait' : ''}`}>{isUploading ? (<><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div><span>ä¿å­˜ä¸­...</span></>) : "ä¿å­˜"}</button></div></div>);

            return (<div className="flex flex-col flex-1 min-h-0 screen-enter relative h-full"><div className="flex items-center justify-between mb-4 shrink-0"><div className="flex items-center gap-2"><div className="w-10 h-10 bg-[#667EEA] rounded-full flex items-center justify-center text-white shadow-sm"><Icon path={Icons.Bookmark} /></div><h2 className="text-xl font-black opacity-80">Nookå°çŸ¥è¯†</h2></div></div><div className="bg-white/60 p-2 rounded-2xl mb-4 flex items-center gap-2 backdrop-blur-sm shadow-inner shrink-0"><Icon path={Icons.Search} size={18} className="text-gray-400 ml-2"/><input value={search} onChange={e=>setSearch(e.target.value)} className="bg-transparent w-full outline-none text-sm font-bold text-[#59584D] placeholder-gray-300" placeholder="æœç´¢çŸ¥è¯†..."/></div><button onClick={handleCreate} className="absolute bottom-6 right-2 bg-[#667EEA] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#5A67D8] transition active:scale-95 flex items-center gap-2 z-30 font-bold animate-pop"><Icon path={Icons.Plus} size={18}/> è®°ä¸€æ¡</button><div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-24">{filteredItems.length === 0 && <div className="text-center text-gray-400 py-10 text-xs font-bold opacity-50 flex flex-col items-center gap-2"><div className="text-4xl grayscale opacity-50">ğŸ“–</div>æš‚æ— è®°å½•</div>}{filteredItems.map((item, i) => (<div key={item.id} onClick={()=>handleViewDetail(item)} className="bg-white rounded-2xl p-4 border-l-8 border-[#667EEA] shadow-sm cursor-pointer hover:bg-indigo-50/50 transition-all animate-pop group flex gap-4 relative overflow-hidden" style={{animationDelay: `${i*50}ms`}}><div className="flex-1 min-w-0 z-10"><div className="flex justify-between items-start mb-2"><h3 className="font-bold text-[#59584D] truncate text-base flex items-center gap-1">{item.title} {item.cabinId && <Icon path={Icons.Home} size={12} className="text-[#E67E22]"/>}</h3></div><p className="text-xs text-gray-500 line-clamp-2 font-medium leading-relaxed">{item.content}</p><div className="text-[10px] text-gray-300 font-bold mt-2">{new Date(item.updatedTimestamp || item.timestamp).toLocaleDateString()}</div></div>{item.image && (<div className="w-20 h-20 rounded-xl bg-gray-200 overflow-hidden shrink-0 border-2 border-white shadow-sm relative z-10 group-hover:scale-105 transition-transform"><img src={item.image} alt="thumb" className="w-full h-full object-cover" loading="lazy" /></div>)}<Icon path={Icons.Bookmark} size={80} className="absolute -right-4 -bottom-6 text-[#667EEA] opacity-5 z-0 pointer-events-none transform -rotate-12 group-hover:rotate-0 transition-all"/></div>))}</div></div>);
        };

        const FitnessApp = ({ profile, logs, updateProfile, addLog, user, showFeedback }) => {
            const [view, setView] = useState('dashboard');
            const [pHeight, setPHeight] = useState(profile?.height || '');
            const [pWeight, setPWeight] = useState(profile?.weight || '');
            const [pAge, setPAge] = useState(profile?.age || '');
            const [pGender, setPGender] = useState(profile?.gender || 'male');
            const [logType, setLogType] = useState('exercise'); const [logValue, setLogValue] = useState(''); const [timeView, setTimeView] = useState('day'); 
            const aggregatedData = useMemo(() => {
                const now = new Date(); const numDays = timeView === 'week' ? 7 : (timeView === 'month' ? 30 : 1);
                let totalExercise = 0, totalIntake = 0, weightSum = 0, weightCount = 0;
                const relevantLogs = logs.filter(l => { const diffTime = Math.abs(now.getTime() - l.timestamp); return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) <= numDays; });
                relevantLogs.forEach(l => { if (l.type === 'exercise') totalExercise += Number(l.val); if (l.type === 'intake') totalIntake += Number(l.val); if (l.type === 'weight') { weightSum += Number(l.val); weightCount++; } });
                const history = relevantLogs.sort((a,b) => b.timestamp - a.timestamp);
                const displayWeight = weightCount > 0 && timeView !== 'day' ? (weightSum / weightCount).toFixed(1) : (profile?.weight || 0);
                return { totalExercise, totalIntake, displayWeight, history };
            }, [logs, timeView, profile]);
            const bmr = useMemo(() => { if (!profile?.weight || !profile?.height || !profile?.age) return 0; let val = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age); return profile.gender === 'male' ? val + 5 : val - 161; }, [profile]);
            const periodBmr = bmr * (timeView === 'week' ? 7 : (timeView === 'month' ? 30 : 1));
            const bmi = (profile?.weight && profile?.height) ? (profile.weight / Math.pow(profile.height/100, 2)).toFixed(1) : 0;
            const handleSaveProfile = () => { updateProfile({ height: parseFloat(pHeight), weight: parseFloat(pWeight), age: parseInt(pAge), gender: pGender }); setView('dashboard'); showFeedback("æ¡£æ¡ˆå·²ä¿å­˜ï¼"); };
            const handleSaveLog = () => { if (!logValue) return alert("è¯·è¾“å…¥æ•°å€¼"); addLog(logType, parseFloat(logValue), logType === 'exercise' ? 'æ‰‹åŠ¨è®°å½•' : (logType==='weight'?'ä½“é‡è®°å½•':'é¥®é£Ÿè®°å½•')); setLogValue(''); setView('dashboard'); showFeedback("è®°å½•å·²ä¿å­˜ï¼", "success"); };
            if (view === 'setup' || !profile?.height) return (<div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative"><div className="flex-1 overflow-y-auto no-scrollbar flex flex-col justify-center pb-8 p-1"><div className="text-center mb-6"><h2 className="text-xl font-black text-[#59584D]">NookFit æ¡£æ¡ˆ</h2></div><div className="nook-card space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-400 ml-2 block mb-1">èº«é«˜(cm)</label><input type="number" value={pHeight} onChange={e=>setPHeight(e.target.value)} className="nook-input text-center"/></div><div><label className="text-xs font-bold text-gray-400 ml-2 block mb-1">ä½“é‡(kg)</label><input type="number" value={pWeight} onChange={e=>setPWeight(e.target.value)} className="nook-input text-center"/></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-400 ml-2 block mb-1">å¹´é¾„</label><input type="number" value={pAge} onChange={e=>setPAge(e.target.value)} className="nook-input text-center"/></div><div><label className="text-xs font-bold text-gray-400 ml-2 block mb-1">æ€§åˆ«</label><div className="flex bg-gray-100 p-1 rounded-xl h-[50px] items-center"><button onClick={()=>setPGender('male')} className={`flex-1 h-full rounded-lg font-bold text-xs ${pGender==='male'?'bg-white text-blue-500 shadow-sm':'text-gray-400'}`}>ç”·</button><button onClick={()=>setPGender('female')} className={`flex-1 h-full rounded-lg font-bold text-xs ${pGender==='female'?'bg-white text-pink-500 shadow-sm':'text-gray-400'}`}>å¥³</button></div></div></div><button onClick={handleSaveProfile} className="nook-btn w-full bg-[#4299E1]">ä¿å­˜æ¡£æ¡ˆ</button></div></div></div>);
            if (view === 'log') return (<div className="flex flex-col flex-1 min-h-0 screen-enter h-full"><div className="flex items-center gap-2 mb-4 shrink-0"><button onClick={()=>setView('dashboard')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">è®°å½•æ•°æ®</h2></div><div className="nook-card space-y-6 animate-pop"><div className="flex bg-gray-100 p-1 rounded-xl">{['exercise','intake','weight'].map(t => (<button key={t} onClick={()=>setLogType(t)} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${logType===t ? 'bg-white shadow-sm scale-95 ' + (t==='exercise'?'text-orange-500':(t==='intake'?'text-green-500':'text-blue-500')) : 'text-gray-400'}`}>{t==='exercise'?'è¿åŠ¨':(t==='intake'?'é¥®é£Ÿ':'ä½“é‡')}</button>))}</div><div className="text-center"><input type="number" autoFocus value={logValue} onChange={e=>setLogValue(e.target.value)} className="w-full text-center text-5xl font-black bg-transparent outline-none border-b-2 border-gray-200 focus:border-[#4299E1] pb-2" placeholder="0"/></div><button onClick={handleSaveLog} className="nook-btn w-full bg-[#4299E1]">ç¡®è®¤è®°å½•</button></div></div>);
            return (<div className="flex flex-col flex-1 min-h-0 screen-enter relative h-full"><div className="flex items-center justify-between mb-4 shrink-0"><div className="flex items-center gap-2"><div className="w-10 h-10 bg-[#4299E1] rounded-full flex items-center justify-center text-white"><Icon path={Icons.Activity} /></div><h2 className="text-xl font-black opacity-80">NookFit</h2></div><button onClick={()=>{ setPHeight(profile.height); setPWeight(profile.weight); setPAge(profile.age); setPGender(profile.gender); setView('setup');}} className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:bg-white"><Icon path={Icons.Settings} size={16}/></button></div><div className="flex bg-white/50 p-1 rounded-xl mb-4 backdrop-blur-sm shrink-0">{['day','week','month'].map(t => (<button key={t} onClick={()=>setTimeView(t)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView===t?'bg-white text-[#4299E1] shadow-sm scale-95':'text-gray-500'}`}>{t==='day'?'ä»Šæ—¥':(t==='week'?'æœ¬å‘¨':'æœ¬æœˆ')}</button>))}</div><div className="bg-[#2D3748] rounded-[24px] p-5 text-white shadow-lg mb-4 flex justify-between items-center relative overflow-hidden shrink-0 transition-transform hover:scale-[1.02]"><div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-8 -mt-8"></div><div className="grid grid-cols-2 gap-4 relative z-10"><div><div className="text-[10px] font-bold opacity-50 mb-1">{timeView==='day'?'WEIGHT':'AVG WEIGHT'}</div><div className="text-2xl font-black">{aggregatedData.displayWeight} <span className="text-sm font-bold opacity-50">kg</span></div></div><div><div className="text-[10px] font-bold opacity-50 mb-1">BMI</div><div className="text-2xl font-black text-[#63B3ED]">{bmi}</div></div><div className="col-span-2 pt-3 border-t border-white/10"><div className="flex justify-between items-end mb-1"><div className="text-[10px] font-bold opacity-50">NET BURN</div><div className="text-2xl font-black text-[#F6AD55]">{(periodBmr + aggregatedData.totalExercise - aggregatedData.totalIntake).toFixed(0)} <span className="text-xs">kcal</span></div></div><div className="flex justify-between text-[10px] font-bold opacity-60"><span>åŸºç¡€: {periodBmr.toFixed(0)}</span><span>è¿åŠ¨: {aggregatedData.totalExercise}</span><span>æ‘„å…¥: {aggregatedData.totalIntake}</span></div></div></div></div><button onClick={()=>setView('log')} className="absolute bottom-6 right-2 bg-[#4299E1] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#3182CE] transition active:scale-95 flex items-center gap-2 z-30 font-bold animate-pop"><Icon path={Icons.Plus} size={18}/> è®°ä¸€ç¬”</button><div className="flex-1 overflow-y-auto no-scrollbar pb-24"><div className="space-y-2">{aggregatedData.history.map((rec, i) => (<div key={rec.id} className="bg-white rounded-xl p-3 flex justify-between items-center shadow-sm animate-pop" style={{animationDelay: `${i*50}ms`}}><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${rec.type==='exercise'?'bg-orange-100 text-orange-500': (rec.type==='intake' ? 'bg-green-100 text-green-500' : 'bg-blue-100 text-blue-500')}`}><Icon path={rec.type==='exercise'?Icons.Activity: (rec.type==='intake'?Icons.Utensils:Icons.Scale)} size={16}/></div><div><div className="text-xs font-bold text-[#59584D]">{rec.note}</div><div className="text-[10px] text-gray-400 font-bold">{rec.date} {rec.time}</div></div></div><div className={`text-sm font-black ${rec.type==='exercise'?'text-orange-500':(rec.type==='intake'?'text-green-500':'text-blue-500')}`}>{rec.type==='weight' ? rec.val+'kg' : (rec.type==='exercise'?'-':'+')+rec.val}</div></div>))}</div></div></div>);
        };

        const FinanceApp = ({ stats, updateStats, showFeedback }) => {
            // mode: 'menu' (ä¸»èœå•), 'transfer' (å­˜å–æ¬¾), 'repay' (è¿˜è´·), 'manage' (åå°ä¿®æ”¹)
            const [mode, setMode] = useState('menu'); 
            const [amount, setAmount] = useState('');
            
            // è¿˜æ¬¾æ—¶çš„æ”¯ä»˜æ–¹å¼: 'pocket' (é’±åŒ…) | 'savings' (å­˜æ¬¾)
            const [paySource, setPaySource] = useState('savings'); 
        
            // ç®¡ç†æ¨¡å¼çš„æ•°æ®
            const [editPocket, setEditPocket] = useState(stats?.pocket || 0);
            const [editSavings, setEditSavings] = useState(stats?.savings || 0);
            const [editLoan, setEditLoan] = useState(stats?.loan || 0);
        
            useEffect(() => { 
                if (stats) { 
                    setEditPocket(stats.pocket || 0); 
                    setEditSavings(stats.savings || 0); 
                    setEditLoan(stats.loan || 0);
                } 
            }, [stats]);
        
            // å­˜å–æ¬¾é€»è¾‘
            const handleTrans = (type) => {
                const val = parseInt(amount); 
                if (!val || val <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
                
                if (type === 'deposit') { 
                    if (stats.pocket < val) return alert("å£è¢‹é‡Œé“ƒé’±ä¸è¶³ï¼"); 
                    updateStats({ pocket: stats.pocket - val, savings: stats.savings + val }); 
                    showFeedback("å­˜å…¥æˆåŠŸï¼"); 
                } else { 
                    if (stats.savings < val) return alert("ABD ä½™é¢ä¸è¶³ï¼"); 
                    updateStats({ pocket: stats.pocket + val, savings: stats.savings - val }); 
                    showFeedback("å–å‡ºæˆåŠŸï¼"); 
                }
                setAmount('');
            };
        
            // [æ–°å¢] è¿˜æ¬¾é€»è¾‘
            const handleRepay = () => {
                const val = parseInt(amount);
                const currentLoan = stats.loan || 0;
                
                if (!val || val <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
                if (currentLoan <= 0) return alert("æ‚¨å·²ç»è¿˜æ¸…æ‰€æœ‰è´·æ¬¾äº†ï¼æ— éœ€è¿˜æ¬¾ã€‚");
                if (val > currentLoan) return alert(`æ‚¨åªéœ€è¦è¿˜ ${currentLoan.toLocaleString()} é“ƒé’±å³å¯ã€‚`);
        
                // æ£€æŸ¥ä½™é¢
                const sourceBalance = paySource === 'pocket' ? (stats.pocket || 0) : (stats.savings || 0);
                if (sourceBalance < val) return alert(`${paySource === 'pocket' ? 'å£è¢‹' : 'å­˜æ¬¾'}ä½™é¢ä¸è¶³ï¼`);
        
                // è®¡ç®—æ–°çŠ¶æ€
                const updates = { loan: currentLoan - val };
                if (paySource === 'pocket') {
                    updates.pocket = stats.pocket - val;
                } else {
                    updates.savings = stats.savings - val;
                }
        
                updateStats(updates);
                
                if (currentLoan - val <= 0) {
                    showFeedback("æ­å–œï¼æˆ¿è´·å·²å…¨éƒ¨è¿˜æ¸…ï¼ğŸ‰", "success");
                } else {
                    showFeedback("è¿˜æ¬¾æˆåŠŸï¼ç‹¸å…‹å¾ˆæ¬£æ…°ã€‚");
                }
                setAmount('');
            };
        
            // ç®¡ç†æ¨¡å¼ä¿å­˜
            const handleSaveManagement = () => {
                const p = parseInt(editPocket); 
                const s = parseInt(editSavings);
                const l = parseInt(editLoan);
                if (isNaN(p) || isNaN(s) || isNaN(l) || p < 0 || s < 0 || l < 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼"); 
                
                updateStats({ pocket: p, savings: s, loan: l }); 
                setMode('menu'); 
                showFeedback("è´¦æˆ·åŠè´·æ¬¾å·²æ›´æ–°");
            };
        
            // æ ¼å¼åŒ–æ•°å­—
            const f = (n) => (n || 0).toLocaleString();
        
            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter text-[#59584D] h-full relative">
                    {/* é¡¶éƒ¨å¯¼èˆª */}
                    <div className="flex items-center justify-between mb-4 shrink-0">
                        <div className="flex items-center gap-2">
                            {mode !== 'menu' && (
                                <button onClick={() => {setMode('menu'); setAmount('');}} className="p-1 -ml-1 rounded-full hover:bg-gray-200 transition">
                                    <Icon path={Icons.ArrowLeft} size={24}/>
                                </button>
                            )}
                            <div className="w-10 h-10 bg-[#ECC94B] rounded-full flex items-center justify-center text-white shadow-sm">
                                <Icon path={Icons.CreditCard} />
                            </div>
                            <h2 className="text-xl font-black opacity-80">
                                {mode === 'manage' ? 'åå°ç®¡ç†' : (mode === 'repay' ? 'è´·æ¬¾å¿è¿˜' : 'ABD ç»ˆç«¯')}
                            </h2>
                        </div>
                        <button onClick={() => setMode(mode === 'manage' ? 'menu' : 'manage')} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${mode==='manage' ? 'bg-[#3DAA86] text-white shadow-md' : 'bg-gray-200 text-gray-500 hover:bg-white'}`}>
                            <Icon path={Icons.Settings} size={16} />
                        </button>
                    </div>
        
                    {/* æ ¸å¿ƒèµ„äº§å±•ç¤ºå¡ç‰‡ (å§‹ç»ˆæ˜¾ç¤º) */}
                    <div className="bg-[#E2E8F0] p-4 rounded-[24px] shadow-inner border-[6px] border-[#CBD5E0] mb-4 shrink-0 relative overflow-hidden">
                        {/* å­˜æ¬¾æ˜¾ç¤º */}
                        <div className="bg-[#2D3748] rounded-xl p-3 mb-3 text-[#48BB78] font-mono text-right shadow-inner border-4 border-[#1A202C] relative z-10">
                            <div className="text-[10px] opacity-50 mb-1 font-bold">ABD SAVINGS</div>
                            <div className="text-2xl font-bold tracking-widest">{f(stats?.savings)}</div>
                        </div>
                        
                        <div className="flex justify-between items-end relative z-10">
                            {/* é’±åŒ…æ˜¾ç¤º */}
                            <div className="text-center bg-white/50 p-2 rounded-xl backdrop-blur-sm">
                                <div className="text-[10px] font-bold text-gray-500 mb-1">POCKET</div>
                                <div className="text-lg font-black text-[#D69E2E]">{f(stats?.pocket)}</div>
                            </div>
                            {/* è´·æ¬¾æ˜¾ç¤º [æ–°å¢] */}
                            <div className={`text-center p-2 rounded-xl backdrop-blur-sm border-2 ${(stats?.loan||0) > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                <div className="text-[10px] font-bold text-gray-500 mb-1">LOAN</div>
                                <div className={`text-lg font-black ${(stats?.loan||0) > 0 ? 'text-red-500' : 'text-[#3DAA86]'}`}>
                                    {(stats?.loan||0) > 0 ? `-${f(stats?.loan)}` : 'PAID'}
                                </div>
                            </div>
                        </div>
                    </div>
        
                    {/* åŠŸèƒ½åŒºï¼šæ ¹æ® Mode åˆ‡æ¢ */}
                    <div className="flex-1 overflow-y-auto no-scrollbar pb-6">
                        
                        {/* 1. ä¸»èœå•æ¨¡å¼ */}
                        {mode === 'menu' && (
                            <div className="grid grid-cols-1 gap-3 animate-pop">
                                <button onClick={() => setMode('transfer')} className="nook-card flex items-center justify-between p-5 hover:scale-[1.02] active:scale-95 transition-transform group">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><Icon path={Icons.Refresh} /></div>
                                        <div className="text-left">
                                            <div className="font-black text-[#59584D]">å­˜å–æ¬¾</div>
                                            <div className="text-xs text-gray-400 font-bold">Deposit / Withdraw</div>
                                        </div>
                                    </div>
                                    <Icon path={Icons.ChevronRight} className="text-gray-300" />
                                </button>
        
                                <button onClick={() => setMode('repay')} className="nook-card flex items-center justify-between p-5 hover:scale-[1.02] active:scale-95 transition-transform group border-l-8 border-red-400">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center"><Icon path={Icons.Book} /></div>
                                        <div className="text-left">
                                            <div className="font-black text-[#59584D]">å¿è¿˜è´·æ¬¾</div>
                                            <div className="text-xs text-gray-400 font-bold">Loan Repayment</div>
                                        </div>
                                    </div>
                                    {(stats?.loan || 0) > 0 && (
                                        <div className="bg-red-500 text-white text-[10px] font-black px-2 py-1 rounded-full animate-pulse">å¾…è¿˜</div>
                                    )}
                                </button>
                            </div>
                        )}
        
                        {/* 2. å­˜å–æ¬¾æ¨¡å¼ */}
                        {mode === 'transfer' && (
                            <div className="nook-card flex flex-col justify-center gap-4 animate-pop min-h-full">
                                <div className="text-center font-bold mb-2 text-sm opacity-80">Nook è‡ªåŠ¨å­˜å–æ¬¾æœº</div>
                                <div className="relative">
                                    <input type="number" placeholder="è¾“å…¥é‡‘é¢" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full bg-[#F0F0F0] p-4 rounded-2xl text-center text-2xl font-black outline-none border-b-4 border-transparent focus:border-[#3DAA86] transition-colors placeholder-gray-300"/>
                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400">BELLS</div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mt-2">
                                    <button onClick={()=>handleTrans('deposit')} className="nook-btn bg-[#48BB78] text-white py-4 shadow-[0_6px_0_#2F855A] active:shadow-none active:top-1.5 transition-all">å­˜å…¥</button>
                                    <button onClick={()=>handleTrans('withdraw')} className="nook-btn bg-[#E53E3E] text-white py-4 shadow-[0_6px_0_#9B2C2C] active:shadow-none active:top-1.5 transition-all">å–å‡º</button>
                                </div>
                            </div>
                        )}
        
                        {/* 3. è¿˜æ¬¾æ¨¡å¼ [æ ¸å¿ƒä¿®æ”¹] */}
                        {mode === 'repay' && (
                            <div className="nook-card flex flex-col justify-between gap-4 animate-pop border-l-8 border-red-400 min-h-full">
                                <div>
                                    <div className="text-center font-bold mb-4 text-sm opacity-80 flex flex-col">
                                        <span>å½“å‰å‰©ä½™è´·æ¬¾</span>
                                        <span className="text-3xl font-black text-red-500 mt-1">{f(stats?.loan)}</span>
                                    </div>
                                    
                                    <label className="text-xs font-bold text-gray-400 mb-2 block ml-1">è¿˜æ¬¾é‡‘é¢</label>
                                    <div className="relative mb-4">
                                        <input type="number" placeholder="0" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full bg-[#FFF5F5] p-4 rounded-2xl text-center text-2xl font-black outline-none border-2 border-transparent focus:border-red-300 text-red-500 transition-colors placeholder-gray-300"/>
                                        <button onClick={()=>setAmount(stats.loan)} className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] font-bold bg-red-100 text-red-500 px-2 py-1 rounded hover:bg-red-200">å…¨éƒ¨</button>
                                    </div>
        
                                    <label className="text-xs font-bold text-gray-400 mb-2 block ml-1">æ”¯ä»˜æ¥æº</label>
                                    <div className="flex bg-gray-100 p-1 rounded-xl mb-4">
                                        <button onClick={()=>setPaySource('savings')} className={`flex-1 py-3 rounded-lg font-bold text-xs transition-all flex flex-col items-center gap-1 ${paySource==='savings'?'bg-white text-[#48BB78] shadow-sm scale-95 ring-2 ring-[#48BB78]/20':'text-gray-400'}`}>
                                            <span>ABD å­˜æ¬¾</span>
                                            <span className="text-[10px] opacity-60">ä½™é¢: {f(stats.savings)}</span>
                                        </button>
                                        <button onClick={()=>setPaySource('pocket')} className={`flex-1 py-3 rounded-lg font-bold text-xs transition-all flex flex-col items-center gap-1 ${paySource==='pocket'?'bg-white text-[#D69E2E] shadow-sm scale-95 ring-2 ring-[#D69E2E]/20':'text-gray-400'}`}>
                                            <span>å£è¢‹é’±åŒ…</span>
                                            <span className="text-[10px] opacity-60">ä½™é¢: {f(stats.pocket)}</span>
                                        </button>
                                    </div>
                                </div>
        
                                <button onClick={handleRepay} disabled={(stats?.loan||0) <= 0} className="nook-btn w-full bg-[#2D3748] shadow-[0_6px_0_#1A202C]">
                                    {(stats?.loan||0) > 0 ? 'ç¡®è®¤å¿è¿˜' : 'è´·æ¬¾å·²è¿˜æ¸…'}
                                </button>
                            </div>
                        )}
        
                        {/* 4. ç®¡ç†æ¨¡å¼ (åŒ…å«ä¿®æ”¹ Loan) */}
                        {mode === 'manage' && (
                            <div className="nook-card flex flex-col gap-4 animate-pop border-l-8 border-[#3DAA86] min-h-full">
                                <div className="text-center font-bold mb-2 text-sm opacity-80 flex items-center justify-center gap-2">è´¦æˆ·èµ„é‡‘ä¿®æ­£</div>
                                <div>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 ml-2">POCKET (é’±åŒ…)</label>
                                    <input type="number" value={editPocket} onChange={e=>setEditPocket(e.target.value)} className="w-full bg-[#FFFBEB] p-3 rounded-xl text-center text-xl font-bold outline-none text-[#D69E2E]"/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 ml-2">ABD (å­˜æ¬¾)</label>
                                    <input type="number" value={editSavings} onChange={e=>setEditSavings(e.target.value)} className="w-full bg-[#F0FFF4] p-3 rounded-xl text-center text-xl font-bold outline-none text-[#48BB78]"/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-400 block mb-1 ml-2">LOAN (æˆ¿è´·)</label>
                                    <input type="number" value={editLoan} onChange={e=>setEditLoan(e.target.value)} className="w-full bg-[#FFF5F5] p-3 rounded-xl text-center text-xl font-bold outline-none text-red-500 border-2 border-red-100"/>
                                    <p className="text-[10px] text-gray-400 mt-1 ml-2">* è®¾ç½®åˆå§‹æˆ¿è´·æˆ–è¿›è¡Œè°ƒæ•´</p>
                                </div>
                                <button onClick={handleSaveManagement} className="nook-btn mt-auto w-full">ä¿å­˜ä¿®æ”¹</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
// ==========================================
        // Nook Shopping ç»„ä»¶ (SVG + å¤šäººè¿›åº¦)
        // ==========================================
        // ... (TimmyIcon å’Œ TommyIcon ç»„ä»¶ä¿æŒä¸å˜ï¼Œç›´æ¥å¤åˆ¶ä¸Šé¢çš„ SVG ä»£ç å³å¯ï¼Œè¿™é‡Œçœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œè¯·åŠ¡å¿…åŒ…å«) ...
     
        // Nook Shopping ç»„ä»¶ (è¾“å…¥æ¡†ç½®é¡¶ç‰ˆ)
        // ==========================================
        
        // è±†ç‹¸ (Timmy) ç»„ä»¶
        // ç§»é™¤åŸæœ‰çš„ TimmyIcon å’Œ TommyIcon SVG å®šä¹‰ã€‚
        // ä½¿ç”¨ä¸€ä¸ªå ä½å‡½æ•°ï¼Œä»¥é˜²å…¶ä»–åœ°æ–¹ä»æœ‰å¼•ç”¨ SVG çš„é€»è¾‘æ®‹ç•™ã€‚
        const TimmyTommyDecoration = () => null; 
        
        // Nook Shopping ç»„ä»¶ (è¾“å…¥æ¡†ç½®é¡¶ç‰ˆ)
        // ==========================================
                
        const ShoppingApp = ({ items, addItem, toggleItem, deleteItem, showFeedback, cabin, memberCount }) => {
            const [tab, setTab] = useState('daily'); 
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [isShared, setIsShared] = useState(false);
        
            const filtered = items.filter(i => i.type === tab);
            const totalWish = items.filter(i => i.type === 'wish' && !i.checked).reduce((acc, cur) => acc + (cur.price || 0), 0);
        
            const handleAdd = () => {
                if (!name.trim()) return;
                const cabinIdToSave = (isShared && cabin) ? cabin.id : null;
                addItem(name, price, tab, cabinIdToSave);
                setName(''); setPrice(''); setIsShared(false);
                showFeedback(tab === 'daily' ? "å·²åŠ å…¥è¡¥è´§æ¸…å•" : "å·²åŠ å…¥å¿ƒæ„¿å•");
            };
        
            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
                    {/* é¡¶éƒ¨æ ‡é¢˜ */}
                    <div className="flex items-center justify-between mb-4 shrink-0">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-[#F6E05E] rounded-full flex items-center justify-center text-white shadow-md border-2 border-white"><Icon path={Icons.ShoppingBag} size={20} className="text-[#975A16]" /></div>
                            <h2 className="text-xl font-black opacity-80">Nook è´­ç‰©</h2>
                        </div>
                    </div>
                    
                    {/* é€‰é¡¹å¡ */}
                    <div className="flex bg-white/50 p-1 rounded-xl mb-4 shrink-0 backdrop-blur-sm">
                        <button onClick={() => setTab('daily')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2 ${tab === 'daily' ? 'bg-white text-[#D69E2E] shadow-sm' : 'text-gray-500'}`}><span>ğŸ¥•</span> æ—¥å¸¸è¡¥è´§</button>
                        <button onClick={() => setTab('wish')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-2 ${tab === 'wish' ? 'bg-white text-purple-500 shadow-sm' : 'text-gray-500'}`}><span>ğŸ</span> å¿ƒæ„¿æ¸…å•</button>
                    </div>
                    
                    {/* å¿ƒæ„¿å•ç»Ÿè®¡ */}
                    {tab === 'wish' && (<div className="nook-card bg-gradient-to-r from-purple-50 to-white border-l-8 border-purple-300 mb-4 py-3 px-4 flex justify-between items-center animate-pop shrink-0"><div className="text-xs font-bold text-purple-400">æ‰€éœ€é“ƒé’±æ€»é¢</div><div className="text-xl font-black text-purple-600 flex items-center gap-1"><Icon path={Icons.Coin} size={16}/> {totalWish.toLocaleString()}</div></div>)}
                    
                    {/* [ä¿®æ”¹] è¾“å…¥åŒºåŸŸ - ç§»åˆ°äº†åˆ—è¡¨ä¸Šæ–¹ */}
                    <div className="flex gap-2 shrink-0 items-center bg-white/60 p-2 rounded-2xl shadow-sm backdrop-blur-md mb-4 animate-pop">
                        {cabin && (
                            <button onClick={()=>setIsShared(!isShared)} className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${isShared?'bg-[#FF9F43] text-white':'bg-white text-gray-300'}`}>
                                <Icon path={Icons.Home} size={18}/>
                            </button>
                        )}
                        <input value={name} onChange={e => setName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAdd()} className="flex-[2] bg-transparent outline-none font-bold text-[#59584D] px-2 text-sm placeholder-gray-400" placeholder={tab === 'daily' ? "ç‰›å¥¶, é¸¡è›‹..." : "Switch, é”®ç›˜..."} />
                        {tab === 'wish' && (<><div className="w-px h-6 bg-gray-300"></div><input type="number" value={price} onChange={e => setPrice(e.target.value)} className="flex-1 bg-transparent outline-none font-bold text-[#59584D] px-2 text-sm text-center w-20 placeholder-gray-400" placeholder="ä»·æ ¼"/></>)}
                        <button onClick={handleAdd} className="bg-[#F6E05E] text-[#975A16] rounded-xl w-10 h-10 flex items-center justify-center font-black shadow-sm active:scale-90 transition-transform hover:bg-[#FAF089]"><Icon path={Icons.Plus} size={20}/></button>
                    </div>
        
                    {/* åˆ—è¡¨åŒºåŸŸ - ç§»é™¤åº•éƒ¨è¶…å¤§ padding */}
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-2 pb-20 relative z-10">
                        {filtered.length === 0 && (<div className="text-center text-gray-400 py-12 text-xs font-bold opacity-60 flex flex-col items-center gap-2"><div className="text-3xl grayscale opacity-50">{tab === 'daily' ? 'ğŸ›’' : 'âœ¨'}</div>{tab === 'daily' ? 'å®¶é‡Œç‰©èµ„å……è¶³ï¼Œæ— éœ€è¡¥è´§' : 'æš‚æ— å¿ƒæ„¿ï¼ŒçŸ¥è¶³å¸¸ä¹'}</div>)}
                        {filtered.map((item, i) => {
                            const myId = AV.User.current()?.id;
                            const amIDone = item.checkedBy && item.checkedBy.includes(myId);
                            const doneCount = item.checkedBy ? item.checkedBy.length : 0;
                            const progressText = item.cabinId ? `(${doneCount}/${memberCount})` : '';
        
                            return (
                                <div key={item.id} className={`flex items-center justify-between p-3 pl-4 bg-white rounded-2xl shadow-sm border-l-[6px] transition-all animate-pop group ${item.checked ? 'opacity-50 grayscale bg-gray-50 border-gray-200' : (tab==='daily'?'border-[#F6E05E]':'border-purple-300')}`} style={{animationDelay: `${i*30}ms`}}>
                                    <div className="flex items-center gap-3 overflow-hidden flex-1 cursor-pointer" onClick={() => toggleItem(item.id)}>
                                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${amIDone || item.checked ? 'bg-gray-400 border-gray-400' : 'border-gray-300 bg-white group-hover:border-[#3DAA86]'}`}>{ (amIDone || item.checked) && <Icon path={Icons.Check} size={12} className="text-white"/>}</div>
                                        <div className="flex flex-col min-w-0">
                                            <div className="flex items-center gap-2">
                                                <span className={`font-bold text-sm truncate transition-all ${item.checked ? 'line-through text-gray-400' : 'text-[#59584D]'}`}>{item.name}</span>
                                                {item.cabinId && <span className="text-[9px] bg-[#FF9F43]/20 text-[#E67E22] px-1.5 py-0.5 rounded-md font-black whitespace-nowrap">{progressText}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3 shrink-0">
                                        {item.type === 'wish' && (<span className={`text-xs font-black px-2 py-1 rounded-lg ${item.checked ? 'bg-gray-200 text-gray-500' : 'bg-purple-100 text-purple-600'}`}>{Number(item.price).toLocaleString()}</span>)}
                                        <button onClick={(e) => {e.stopPropagation(); deleteItem(item.id);}} className="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-400 hover:bg-red-50 rounded-full transition-colors"><Icon path={Icons.Trash} size={16}/></button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
        
                    {/* è±†ç‹¸ & ç²’ç‹¸ - æ›¿æ¢ä¸º PNG å›¾ç‰‡ */}
                    <div className="absolute bottom-[-10px] right-[-10px] z-0 pointer-events-none opacity-90">
                        <img 
                            src="https://veape229-1308125337.cos.ap-chengdu.myqcloud.com/Nook/pic2/douli.png" 
                            alt="Timmy and Tommy" 
                            // è°ƒæ•´å°ºå¯¸å’Œæµ®åŠ¨åŠ¨ç”»ï¼Œç¡®ä¿ä¸ä¼šé®æŒ¡ä¸»è¦å†…å®¹
                            className="w-32 h-auto animate-float-slow" 
                            style={{animationDuration: '4s'}}
                        />
                    </div>
                </div>
            );
        };

		// â€œä»Šå¤©åƒä»€ä¹ˆâ€ è½¬ç›˜ç»„ä»¶
		// ==========================================
		const DecisionApp = ({ options, addOption, deleteOption, showFeedback }) => {
		    const [view, setView] = useState('spin'); // 'spin' | 'edit'
		    const [currentText, setCurrentText] = useState('ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ');
		    const [isSpinning, setIsSpinning] = useState(false);
		    const [winner, setWinner] = useState(null);
		    const [newOpt, setNewOpt] = useState('');
		
		    // é»˜è®¤å¤‡é€‰æ–‡æ¡ˆï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰æ·»åŠ ä»»ä½•é€‰é¡¹
		    const defaults = ['éº¦å½“åŠ³', 'æ²™å¿å°åƒ', 'ä¾¿åˆ©åº—', 'è‡ªå·±åš', 'ä¸åƒäº†', 'éº»è¾£çƒ«', 'KFC'];
		    const activeOptions = options.length > 0 ? options.map(o => o.name) : defaults;
		
		    // æ ¸å¿ƒé€»è¾‘ï¼šæ´—ç‰ŒåŠ¨ç”»
		    const handleSpin = () => {
		        if (isSpinning) return;
		        setIsSpinning(true);
		        setWinner(null);
		        
		        let count = 0;
		        const totalSpins = 30; // é—ªåŠ¨æ¬¡æ•°
		        let speed = 50; // åˆå§‹é€Ÿåº¦ (ms)
		
		        const run = () => {
		            // éšæœºæ˜¾ç¤ºä¸€ä¸ª
		            const randomIdx = Math.floor(Math.random() * activeOptions.length);
		            setCurrentText(activeOptions[randomIdx]);
		            
		            count++;
		            if (count < totalSpins) {
		                // é€Ÿåº¦é€æ¸å˜æ…¢ï¼Œåˆ¶é€ ç´§å¼ æ„Ÿ
		                if (count > 20) speed += 30;
		                setTimeout(run, speed);
		            } else {
		                // ç»“æŸ
		                setIsSpinning(false);
		                setWinner(activeOptions[randomIdx]); // æœ€ç»ˆç»“æœ
		                // æ’­æ”¾éŸ³æ•ˆæˆ–éœ‡åŠ¨ï¼ˆå¯é€‰ï¼‰
		                if(navigator.vibrate) navigator.vibrate(200); 
		            }
		        };
		        run();
		    };
		
		    const handleAdd = () => {
		        if(!newOpt.trim()) return;
		        addOption(newOpt);
		        setNewOpt('');
		        showFeedback("é€‰é¡¹å·²æ·»åŠ ");
		    };
		
		    return (
		        <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
		            {/* é¡¶éƒ¨æ  */}
		            <div className="flex items-center justify-between mb-4 shrink-0">
		                <div className="flex items-center gap-2">
		                    <div className="w-10 h-10 bg-[#FF7D9A] rounded-full flex items-center justify-center text-white shadow-sm border-2 border-white">
		                        <Icon path={Icons.Dice} size={20} />
		                    </div>
		                    <h2 className="text-xl font-black opacity-80">åŠ¨æ£®å¤§è½¬ç›˜</h2>
		                </div>
		                <button onClick={() => setView(view === 'spin' ? 'edit' : 'spin')} className="w-8 h-8 rounded-full bg-white text-gray-500 flex items-center justify-center shadow-sm active:scale-95 transition-all">
		                    <Icon path={view === 'spin' ? Icons.Edit : Icons.ArrowLeft} size={16}/>
		                </button>
		            </div>
		
		            {/* ç•Œé¢ 1: è½¬ç›˜åŒº */}
		            {view === 'spin' && (
		                <div className="flex-1 flex flex-col items-center justify-center pb-10 animate-pop">
		                    {/* ç»“æœæ˜¾ç¤ºæ¡† - æ¨¡ä»¿åŠ¨æ£®å¯¹è¯æ¡† */}
		                    <div className={`relative w-full aspect-square max-h-[260px] bg-[#FDFDF6] rounded-[40px] border-[8px] flex items-center justify-center p-6 text-center shadow-xl transition-all duration-200 ${winner ? 'border-[#FF7D9A] scale-105' : 'border-[#3DAA86]'}`}>
		                        {/* è£…é¥°æ€§èƒŒæ™¯ç‚¹ç¼€ */}
		                        <div className="absolute inset-4 border-2 border-dashed border-gray-200 rounded-[30px] pointer-events-none opacity-50"></div>
		                        
		                        <div className="relative z-10">
		                            {winner && <div className="text-xs font-black text-[#FF7D9A] mb-2 animate-bounce">ç‹¸å…‹å»ºè®®ä½ é€‰æ‹©ï¼š</div>}
		                            <div className={`font-black text-[#59584D] break-words leading-tight transition-all ${isSpinning ? 'text-4xl opacity-50 blur-[1px]' : 'text-5xl scale-110'}`}>
		                                {currentText}
		                            </div>
		                        </div>
		
		                        {/* èµ¢å®¶æ ‡è®° */}
		                        {winner && (
		                            <div className="absolute -bottom-4 bg-[#FF7D9A] text-white px-4 py-1 rounded-full text-xs font-bold shadow-md animate-pop">
		                                å†³å®šå°±æ˜¯å®ƒäº†ï¼
		                            </div>
		                        )}
		                    </div>
		
		                    <div className="mt-12 w-full px-4">
		                        <button 
		                            onClick={handleSpin} 
		                            disabled={isSpinning}
		                            className={`nook-btn w-full py-5 text-xl tracking-widest shadow-[0_6px_0_#2D8666] transition-all ${isSpinning ? 'opacity-80 translate-y-1.5 shadow-none cursor-wait' : 'hover:scale-[1.02] active:translate-y-1.5 active:shadow-none'}`}
		                        >
		                            {isSpinning ? 'æŠ½å–ä¸­...' : 'SPIN!'}
		                        </button>
		                        <p className="text-center text-[10px] text-gray-400 font-bold mt-4 opacity-60">
		                            {options.length === 0 ? '* å½“å‰ä½¿ç”¨é»˜è®¤åˆ—è¡¨ï¼Œç‚¹å‡»å³ä¸Šè§’ç¼–è¾‘' : '* ä»ä½ çš„è‡ªå®šä¹‰åˆ—è¡¨ä¸­æŠ½å–'}
		                        </p>
		                    </div>
		                </div>
		            )}
		
		            {/* ç•Œé¢ 2: ç¼–è¾‘åˆ—è¡¨ */}
		            {view === 'edit' && (
		                <div className="flex-1 flex flex-col min-h-0 animate-pop">
		                    <div className="nook-card p-2 mb-4 flex gap-2">
		                        <input 
		                            value={newOpt} 
		                            onChange={e => setNewOpt(e.target.value)}
		                            onKeyDown={e => e.key === 'Enter' && handleAdd()}
		                            className="flex-1 bg-transparent px-2 font-bold text-[#59584D] outline-none placeholder-gray-300" 
		                            placeholder="è¾“å…¥æ–°é€‰é¡¹ (å¦‚: éº»è¾£çƒ«)"
		                        />
		                        <button onClick={handleAdd} className="bg-[#3DAA86] text-white rounded-lg w-8 h-8 flex items-center justify-center shadow-sm active:scale-95">
		                            <Icon path={Icons.Plus} size={18}/>
		                        </button>
		                    </div>
		
		                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-2 pb-6">
		                        {options.length === 0 && (
		                            <div className="text-center text-gray-400 py-8 text-xs font-bold opacity-50">
		                                åˆ—è¡¨ä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤é€‰é¡¹ã€‚
		                            </div>
		                        )}
		                        {options.map((opt, i) => (
		                            <div key={opt.id} className="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center border border-gray-100 animate-pop" style={{animationDelay: `${i*30}ms`}}>
		                                <span className="font-bold text-[#59584D] ml-2">{opt.name}</span>
		                                <button onClick={() => deleteOption(opt.id)} className="text-gray-300 hover:text-red-400 p-2">
		                                    <Icon path={Icons.Trash} size={16}/>
		                                </button>
		                            </div>
		                        ))}
		                    </div>
		                </div>
		            )}
		        </div>
		    );
		};
        // ==========================================
        // LedgerApp ç»„ä»¶ (æ–°å¢å·¥èµ„ç»“ç®—åŠŸèƒ½)
        // ==========================================
        
        const LedgerApp = ({ ledger, addRecord, deleteRecord, showFeedback, settleMonthlySalary, stats }) => {
            const [view, setView] = useState('list'); 
            const [timeView, setTimeView] = useState('month'); 
            const [type, setType] = useState('expense'); 
            const [amount, setAmount] = useState(''); 
            const [category, setCategory] = useState('å…¶ä»–'); 
            const [note, setNote] = useState('');
            const [isPending, setIsPending] = useState(false); // æ–°å¢çŠ¶æ€ï¼šæ˜¯å¦ä¸ºé¢„è®¡æ”¶å…¥
        
            const categories = type === 'expense' ? ['åƒé¥­', 'é›¶é£Ÿ', 'å¨±ä¹', 'ç”Ÿæ´»', 'äº¤é€š', 'æœé¥°', 'æ—¥ç”¨å“'] : ['å·¥ä½œ', 'åˆ©æ¯', 'å…¶ä»–'];
            
            // ç­›é€‰å¾…ç»“ç®—è®°å½•çš„é€»è¾‘ (ç”¨äºç»“ç®—è§†å›¾)
            const pendingSalaryRecords = useMemo(() => {
                const now = new Date();
                const lastMonth = new Date(now);
                lastMonth.setMonth(now.getMonth() - 1);
                lastMonth.setDate(15);
                
                const thisMonthSettleDate = new Date(now);
                thisMonthSettleDate.setDate(15);
        
                return ledger.filter(r => {
                    const recordDate = new Date(r.timestamp);
                    const isPendingSalary = r.type === 'income' && r.isPending && r.isSalary;
                    
                    // ç­›é€‰ç»“ç®—å‘¨æœŸå†…ï¼ˆä¸Šæœˆ15æ—¥è‡³æœ¬æœˆ15æ—¥ï¼‰çš„å¾…ç»“ç®—å·¥èµ„è®°å½•
                    return isPendingSalary && recordDate >= lastMonth && recordDate <= thisMonthSettleDate;
                });
            }, [ledger]);
        
            const expectedSalaryTotal = pendingSalaryRecords.reduce((sum, r) => sum + r.amount, 0);
        
            const filteredLedger = useMemo(() => {
                const now = new Date();
                return ledger.filter(r => {
                    const d = new Date(r.timestamp);
                    if (timeView === 'day') return d.toDateString() === now.toDateString();
                    else if (timeView === 'week') return d >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    else return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            }, [ledger, timeView]);
        
            const summary = useMemo(() => {
                let inc = 0, exp = 0;
                filteredLedger.forEach(r => r.type === 'income' ? inc += Number(r.amount) : exp += Number(r.amount));
                return { income: inc, expense: exp, balance: inc - exp };
            }, [filteredLedger]);
        
            const handleAdd = () => { 
                if(!amount) return alert("è¯·è¾“å…¥é‡‘é¢"); 
                // ã€ä¿®æ­£ã€‘è°ƒç”¨ addRecord æ—¶ä¼ é€’ isPending çŠ¶æ€
                addRecord(type, Number(amount), category, note, isPending); 
                setAmount(''); 
                setNote(''); 
                setIsPending(false); // é‡ç½®çŠ¶æ€
                setView('list'); 
                showFeedback(isPending ? "é¢„è®¡æ”¶å…¥å·²è®°å½•" : "è®°è´¦æˆåŠŸï¼"); 
            };
        
            const handleDelete = (id) => { if (confirm("åˆ é™¤æ­¤è´¦å•ï¼Ÿ")) { deleteRecord(id); showFeedback("è´¦å•å·²åˆ é™¤", "error"); } };
            const getSummaryTitle = () => { if (timeView === 'day') return 'ä»Šæ—¥ç»“ä½™'; if (timeView === 'week') return 'è¿‘7å¤©ç»“ä½™'; return 'æœ¬æœˆç»“ä½™'; };
        
            // --- æ¸²æŸ“æ–°å¢/ç¼–è¾‘è§†å›¾ ---
            if (view === 'add') return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-2 mb-4 shrink-0">
                        <button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button>
                        <h2 className="text-xl font-black opacity-80">è®°ä¸€ç¬”</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        {/* æ”¶å…¥/æ”¯å‡ºåˆ‡æ¢ */}
                        <div className="flex bg-gray-200 p-1 rounded-xl">
                            <button onClick={()=>{setType('expense'); setIsPending(false);}} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type==='expense'?'bg-white text-red-500 shadow-sm scale-95':'text-gray-500'}`}>æ”¯å‡º</button>
                            <button onClick={()=>{setType('income'); setCategory('å·¥ä½œ');}} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type==='income'?'bg-white text-green-500 shadow-sm scale-95':'text-gray-500'}`}>æ”¶å…¥</button>
                        </div>
                        
                        {/* [æ–°å¢] é¢„è®¡æ”¶å…¥å¼€å…³ */}
                        {type === 'income' && category === 'å·¥ä½œ' && (
                            <div className="nook-card flex items-center justify-between p-4 border-l-8 border-[#3DAA86]">
                                <div>
                                    <div className="font-bold text-[#59584D] text-sm">æ ‡è®°ä¸ºé¢„è®¡æ”¶å…¥ (å¾…ç»“ç®—)</div>
                                    <div className="text-xs text-gray-400">å·¥èµ„æ”¶å…¥è¯·å…ˆæ ‡è®°ä¸ºâ€œé¢„è®¡â€</div>
                                </div>
                                <label className="nook-switch scale-75">
                                    <input type="checkbox" checked={isPending} onChange={e=>setIsPending(e.target.checked)}/>
                                    <span className="slider bg-gray-200"></span>
                                </label>
                            </div>
                        )}
        
                        <div className="nook-card">
                            <label className="text-xs font-bold text-gray-400 mb-1 block">é‡‘é¢</label>
                            <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full text-3xl font-black bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="0"/>
                        </div>
                        
                        <div>
                            <label className="text-xs font-bold text-gray-500 mb-2 block ml-2">é€‰æ‹©åˆ†ç±»</label>
                            <div className="grid grid-cols-4 gap-2">
                                {categories.map(c => (
                                    <button key={c} onClick={()=>setCategory(c)} className={`py-2 rounded-xl text-xs font-bold border-2 transition-all ${category===c?'border-[#3DAA86] bg-white text-[#3DAA86] scale-95':'border-transparent bg-white/50 text-gray-500'}`}>
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="nook-card p-3">
                            <input value={note} onChange={e=>setNote(e.target.value)} className="w-full bg-transparent outline-none text-sm font-bold placeholder-gray-300" placeholder="æ·»åŠ å¤‡æ³¨ (é€‰å¡«)"/>
                        </div>
                        
                        <button onClick={handleAdd} className="nook-btn w-full flex justify-center mt-4">
                            {isPending ? 'è®°å½•é¢„è®¡æ”¶å…¥' : 'å®Œæˆè®°è´¦'}
                        </button>
                    </div>
                </div>
            );
            
            // --- æ¸²æŸ“ç»“ç®—è§†å›¾ ---
            if (view === 'settle_view') return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-2 mb-4 shrink-0">
                        <button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button>
                        <h2 className="text-xl font-black opacity-80">æœˆåº¦å·¥èµ„ç»“ç®—</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        <div className="nook-card border-l-8 border-[#3DAA86] p-4">
                            <div className="text-xs font-bold text-gray-400 mb-1">æœ¬æ¬¡ç»“ç®—å‘¨æœŸ ({new Date(pendingSalaryRecords[0]?.timestamp || Date.now()).toLocaleDateString()} - {new Date().toLocaleDateString()})</div>
                            <div className="text-lg font-black text-[#59584D]">é¢„è®¡æ”¶å…¥æ€»é¢</div>
                            <div className="text-3xl font-black text-green-500 mt-1">{expectedSalaryTotal.toLocaleString()}</div>
                        </div>
        
                        {/* å®é™…æ ¸å¯¹é‡‘é¢è¾“å…¥ */}
                        <div className="nook-card border-l-8 border-yellow-500 p-4">
                            <label className="text-sm font-bold text-gray-500 mb-2 block">æ‰‹åŠ¨æ ¸å¯¹ï¼šå®é™…ç»“ç®—é‡‘é¢</label>
                            <input 
                                type="number" 
                                value={amount} 
                                onChange={e => setAmount(e.target.value)} 
                                onFocus={() => { if (!amount) setAmount(expectedSalaryTotal.toString()); }} // èšç„¦æ—¶é»˜è®¤å¡«å…¥é¢„è®¡é‡‘é¢
                                className="nook-input text-2xl font-black text-center" 
                                placeholder={expectedSalaryTotal.toLocaleString()}
                            />
                            <p className="text-[10px] text-gray-400 mt-2">ï¼ˆç•™ç©ºåˆ™é»˜è®¤æŒ‰ **é¢„è®¡æ€»é¢** å…¥è´¦ï¼‰</p>
                        </div>
                        
                        {/* ç»“ç®—æŒ‰é’® */}
                        <button 
                            onClick={() => settleMonthlySalary(Number(amount) || expectedSalaryTotal, pendingSalaryRecords)} 
                            disabled={pendingSalaryRecords.length === 0}
                            className="nook-btn w-full bg-green-500 shadow-[0_5px_0_#2F855A] mt-4"
                        >
                            {pendingSalaryRecords.length > 0 
                                ? `ç¡®è®¤ç»“ç®—å¹¶å…¥è´¦ ${ (Number(amount) || expectedSalaryTotal).toLocaleString() } é“ƒé’±`
                                : 'æš‚æ— å¾…å…¥è´¦æ”¶å…¥'}
                        </button>
        
                        {/* å¾…ç»“ç®—è®°å½•æ¸…å• (å¯é€‰) */}
                        {pendingSalaryRecords.length > 0 && (
                            <div className="nook-card p-4">
                                <div className="text-xs font-bold text-gray-500 mb-2">æœ¬æ¬¡å°†æ¸…é›¶çš„ {pendingSalaryRecords.length} ç¬”é¢„è®¡å·¥èµ„è®°å½•:</div>
                                {pendingSalaryRecords.map(r => (
                                    <div key={r.id} className="text-xs bg-gray-50 p-2 rounded flex justify-between border-b border-dashed border-gray-200 last:border-b-0">
                                        <span className='text-gray-600'>{r.date} - {r.note || 'é¢„è®¡å·¥èµ„'}</span>
                                        <span className="font-bold text-green-500">+{r.amount.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        
            // --- æ¸²æŸ“åˆ—è¡¨ä¸»è§†å›¾ ---
            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter relative h-full">
                    {/* é¡¶éƒ¨æ ‡é¢˜ */}
                    <div className="flex items-center justify-between mb-4 shrink-0">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-[#FFD166] rounded-full flex items-center justify-center text-white"><Icon path={Icons.Book} /></div>
                            <h2 className="text-xl font-black opacity-80">è®°è´¦æœ¬</h2>
                        </div>
                        {/* ã€æ–°å¢ã€‘ç»“ç®—å…¥å£æŒ‰é’® */}
                        {pendingSalaryRecords.length > 0 && (
                            <button onClick={() => setView('settle_view')} className="bg-red-500 text-white text-xs font-bold px-3 py-2 rounded-full shadow-md animate-pop active:scale-95 transition-all">
                                ğŸ”” {pendingSalaryRecords.length} ç¬”å¾…ç»“ç®—
                            </button>
                        )}
                    </div>
                    
                    {/* æ—¶é—´åˆ‡æ¢ */}
                    <div className="flex bg-white/50 p-1 rounded-xl mb-4 backdrop-blur-sm shrink-0">
                        {['day', 'week', 'month'].map(t => (<button key={t} onClick={()=>setTimeView(t)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView===t?'bg-white text-[#3DAA86] shadow-sm scale-95':'text-gray-500'}`}>{t==='day' ? 'ä»Šæ—¥' : (t==='week' ? 'è¿‘7å¤©' : 'æœ¬æœˆ')}</button>))}
                    </div>
                    
                    {/* ç»Ÿè®¡å¡ç‰‡ */}
                    <div className="bg-[#3D405B] rounded-[24px] p-5 text-[#F4F1DE] shadow-lg mb-4 flex justify-between items-center relative overflow-hidden shrink-0 transition-transform hover:scale-[1.02]">
                        <div className="absolute right-0 bottom-0 w-24 h-24 bg-white/5 rounded-full -mr-6 -mb-6"></div>
                        <div>
                            <div className="text-[10px] opacity-60 font-bold mb-1">{getSummaryTitle()}</div>
                            <div className="text-2xl font-black tracking-wide">{summary.balance.toLocaleString()}</div>
                        </div>
                        <div className="text-right space-y-1">
                            <div><span className="text-[10px] bg-green-500/20 text-green-300 px-1.5 rounded mr-1">æ”¶</span><span className="text-sm font-bold">{summary.income.toLocaleString()}</span></div>
                            <div><span className="text-[10px] bg-red-500/20 text-red-300 px-1.5 rounded mr-1">æ”¯</span><span className="text-sm font-bold">{summary.expense.toLocaleString()}</span></div>
                        </div>
                    </div>
                    
                    {/* åˆ—è¡¨å’Œæ·»åŠ æŒ‰é’® */}
                    <button onClick={()=>setView('add')} className="absolute bottom-6 right-2 bg-[#3DAA86] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#2F855A] transition active:scale-95 flex items-center gap-2 z-30 font-bold animate-pop"><Icon path={Icons.Plus} size={18}/> è®°ä¸€ç¬”</button>
                    
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-24">
                        {filteredLedger.length === 0 && (<div className="text-center text-gray-400 py-10 text-xs font-bold opacity-50 flex flex-col items-center"><div className="text-2xl mb-2">ğŸ“’</div>{timeView === 'day' ? 'ä»Šå¤©æš‚æ— è´¦å•' : 'æš‚æ— è®°å½•'}</div>)}
                        {filteredLedger.map((item, i) => (
                            <div key={item.id} className={`bg-white rounded-2xl p-4 shadow-sm flex justify-between items-center group animate-pop ${item.isPending ? 'border-l-8 border-yellow-400' : (item.type === 'expense' ? 'border-l-8 border-red-400' : 'border-l-8 border-green-400')}`} style={{animationDelay: `${i*50}ms`}}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-sm ${item.isPending ? 'bg-yellow-400' : (item.type==='expense'?'bg-red-400':'bg-green-400')}`}>
                                        {item.isPending ? 'å¾…' : item.category.substring(0,2)}
                                    </div>
                                    <div>
                                        <div className="font-bold text-[#59584D] text-sm">
                                            {item.category} <span className="text-xs font-normal text-gray-400 ml-1">{item.note}</span>
                                        </div>
                                        <div className="text-[10px] text-gray-400 font-bold">
                                            {item.date} {item.isPending && '(é¢„è®¡æ”¶å…¥)'}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className={`font-black ${item.isPending ? 'text-yellow-500' : (item.type==='expense'?'text-red-500':'text-green-500')}`}>
                                        {item.isPending ? '+' : (item.type==='expense'?'-':'+')}{item.amount.toLocaleString()}
                                    </span>
                                    {!item.isPending && ( // åªæœ‰éå¾…ç»“ç®—è®°å½•æ‰èƒ½åˆ é™¤ï¼Œé¿å…è¯¯åˆ å·¥èµ„
                                        <button onClick={()=>handleDelete(item.id)} className="text-gray-300 hover:text-red-400 transition transform hover:scale-110"><Icon path={Icons.Trash} size={14}/></button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // VoiceWorkApp ç»„ä»¶ (å½•éŸ³åŠ©æ‰‹ - ä¿®æ­£åçš„ç‰ˆæœ¬)
        // ==========================================
        const VoiceWorkApp = ({ voiceWorks, addWork, toggleSettled, deleteWork, showFeedback }) => {
            const [view, setView] = useState('list'); 
            const [title, setTitle] = useState(''); 
            const [price, setPrice] = useState(''); 
            const [currentMonth, setCurrentMonth] = useState(new Date());
        
            const nextMonth = () => { const d = new Date(currentMonth); d.setMonth(d.getMonth() + 1); setCurrentMonth(d); };
            const prevMonth = () => { const d = new Date(currentMonth); d.setMonth(d.getMonth() - 1); setCurrentMonth(d); };
            
            const monthlyData = useMemo(() => { 
                const y = currentMonth.getFullYear(); 
                const m = currentMonth.getMonth(); 
                const filtered = voiceWorks
                    .filter(w => { 
                        // ä¿®æ­£ï¼šç¡®ä¿ createdAt æ˜¯æœ‰æ•ˆçš„æ—¥æœŸå­—ç¬¦ä¸²
                        const d = new Date(w.createdAt); 
                        return !isNaN(d) && d.getFullYear() === y && d.getMonth() === m; 
                    })
                    .sort((a,b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()); // ç¡®ä¿æŒ‰æ—¶é—´æ’åº
        
                let settled = 0, pending = 0; 
                filtered.forEach(w => w.settled ? settled += w.price : pending += w.price); 
                return { list: filtered, settled, pending }; 
            }, [voiceWorks, currentMonth]);
        
            const handleSave = () => { 
                if(!title || !price) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); 
                addWork(title, price); 
                setTitle(''); 
                setPrice(''); 
                setView('list'); 
                showFeedback("å·¥ä½œè®°å½•å·²æ·»åŠ ï¼"); 
            };
        
            if(view === 'add') return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-2 mb-4 shrink-0">
                        <button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500">
                            <Icon path={Icons.ArrowLeft} size={24}/>
                        </button>
                        <h2 className="text-xl font-black opacity-80">æ·»åŠ å·¥ä½œ</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        <div className="nook-card p-4">
                            <label className="text-xs font-bold text-gray-400 mb-1 block">å½•éŸ³åç§°</label>
                            <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full text-lg font-bold bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="ä¾‹å¦‚ï¼šç¬¬1é›†..."/>
                        </div>
                        <div className="nook-card p-4">
                            <label className="text-xs font-bold text-gray-400 mb-1 block">æŠ¥é…¬å•ä»·</label>
                            <input type="number" value={price} onChange={e=>setPrice(e.target.value)} className="w-full text-lg font-bold bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="0"/>
                        </div>
                        <button onClick={handleSave} className="nook-btn w-full mt-4">ä¿å­˜è®°å½•</button>
                    </div>
                </div>
            );
            
            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter relative h-full">
                    <div className="flex items-center justify-between mb-4 shrink-0">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-[#805AD5] rounded-full flex items-center justify-center text-white">
                                <Icon path={Icons.Mic} />
                            </div>
                            <h2 className="text-xl font-black opacity-80">å½•éŸ³åŠ©æ‰‹</h2>
                        </div>
                        {/* æœˆä»½åˆ‡æ¢ */}
                        <div className="flex items-center bg-white/50 rounded-full px-1 py-1 backdrop-blur-sm">
                            <button onClick={prevMonth} className="p-1.5 hover:bg-white/80 rounded-full text-gray-600 transition-colors">
                                <Icon path={Icons.ChevronLeft} size={16}/>
                            </button>
                            <span className="text-xs font-bold text-[#59584D] mx-2 min-w-[60px] text-center">
                                {currentMonth.getFullYear()}å¹´{currentMonth.getMonth() + 1}æœˆ
                            </span>
                            <button onClick={nextMonth} className="p-1.5 hover:bg-white/80 rounded-full text-gray-600 transition-colors">
                                <Icon path={Icons.ChevronRight} size={16}/>
                            </button>
                        </div>
                    </div>
                    
                    {/* ç»Ÿè®¡å¡ç‰‡ */}
                    <div className="bg-[#2D3748] rounded-[24px] p-5 text-white shadow-lg mb-4 flex justify-between items-center relative overflow-hidden shrink-0 transition-transform hover:scale-[1.02]">
                        <div className="absolute right-0 bottom-0 w-24 h-24 bg-white/5 rounded-full -mr-6 -mb-6"></div>
                        <div>
                            <div className="text-[10px] font-bold opacity-50 mb-1 uppercase">Pending ({currentMonth.getMonth()+1}æœˆ)</div>
                            <div className="text-2xl font-black text-[#F6AD55] tracking-wide">{monthlyData.pending.toLocaleString()}</div>
                        </div>
                        <div className="text-right">
                            <div>
                                <div className="text-[10px] font-bold opacity-50 mb-1 uppercase">Settled ({currentMonth.getMonth()+1}æœˆ)</div>
                                <div className="text-xl font-bold text-[#68D391]">{monthlyData.settled.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
        
                    {/* åˆ—è¡¨å’Œæ·»åŠ æŒ‰é’® */}
                    <button onClick={()=>setView('add')} className="absolute bottom-6 right-2 bg-[#805AD5] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#6B46C1] transition active:scale-95 flex items-center gap-2 z-30 font-bold animate-pop">
                        <Icon path={Icons.Plus} size={18}/> è®°ä¸€ç¬”
                    </button>
                    
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-24">
                        {monthlyData.list.length === 0 && <div className="text-center text-gray-400 py-10 text-xs font-bold opacity-50 flex flex-col items-center"><div className="text-2xl mb-2">ğŸ™ï¸</div>æœ¬æœˆæš‚æ— å·¥ä½œè®°å½•</div>}
                        {monthlyData.list.map((item, i) => (
                            <div key={item.id} className={`bg-white rounded-2xl p-4 shadow-sm flex justify-between items-center group animate-pop ${item.settled ? 'opacity-60' : ''}`} style={{animationDelay: `${i*50}ms`}}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-sm transition-colors ${item.settled ? 'bg-green-100 text-green-500' : 'bg-purple-100 text-purple-500'}`}>
                                        <Icon path={item.settled ? Icons.Check : Icons.Mic} size={18}/>
                                    </div>
                                    <div>
                                        <div className={`font-bold text-sm ${item.settled ? 'line-through text-gray-400' : 'text-[#59584D]'}`}>{item.title}</div>
                                        <div className="text-[10px] text-gray-400 font-bold">{new Date(item.createdAt).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className={`font-black ${item.settled ? 'text-gray-400' : 'text-[#805AD5]'}`}>+{item.price.toLocaleString()}</span>
                                    <button onClick={()=>toggleSettled(item.id)} className={`p-2 rounded-full border-2 transition-all ${item.settled ? 'bg-green-500 border-green-500 text-white' : 'border-gray-200 text-gray-300 hover:border-[#805AD5] hover:text-[#805AD5]'}`}>
                                        <Icon path={Icons.Check} size={14}/>
                                    </button>
                                    <button onClick={()=>deleteWork(item.id)} className="text-gray-300 hover:text-red-400 transition">
                                        <Icon path={Icons.Trash} size={14}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
// ==========================================
        // Nook Miles App (æ˜¾ç¤ºå¤šäººè¿›åº¦ç‰ˆ)
        // ==========================================
        const NookMilesApp = ({ stats, tasks, addTask, updateTask, deleteTask, completeTask, showFeedback, cabin, memberCount }) => {
            const [view, setView] = useState('list'); 
            const [timeView, setTimeView] = useState('day'); 
            
            const [editingId, setEditingId] = useState(null); 
            const [newTitle, setNewTitle] = useState('');
            const [newDiff, setNewDiff] = useState('normal');
            const [newType, setNewType] = useState('ç”Ÿæ´»');
            const [linkMoney, setLinkMoney] = useState(false);
            const [moneyType, setMoneyType] = useState('income');
            const [moneyAmount, setMoneyAmount] = useState('');
            const [fitnessValue, setFitnessValue] = useState('');
            const [isShared, setIsShared] = useState(false);
            
            const levelInfo = getLevelInfo(stats?.xp || 0);

            const filteredTasks = useMemo(() => {
                const now = new Date();
                return tasks.filter(t => {
                    const d = new Date(t.createdAt);
                    if (timeView === 'day') return d.toDateString() === now.toDateString();
                    else if (timeView === 'week') return d >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    else return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            }, [tasks, timeView]);

            const handleOpenCreate = () => { setEditingId(null); setNewTitle(''); setNewDiff('normal'); setNewType('ç”Ÿæ´»'); setLinkMoney(false); setMoneyAmount(''); setFitnessValue(''); setIsShared(false); setView('editor'); };
            const handleOpenEdit = (t) => {
                setEditingId(t.id); setNewTitle(t.title); setNewDiff(t.difficulty || 'normal'); setNewType(t.type || 'ç”Ÿæ´»');
                if (t.money) { setLinkMoney(true); setMoneyType(t.money.type); setMoneyAmount(t.money.amount); } else { setLinkMoney(false); setMoneyAmount(''); }
                if (t.calories) setFitnessValue(t.calories); else setFitnessValue('');
                setIsShared(!!t.cabinId);
                setView('editor');
            };

            const handleSave = () => {
                if(!newTitle) return alert("è¯·è¾“å…¥ä»»åŠ¡å†…å®¹");
                const moneyData = linkMoney ? { type: moneyType, amount: parseInt(moneyAmount) } : null;
                const caloriesData = (newType === 'å¥èº«' || newType === 'åƒé¥­') ? parseInt(fitnessValue) : null;
                const rewardXP = DIFFICULTIES[newDiff].xp;
                const cabinIdToSave = (isShared && cabin) ? cabin.id : null;

                if (editingId) {
                    updateTask(editingId, { title: newTitle, difficulty: newDiff, type: newType, reward: rewardXP, money: moneyData, calories: caloriesData, cabinId: cabinIdToSave });
                } else {
                    addTask(newTitle, newDiff, newType, rewardXP, moneyData, caloriesData, cabinIdToSave);
                    showFeedback("ä»»åŠ¡å·²å‘å¸ƒï¼", "success");
                }
                setView('list');
            };
            
            const handleComplete = (t) => {
                const myId = AV.User.current().id; // ç®€å•è·å–æœ¬åœ°ID
                if(t.completedBy && t.completedBy.includes(myId)) return; // å·²ç»ç‚¹è¿‡äº†
                completeTask(t.id);
                showFeedback(`æ‰“å¡æˆåŠŸï¼+${DIFFICULTIES[t.difficulty || 'normal'].xp} Miles`, "success");
            };

            if (view === 'editor') return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-2 mb-4 shrink-0"><button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">{editingId ? 'ç¼–è¾‘ä»»åŠ¡' : 'å‘å¸ƒä»»åŠ¡'}</h2></div>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        <div className="nook-card p-4"><label className="text-xs font-bold text-gray-400 mb-1 block">ä»»åŠ¡å†…å®¹</label><input value={newTitle} onChange={e=>setNewTitle(e.target.value)} className="w-full text-lg font-bold bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="ä¾‹å¦‚ï¼šå»é’“é±¼..."/></div>
                        <div><label className="text-xs font-bold text-gray-500 mb-2 block ml-2">é€‰æ‹©ç±»å‹</label><div className="grid grid-cols-3 gap-2">{['å·¥ä½œ', 'å¨±ä¹', 'ç”Ÿæ´»', 'å¥èº«', 'åƒé¥­'].map(t => (<button key={t} onClick={()=>setNewType(t)} className={`py-2 rounded-xl text-xs font-bold border-2 transition-all ${newType===t?'border-[#3DAA86] bg-white text-[#3DAA86] scale-95':'border-transparent bg-white/50 text-gray-500'}`}>{t}</button>))}</div></div>
                        {(newType === 'å¥èº«' || newType === 'åƒé¥­') && (<div className={`nook-card border-l-8 ${newType==='å¥èº«'?'border-orange-400':'border-green-400'}`}><label className="text-xs font-bold text-gray-500 mb-1 block">{newType === 'å¥èº«' ? 'é¢„è®¡æ¶ˆè€— (kcal)' : 'é¢„è®¡æ‘„å…¥ (kcal)'}</label><input type="number" value={fitnessValue} onChange={e=>setFitnessValue(e.target.value)} className="w-full bg-transparent border-b-2 border-gray-200 py-1 text-center font-black text-xl outline-none transition-colors" placeholder="0"/></div>)}
                        {cabin && (<div className="nook-card border-l-8 border-[#FF9F43] flex items-center justify-between p-4"><div><div className="font-bold text-[#59584D] text-sm">åŒæ­¥åˆ°å°å±‹</div></div><label className="nook-switch scale-75"><input type="checkbox" checked={isShared} onChange={e=>setIsShared(e.target.checked)}/><span className="slider bg-gray-200"></span></label></div>)}
                        <div className="nook-card border-l-8 border-yellow-400"><div className="flex items-center justify-between mb-2"><label className="text-xs font-bold text-gray-500">é‡‘é’±å˜åŠ¨</label><label className="nook-switch scale-75"><input type="checkbox" checked={linkMoney} onChange={e=>setLinkMoney(e.target.checked)}/><span className="slider"></span></label></div>{linkMoney && (<div className="space-y-3 animate-pop"><div className="flex bg-gray-100 p-1 rounded-lg"><button onClick={()=>setMoneyType('income')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${moneyType==='income'?'bg-white text-green-600 shadow-sm scale-95':'text-gray-400'}`}>è·å¾—</button><button onClick={()=>setMoneyType('expense')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${moneyType==='expense'?'bg-white text-red-500 shadow-sm scale-95':'text-gray-400'}`}>æ¶ˆè€—</button></div><div className="relative"><input type="number" value={moneyAmount} onChange={e=>setMoneyAmount(e.target.value)} className="w-full bg-transparent border-b-2 border-gray-200 py-1 text-center font-black text-xl outline-none focus:border-yellow-400 transition-colors" placeholder="0"/><div className="absolute right-0 top-2 text-[10px] font-bold text-gray-400">BELLS</div></div></div>)}</div>
                        <button onClick={handleSave} className="nook-btn w-full flex justify-center mt-4">{editingId ? 'ä¿å­˜ä¿®æ”¹' : 'å‘å¸ƒä»»åŠ¡'}</button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
                    <div className="flex items-center justify-between mb-4 shrink-0"><div className="flex items-center gap-3"><div className="w-12 h-12 bg-[#3DAA86] rounded-full flex items-center justify-center text-white shadow-md relative"><Icon path={Icons.Leaf} size={24}/><div className="absolute -bottom-1 -right-1 bg-yellow-400 text-yellow-900 text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center border-2 border-white animate-bounce" style={{animationDuration:'3s'}}>{levelInfo.level}</div></div><div><h2 className="text-lg font-black opacity-80">é›†é‡Œæ¸¸+</h2><div className="w-24 h-2 bg-gray-200 rounded-full mt-1 overflow-hidden"><div className="h-full bg-yellow-400 progress-bar-fill" style={{width: `${levelInfo.progress}%`}}></div></div><div className="text-[10px] text-gray-400 font-bold mt-0.5">LV.{levelInfo.level} ({parseInt(levelInfo.currentXP)}/{levelInfo.requiredXP})</div></div></div></div>
                    <div className="flex bg-white/50 p-1 rounded-xl mb-4 backdrop-blur-sm shrink-0">{['day','week','month'].map(t => (<button key={t} onClick={()=>setTimeView(t)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView===t?'bg-white text-[#3DAA86] shadow-sm scale-95':'text-gray-500'}`}>{t==='day'?'ä»Šæ—¥':(t==='week'?'è¿‘7å¤©':'æœ¬æœˆ')}</button>))}</div>
                    <button onClick={handleOpenCreate} className="absolute bottom-6 right-2 bg-[#3DAA86] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#2F855A] transition active:scale-95 flex items-center gap-2 z-30 font-bold animate-pop"><Icon path={Icons.Plus} size={18}/> å‘å¸ƒä»»åŠ¡</button>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-24">
                        {filteredTasks.length === 0 && (<div className="text-center text-xs opacity-50 py-10 flex flex-col items-center"><div className="text-2xl mb-2">ğŸŒ´</div>{timeView === 'day' ? 'ä»Šå¤©æ²¡æœ‰ä»»åŠ¡äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å§' : 'è¯¥æ—¶é—´æ®µæš‚æ— ä»»åŠ¡è®°å½•'}</div>)}
                        {filteredTasks.map((t, i) => {
                            const diff = DIFFICULTIES[t.difficulty || 'normal']; 
                            const myId = AV.User.current()?.id;
                            const amIDone = t.completedBy && t.completedBy.includes(myId);
                            const doneCount = t.completedBy ? t.completedBy.length : 0;
                            // å¦‚æœæ˜¯å°å±‹ä»»åŠ¡ï¼Œæ˜¾ç¤º (x/y)ï¼Œå¦åˆ™å•äººä»»åŠ¡åªçœ‹è‡ªå·±
                            const progressText = t.cabinId ? `(${doneCount}/${memberCount})` : '';

                            return (
                                <div key={t.id} className={`bg-white rounded-2xl p-4 border-l-8 shadow-sm flex justify-between items-center animate-pop group ${t.completed ? 'border-gray-300 opacity-60' : 'border-[#F4A261]'}`} style={{animationDelay: `${i*50}ms`}}>
                                    <div className="flex items-center gap-3 overflow-hidden flex-1">
                                        <div className={`w-3 h-3 rounded-full ${diff.color} shadow-sm ring-2 ${diff.ring} shrink-0`}></div>
                                        <div className="min-w-0">
                                            <div className="font-bold text-[#59584D] flex items-center gap-2 flex-wrap">
                                                <span className="truncate">{t.title}</span>
                                                {/* æ˜¾ç¤ºè¿›åº¦æ–‡æœ¬ */}
                                                {t.cabinId && <span className="text-[10px] bg-[#FF9F43]/20 text-[#E67E22] px-1.5 py-0.5 rounded-md font-black whitespace-nowrap">{progressText}</span>}
                                                {t.money && <span className={`text-[10px] px-1.5 py-0.5 rounded-full flex items-center gap-1 whitespace-nowrap ${t.money.type==='income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'}`}><Icon path={Icons.Coin} size={10}/> {t.money.amount}</span>}
                                            </div>
                                            <div className="text-[10px] font-black text-[#38B2AC] bg-[#E6FFFA] px-1.5 py-0.5 rounded inline-block mt-1">{diff.label} +{t.reward} XP <span className="ml-2 opacity-50 font-normal">{new Date(t.createdAt).toLocaleDateString()}</span></div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 shrink-0 ml-2">
                                        <button onClick={() => handleOpenEdit(t)} className="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center hover:bg-blue-100 hover:text-blue-500 transition-colors"><Icon path={Icons.Edit} size={14}/></button>
                                        <button onClick={() => deleteTask(t.id)} className="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center hover:bg-red-100 hover:text-red-500 transition-colors"><Icon path={Icons.Trash} size={14}/></button>
                                        {/* å¦‚æœæˆ‘å·²ç»å®Œæˆï¼Œæ˜¾ç¤ºå®å¿ƒå¶å­ï¼›å¦‚æœæ²¡å®Œæˆï¼Œæ˜¾ç¤ºç©ºå¿ƒæŒ‰é’® */}
                                        {amIDone ? (
                                            <div className="w-10 h-10 flex items-center justify-center text-[#3DAA86] anim-stamp"><Icon path={Icons.Leaf} size={24}/></div>
                                        ) : (
                                            <button onClick={() => handleComplete(t)} className="w-10 h-10 rounded-full border-4 border-[#E2E8F0] text-[#CBD5E0] flex items-center justify-center hover:bg-[#3DAA86] hover:text-white hover:border-[#3DAA86] transition-all transform active:scale-90 shadow-sm"><Icon path={Icons.Check} size={20}/></button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                        <div className="text-center text-xs opacity-50 py-4">æ›´å¤šä»»åŠ¡å°†åœ¨ç¬¬äºŒå¤©åˆ·æ–°...</div>
                    </div>
                </div>
            );
        };

        const DailyBroadcastApp = ({ tasks, ledger, fitLogs, voiceWorks, wikiItems, stats }) => {
            const getGreeting = () => {
                const hour = new Date().getHours();
                if (hour < 5) return "å¤œæ·±äº†ï¼Œæ³¨æ„ä¼‘æ¯å“¦ï¼Œå¤œçŒ«å­å±…æ°‘ï¼ğŸŒ™";
                if (hour < 11) return "æ—©å®‰ï¼æ–°çš„ä¸€å¤©ï¼Œä»æ·±å‘¼å¸å¼€å§‹ï¼â˜€ï¸";
                if (hour < 13) return "åˆå®‰ï¼è®°å¾—æŒ‰æ—¶åƒé¥­å“¦ï¼ğŸ±";
                if (hour < 18) return "ä¸‹åˆå¥½ï¼é€‚åˆåœ¨å²›ä¸Šæ•£æ•£æ­¥ã€‚â˜•";
                return "æ™šä¸Šå¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿâœ¨";
            };
            const fortune = useMemo(() => {
                const fortunes = [
                    { label: "å¤§å‰", text: "ä»Šå¤©æ‘‡æ ‘å¯èƒ½ä¼šæ‰å®¶å…·å“¦ï¼è¿æ°”çˆ†æ£šï¼", color: "text-red-500", icon: "ğŸŒŸ" },
                    { label: "ä¸­å‰", text: "é€‚åˆé’“é±¼ï¼Œè¯´ä¸å®šèƒ½é‡åˆ°ç¨€æœ‰é±¼ç±»ã€‚", color: "text-orange-500", icon: "ğŸ£" },
                    { label: "å°å‰", text: "å»å’Œé‚»å±…èŠèŠå¤©å§ï¼Œä¼šæœ‰å¥½äº‹å‘ç”Ÿã€‚", color: "text-green-500", icon: "ğŸ’¬" },
                    { label: "å¹³", text: "å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼Œäº«å—æ‚ é—²æ—¶å…‰ã€‚", color: "text-blue-500", icon: "ğŸµ" },
                    { label: "æœ«å‰", text: "å°å¿ƒèœœèœ‚ï¼è®°å¾—éšèº«å¸¦å¥½æ•è™«ç½‘ã€‚", color: "text-gray-500", icon: "ğŸ" }
                ];
                const daySeed = new Date().getDate() + new Date().getMonth(); 
                return fortunes[daySeed % fortunes.length]; 
            }, []);
            const completedTasks = tasks.filter(t => t.completed).length;
            const totalTasks = tasks.length;
            const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            const monthExpense = ledger.filter(l => l.type === 'expense').reduce((sum, l) => sum + l.amount, 0);
            const todayLog = fitLogs.filter(l => l.date === new Date().toLocaleDateString());
            const todayIntake = todayLog.filter(l => l.type === 'intake').reduce((sum, l) => sum + l.val, 0);
            const todayBurn = todayLog.filter(l => l.type === 'exercise').reduce((sum, l) => sum + l.val, 0);
            const randomWiki = useMemo(() => {
                if (!wikiItems || wikiItems.length === 0) return null;
                return wikiItems[Math.floor(Math.random() * wikiItems.length)];
            }, [wikiItems]);
            
            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-3 mb-6 shrink-0 bg-white/40 p-3 rounded-2xl backdrop-blur-sm shadow-sm"><div className="w-12 h-12 bg-yellow-400 rounded-full flex items-center justify-center text-white shadow-md animate-bounce" style={{animationDuration: '3s'}}><Icon path={Icons.Radio} size={24}/></div><div><h2 className="text-lg font-black text-[#59584D] opacity-90">æ¯æ—¥æ’­æŠ¥</h2><div className="text-xs font-bold text-gray-500">{getGreeting()}</div></div></div>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4 px-1">
                        <div className="nook-card bg-gradient-to-r from-[#FFFBEB] to-[#FFFFFF] border-l-8 border-yellow-400"><div className="flex justify-between items-center mb-1"><h3 className="font-bold text-[#59584D] flex items-center gap-2"><span>{fortune.icon}</span> ä»Šæ—¥å²›æ°‘è¿åŠ¿</h3><span className={`text-xl font-black ${fortune.color} bg-white px-2 py-0.5 rounded-lg shadow-sm`}>{fortune.label}</span></div><p className="text-xs text-gray-500 font-bold ml-6">{fortune.text}</p></div>
                        <div className="nook-card border-l-8 border-blue-400"><div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-blue-100 text-blue-500 rounded-full"><Icon path={Icons.Leaf} size={14}/></div><h3 className="font-bold text-[#59584D]">å²›åŠ¡ä¸­å¿ƒ</h3></div><div className="space-y-3"><div><div className="flex justify-between items-center text-xs font-bold mb-1"><span className="text-gray-400">ä»Šæ—¥ä»»åŠ¡å®Œæˆåº¦</span><span className="text-[#3DAA86]">{completedTasks}/{totalTasks}</span></div><div className="w-full bg-gray-100 h-2.5 rounded-full overflow-hidden shadow-inner"><div className="bg-[#3DAA86] h-full transition-all duration-1000 ease-out rounded-full" style={{width: `${progress}%`}}></div></div></div><div className="bg-blue-50/50 rounded-xl p-2 text-xs text-gray-500 flex items-start gap-2"><span className="text-lg">ğŸ’°</span><span>{monthExpense > 10000 ? `æœ¬æœˆå·²æ”¯å‡º ${monthExpense.toLocaleString()} é“ƒé’±ã€‚æ˜¯ä¸æ˜¯ä¹°å¤ªå¤šå¤§å¤´èœäº†ï¼Ÿè®°å¾—ç†æ€§æ¶ˆè´¹ï¼` : `æœ¬æœˆæ”¯å‡º ${monthExpense.toLocaleString()} é“ƒé’±ã€‚æŒå®¶æœ‰é“ï¼Œç‹¸å…‹ä¸ºä½ ç‚¹èµï¼`}</span></div></div></div>
                        <div className="nook-card border-l-8 border-red-400"><div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-red-100 text-red-500 rounded-full"><Icon path={Icons.Activity} size={14}/></div><h3 className="font-bold text-[#59584D]">å¥åº·è¿½è¸ª</h3></div><div className="flex gap-3 mb-3"><div className="flex-1 bg-orange-50 rounded-2xl p-2 text-center border border-orange-100"><div className="text-[10px] text-orange-400 font-black mb-1 uppercase">Burn</div><div className="text-xl font-black text-orange-500">{todayBurn}</div></div><div className="flex-1 bg-green-50 rounded-2xl p-2 text-center border border-green-100"><div className="text-[10px] text-green-400 font-black mb-1 uppercase">Intake</div><div className="text-xl font-black text-green-500">{todayIntake}</div></div></div><p className="text-xs text-center text-gray-400 font-bold italic bg-gray-50 py-1 rounded-lg">{todayBurn > todayIntake ? "ç‡ƒèµ·æ¥äº†ï¼çƒ­é‡ç¼ºå£è¾¾æˆï¼ğŸ”¥" : "äº«å—ç¾é£Ÿçš„åŒæ—¶ï¼Œåˆ«å¿˜äº†åŠ¨ä¸€åŠ¨å“¦ï¼ğŸ¥—"}</p></div>
                        {randomWiki && (<div className="nook-card border-l-8 border-[#667EEA] bg-gradient-to-br from-indigo-50/50 to-white"><div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2"><div className="p-1.5 bg-indigo-100 text-indigo-500 rounded-full"><Icon path={Icons.Bookmark} size={14}/></div><h3 className="font-bold text-[#59584D]">è®°å¿†ç¢ç‰‡</h3></div><span className="text-[10px] bg-indigo-100 text-indigo-500 px-2 py-0.5 rounded-full font-bold">å›é¡¾</span></div><div className="bg-white/60 p-3 rounded-xl border border-indigo-50 shadow-sm"><h4 className="font-bold text-sm text-[#2D3748] mb-1">{randomWiki.title}</h4><p className="text-xs text-gray-500 line-clamp-3 leading-relaxed">â€œ{randomWiki.content}â€</p></div></div>)}
                        {voiceWorks.some(w => !w.settled) && (<div className="nook-card border-l-8 border-purple-400 flex justify-between items-center bg-purple-50/30"><div><h3 className="font-bold text-[#59584D] text-sm">å¾…ç»“ç®—å·¥ä½œ</h3><p className="text-[10px] text-gray-400 font-bold mt-0.5">åˆ«å¿˜äº†æ‰¾è€æ¿ç»“è´¦ï¼</p></div><div className="flex flex-col items-end"><div className="text-purple-600 font-black text-xl">{voiceWorks.filter(w=>!w.settled).length}</div><div className="text-[10px] text-purple-400 font-bold uppercase">Pending</div></div></div>)}
                        <div className="text-center text-[10px] text-gray-300 font-bold pt-4 pb-2 opacity-50">- Nook Inc. Broadcast System -</div>
                    </div>
                </div>
            );
        };

        const PassportApp = ({ user, stats, passport, updatePassport }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState(passport || {});
            
            const levelInfo = getLevelInfo(stats?.xp || 0); 
            const fruits = ['ğŸ', 'ğŸŠ', 'ğŸ', 'ğŸ‘', 'ğŸ’', 'ğŸ¥¥'];

            useEffect(() => { if (passport) setEditData(passport); }, [passport]);

            const handleSave = () => { updatePassport(editData); setIsEditing(false); };
            const handleChange = (field, value) => { setEditData(prev => ({ ...prev, [field]: value })); };

            if (isEditing) return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                    <div className="flex items-center gap-2 mb-4 shrink-0"><button onClick={()=>setIsEditing(false)} className="p-2 -ml-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">ç¼–è¾‘æŠ¤ç…§</h2></div>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                        <div className="nook-card space-y-4">
                            <div><label className="text-xs font-bold text-gray-400 mb-1 block">å¤´è¡” (Title)</label><div className="flex gap-2"><input value={editData.title1} onChange={e=>handleChange('title1', e.target.value)} className="nook-input text-sm flex-1" placeholder="å½¢å®¹è¯"/><input value={editData.title2} onChange={e=>handleChange('title2', e.target.value)} className="nook-input text-sm flex-1" placeholder="åè¯"/></div></div>
                            <div><label className="text-xs font-bold text-gray-400 mb-1 block">å²›å±¿åç§°</label><input value={editData.islandName} onChange={e=>handleChange('islandName', e.target.value)} className="nook-input text-sm" placeholder="è¾“å…¥å²›å..."/></div>
                            <div><label className="text-xs font-bold text-gray-400 mb-2 block">ç‰¹äº§æ°´æœ</label><div className="flex justify-between bg-gray-100 p-2 rounded-xl">{fruits.map(f => (<button key={f} onClick={()=>handleChange('fruit', f)} className={`w-9 h-9 rounded-lg flex items-center justify-center text-xl transition-all ${editData.fruit === f ? 'bg-white shadow-md scale-110 border-2 border-[#3DAA86]' : 'opacity-60 hover:opacity-100'}`}>{f}</button>))}</div></div>
                            <div><label className="text-xs font-bold text-gray-400 mb-1 block">ç”Ÿæ—¥</label><input type="date" value={editData.birthday} onChange={e=>handleChange('birthday', e.target.value)} className="nook-input text-sm text-center font-mono"/></div>
                            <div><label className="text-xs font-bold text-gray-400 mb-1 block">ä¸ªæ€§ç­¾å</label><textarea rows="2" value={editData.comment} onChange={e=>handleChange('comment', e.target.value)} className="nook-input text-sm resize-none" placeholder="å†™ä¸€å¥é—®å€™è¯­å§..."/></div>
                        </div>
                        <button onClick={handleSave} className="nook-btn w-full bg-[#3DAA86] shadow-[0_5px_0_#2D8666]">ä¿å­˜å˜æ›´</button>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
                    <div className="flex items-center justify-between mb-4 shrink-0"><div className="flex items-center gap-2"><div className="w-10 h-10 bg-[#3DAA86] rounded-full flex items-center justify-center text-white"><Icon path={Icons.User} /></div><h2 className="text-xl font-black opacity-80">å²›æ°‘æŠ¤ç…§</h2></div><button onClick={()=>setIsEditing(true)} className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:bg-white transition-colors"><Icon path={Icons.Edit} size={16}/></button></div>
                    <div className="bg-[#FDFDF6] rounded-[24px] shadow-xl overflow-hidden relative border-4 border-[#E2E8F0] flex flex-col shrink-0 transition-transform duration-500 hover:scale-[1.01] group"><div className="h-3 bg-[#3DAA86] w-full flex"><div className="h-full w-1/3 bg-[#339171]"></div><div className="h-full w-1/3 bg-[#2D8666]"></div></div><div className="p-5 flex flex-col gap-4 relative"><div className="absolute top-10 right-10 text-9xl opacity-[0.03] pointer-events-none rotate-12">âœˆï¸</div><div className="flex gap-4 z-10"><div className="w-24 h-24 bg-white rounded-2xl border-4 border-gray-100 shadow-inner overflow-hidden shrink-0 relative"><img src={user.avatar} className="w-full h-full object-cover"/><div className="absolute bottom-0 right-0 bg-[#3DAA86] text-white text-[8px] font-black px-1.5 py-0.5 rounded-tl-lg">REP.</div></div><div className="flex-1 flex flex-col justify-center min-w-0"><div className="text-[10px] text-[#3DAA86] font-black uppercase tracking-wider mb-0.5">Name</div><div className="text-xl font-black text-[#59584D] leading-none mb-3 truncate">{user.username}</div><div className="text-[10px] text-[#3DAA86] font-black uppercase tracking-wider mb-0.5">Island</div><div className="text-sm font-bold text-[#59584D] leading-none truncate">{passport?.islandName || 'Nook å²›'}</div></div></div><div className="grid grid-cols-2 gap-4 border-t-2 border-dashed border-gray-200 pt-3 z-10"><div><div className="text-[10px] text-[#3DAA86] font-black uppercase tracking-wider mb-0.5">Title</div><div className="text-xs font-bold text-[#59584D] break-words">{passport?.title1} {passport?.title2}</div></div><div><div className="text-[10px] text-[#3DAA86] font-black uppercase tracking-wider mb-0.5">Birthday</div><div className="text-xs font-bold text-[#59584D]">{passport?.birthday ? new Date(passport.birthday).toLocaleDateString() : 'æœªç™»è®°'}</div></div></div><div className="bg-white border-2 border-gray-100 rounded-xl p-3 relative mt-1 shadow-sm z-10"><div className="absolute -top-1.5 left-8 w-3 h-3 bg-white border-t-2 border-l-2 border-gray-100 rotate-45"></div><p className="text-xs text-[#59584D] font-bold italic opacity-80">â€œ{passport?.comment || '......'}â€</p></div></div><div className="bg-[#EBF8F3] px-4 py-3 border-t border-[#3DAA86]/20 relative overflow-hidden"><div className="text-[10px] font-bold text-[#3DAA86]/60 mb-2 uppercase tracking-widest">Achievements</div><div className="flex gap-2 relative z-10 overflow-x-auto no-scrollbar pb-1"><div className="w-10 h-10 rounded-full border-2 border-[#3DAA86] bg-white flex items-center justify-center text-xl shadow-sm transform -rotate-6" title="å²›å±¿ç‰¹äº§">{passport?.fruit}</div><div className="w-10 h-10 rounded-full border-2 border-[#3DAA86] bg-[#3DAA86] flex flex-col items-center justify-center text-white shadow-sm transform rotate-3" title="å½“å‰ç­‰çº§"><div className="text-[8px] font-bold uppercase leading-none opacity-80">LV</div><div className="text-sm font-black leading-none">{levelInfo.level}</div></div>{stats.miles >= 1000 && (<div className="w-10 h-10 rounded-full border-2 border-blue-400 bg-blue-50 flex items-center justify-center text-lg shadow-sm transform -rotate-3" title="é‡Œç¨‹è¾¾äºº (1000+ Miles)">âœˆï¸</div>)}{stats.miles >= 5000 && (<div className="w-10 h-10 rounded-full border-2 border-indigo-500 bg-indigo-50 flex items-center justify-center text-lg shadow-sm transform rotate-6" title="é‡Œç¨‹ä¸“å®¶ (5000+ Miles)">ğŸŒ</div>)}{stats.savings >= 50000 && (<div className="w-10 h-10 rounded-full border-2 border-yellow-500 bg-yellow-50 flex items-center justify-center text-lg shadow-sm transform -rotate-12" title="å‚¨è“„æ–°æ˜Ÿ (50k+ Bells)">ğŸ’°</div>)}{stats.savings >= 100000 && (<div className="w-10 h-10 rounded-full border-2 border-orange-500 bg-orange-50 flex items-center justify-center text-lg shadow-sm transform rotate-3" title="é“ƒé’±å¤§äº¨ (100k+ Bells)">ğŸ¦</div>)}</div></div></div>
                    <div className="mt-4 text-center"><p className="text-[10px] text-gray-400 font-bold">Nook Inc. Official Passport</p></div>
                </div>
            );
        };

        const SettingsApp = ({ user, currentTheme, currentAvatar, changeTheme, changeAvatar, onReset, onLogout }) => (
            <div className="flex flex-col flex-1 min-h-0 screen-enter h-full">
                <div className="flex items-center gap-2 mb-6 shrink-0"><div className="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center text-white"><Icon path={Icons.Settings} /></div><h2 className="text-xl font-black opacity-80">è®¾ç½®</h2></div>
                <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 pb-4">
                    <div className="nook-card border-l-8 border-[#3DAA86]"><h3 className="font-bold text-[#59584D] mb-2">å±…æ°‘ä¿¡æ¯</h3><div className="flex items-center gap-3 mb-4"><div className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-gray-400 overflow-hidden border-2 border-gray-100 shadow-inner"><img src={currentAvatar} alt="avatar" className="w-full h-full object-cover"/></div><div><div className="text-lg font-black text-[#59584D]">{user?.username || 'N/A'}</div><div className="text-xs text-gray-500 font-bold flex items-center gap-1"><Icon path={Icons.Mail} size={12} className="inline-block" /> {user?.email || 'N/A'}</div><div className="text-[10px] text-gray-400 font-bold mt-1">ID: {user?.id}</div></div></div><button onClick={onLogout} className="nook-btn-secondary py-3 px-4 rounded-full font-bold text-sm text-gray-600 flex justify-center items-center gap-2 w-full"><Icon path={Icons.LogOut} size={16}/> é€€å‡ºç™»å½•</button></div>
                    <div className="nook-card"><h3 className="font-bold text-[#59584D] mb-3">æ›´æ¢è¯ä»¶ç…§</h3><div className="grid grid-cols-4 gap-2">{AVATAR_LIBRARY.map((url, idx) => (<button key={idx} onClick={()=>changeAvatar(url)} className={`w-full aspect-square rounded-full border-4 overflow-hidden bg-white flex items-center justify-center transition-transform hover:scale-105 ${currentAvatar === url ? 'border-[#3DAA86]' : 'border-transparent'}`}><img src={url} className="w-full h-full object-cover"/></button>))}</div></div>
                    <div className="nook-card"><h3 className="font-bold text-[#59584D] mb-3">æ›´æ¢æ‰‹æœºå£³</h3><div className="grid grid-cols-2 gap-3">{THEMES.map(t => (<button key={t.id} onClick={()=>changeTheme(t.id)} className={`p-3 rounded-xl border-4 transition-all flex items-center gap-2 text-left bg-gray-100 ${currentTheme === t.id ? 'border-[#3DAA86] bg-white shadow-md' : 'border-transparent'}`}><div className="w-6 h-6 rounded-full border border-white shadow-sm" style={{background: t.bg}}></div><span className="text-xs font-bold text-gray-600">{t.name}</span></button>))}</div></div>
                    <div className="pb-4"><button onClick={onReset} className="w-full py-4 rounded-3xl border-2 border-red-100 bg-red-50 text-red-500 font-black text-sm flex items-center justify-center gap-2 hover:bg-red-100 transition active:scale-95"><Icon path={Icons.Danger} size={18}/> é‡ç½®æ•°æ®</button></div>
                </div>
            </div>
        );

// ==========================================
// Nook Cabin App åŠå…¶è¾…åŠ©ç»„ä»¶ (æœ€ç»ˆä¿®æ­£ç‰ˆ)
// ==========================================

const GyroidIcon = ({ dancing }) => (
    <svg viewBox="0 0 100 100" className={`w-full h-full drop-shadow-md ${dancing ? 'animate-bounce' : ''}`} style={{overflow:'visible'}}>
        <path d="M30 30 L70 30 L80 90 L20 90 Z" fill="#E67E22" stroke="#D35400" strokeWidth="3"/>
        <circle cx="35" cy="45" r="5" fill="#3E2723"/>
        <circle cx="65" cy="45" r="5" fill="#3E2723"/>
        <path d="M40 60 Q50 70 60 60" fill="none" stroke="#3E2723" strokeWidth="3" strokeLinecap="round"/>
        <rect x="25" y="15" width="50" height="15" rx="5" fill="#D35400"/>
        <path d="M20 50 L10 40" stroke="#E67E22" strokeWidth="8" strokeLinecap="round" className={dancing ? 'origin-center rotate-12' : ''}/>
        <path d="M80 50 L90 40" stroke="#E67E22" strokeWidth="8" strokeLinecap="round" className={dancing ? 'origin-center -rotate-12' : ''}/>
    </svg>
);
// ==========================================
// CabinApp ç»„ä»¶ (å‚æ•°å†²çªå·²è§£å†³ï¼ŒUI/UX ä¼˜åŒ–ç‰ˆ)
// ==========================================

// è¾…åŠ©ç»„ä»¶ï¼šå°å‹åŠŸèƒ½æ¨¡å—å¡ç‰‡ (Widget)
// ==========================================
// CabinApp ç»„ä»¶ (æœ€ç»ˆä¿®æ­£ç‰ˆ - è§£å†³æ‰€æœ‰å¼•ç”¨é”™è¯¯)
// ==========================================

// è¾…åŠ©ç»„ä»¶ï¼šå°å‹åŠŸèƒ½æ¨¡å—å¡ç‰‡ (Widget)
const CabinWidget = ({ id, label, icon, color, count, onClick, isActive }) => (
    <button 
        onClick={onClick} 
        className={`nook-card p-4 flex flex-col items-start space-y-1 transition-all w-full h-full text-left 
                   ${isActive ? 'ring-4 ring-offset-2 ring-white shadow-xl scale-[1.03]' : 'hover:scale-[1.03] active:scale-[0.98] opacity-90'}`}
        style={{ borderColor: color, borderLeftWidth: '8px', borderLeftStyle: 'solid' }}
    >
        <div className="flex items-center justify-between w-full">
            <Icon path={icon} size={24} style={{ color: color }} />
            {count !== null && count > 0 && (
                <span className={`text-xl font-black`} style={{ color: color }}>{count}</span>
            )}
        </div>
        <span className="text-xs font-bold text-gray-500 mt-1">{label}</span>
    </button>
);


const CabinApp = ({ 
    user, cabin, tasks, shoppingItems, wikiItems, messages, projects, inventory, 
    starJar, 
    createCabin, joinCabin, leaveCabin, addMessage, createProject, 
    donateProject, 
    addInventory, updateInventory, deleteInventory, 
    updateStatus, addStar, clearStars, 
    showFeedback, memberCount, stats 
}) => {
    // ã€ä¿®æ­£ã€‘activeModule çŠ¶æ€å®šä¹‰
    const [view, setView] = useState(cabin ? 'dashboard' : 'welcome'); 
    const [activeModule, setActiveModule] = useState(null); // <-- ç¡®ä¿ activeModule çŠ¶æ€è¢«å®šä¹‰
    const [inputName, setInputName] = useState('');
    const [inputCode, setInputCode] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [members, setMembers] = useState([]);
    const [isRefreshing, setIsRefreshing] = useState(false);
    
    // çŠ¶æ€
    const [msgContent, setMsgContent] = useState('');
    const [projName, setProjName] = useState('');
    const [projGoal, setProjGoal] = useState('');
    const [donateVal, setDonateVal] = useState('');
    const [donateSource, setDonateSource] = useState('pocket');
    const [invName, setInvName] = useState('');
    const [invQty, setInvQty] = useState('1');
    const [invDate, setInvDate] = useState(new Date().toISOString().split('T')[0]); 
    const [showStatusMenu, setShowStatusMenu] = useState(false);
    const [recipientId, setRecipientId] = useState(null); 

    // æ•°æ®è¿‡æ»¤ 
    const sharedTasks = tasks.filter(t => t.cabinId === cabin?.id);
    const sharedShopping = shoppingItems.filter(i => i.cabinId === cabin?.id);
    const sharedWiki = wikiItems.filter(i => i.cabinId === cabin?.id);
    const sharedMessages = messages ? messages.filter(m => m.cabinId === cabin?.id) : [];
    const sharedProjects = projects ? projects.filter(p => p.cabinId === cabin?.id) : [];
    const sharedInventory = inventory ? inventory.filter(i => i.cabinId === cabin?.id).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)) : [];

    const STATUS_OPTIONS = [{ id: 'online', label: 'åœ¨çº¿', icon: 'ğŸŸ¢' },{ id: 'busy', label: 'å¿™ç¢Œ', icon: 'ğŸ”´' },{ id: 'sleep', label: 'ç¡è§‰', icon: 'ğŸ˜´' },{ id: 'game', label: 'è‚åŠ¨æ£®', icon: 'ğŸ®' },{ id: 'work', label: 'æ¬ç –', icon: 'ğŸ’»' },{ id: 'food', label: 'å¹²é¥­', icon: 'ğŸœ' },{ id: 'fish', label: 'æ‘¸é±¼', icon: 'ğŸŸ' }];

    // --- æ˜Ÿæ˜Ÿç“¶è®¡ç®—é€»è¾‘ (ä¾èµ–äº starJar prop) ---
    const myReceivedStars = useMemo(() => {
        return starJar.filter(s => s.recipientId === user.id);
    }, [starJar, user.id]); 

    const mySentStars = useMemo(() => {
        return starJar.filter(s => s.senderId === user.id);
    }, [starJar, user.id]); 

    // å‘¨æŠ¥æ•°æ®è®¡ç®— (ä¿æŒä¸å˜)
    const weeklyReport = useMemo(() => {
        if (!cabin) return null;
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        const recentTasks = sharedTasks.filter(t => t.completed && new Date(t.updatedAt || t.createdAt) > oneWeekAgo);
        const totalCompleted = recentTasks.length;

        const recentShopping = sharedShopping.filter(i => i.checked && new Date(i.updatedAt || i.createdAt) > oneWeekAgo);
        const totalSpent = recentShopping.reduce((sum, i) => sum + (i.price || 0), 0);

        const userScores = {};
        recentTasks.forEach(t => {
            (t.completedBy || []).forEach(uid => {
                userScores[uid] = (userScores[uid] || 0) + 1;
            });
        });
        
        let mvpId = null;
        let maxScore = -1;
        Object.entries(userScores).forEach(([uid, score]) => {
            if (score > maxScore) { maxScore = score; mvpId = uid; }
        });
        const mvpUser = members.find(m => m.id === mvpId);

        const chartData = members.map(m => ({
            name: m.username,
            avatar: m.avatar,
            score: userScores[m.id] || 0
        }));
        const chartMax = Math.max(...chartData.map(d => d.score), 1); 

        return { totalCompleted, totalSpent, mvpUser, maxScore, chartData, chartMax };
    }, [sharedTasks, sharedShopping, members, cabin]);


    const fetchMembers = async () => {
        if (!cabin) return;
        setIsRefreshing(true);
        try {
            const q = new AV.Query('_User');
            q.equalTo('cabin', AV.Object.createWithoutData('NookCabin', cabin.id));
            const users = await q.find();
            const mappedUsers = users.map(u => ({ id: u.id, username: u.getUsername(), avatar: u.get('avatar') || AVATAR_LIBRARY[0], status: u.get('status') || 'online' }));
            setMembers(mappedUsers.length > 0 ? mappedUsers : [{ ...user, status: 'online' }]);
        } catch (e) { setMembers([{ ...user, status: 'online' }]); } 
        finally { setIsRefreshing(false); }
    };

    useEffect(() => { fetchMembers(); }, [cabin]); 
    useEffect(() => { if(cabin) setView('dashboard'); }, [cabin]);
    
    // è‡ªåŠ¨è®¾ç½®æƒ…ä¾£IDï¼ˆå¦‚æœå°å±‹åªæœ‰ä¸¤äººï¼‰
    useEffect(() => {
        if (members.length === 2 && !recipientId) {
            setRecipientId(members.find(m => m.id !== user.id)?.id || null);
        }
    }, [members, user.id, recipientId]);


    // --- Actions (ä¿æŒä¸å˜) ---
    const handleAddStar = () => {
        if (!recipientId || recipientId === user.id) {
            return showFeedback("è¯·å…ˆé€‰æ‹©å‘é€æ˜Ÿæ˜Ÿçš„å¯¹è±¡ï¼", "error");
        }
        addStar(recipientId, cabin.id);
        showFeedback("æ˜Ÿæ˜Ÿå·²æ”¾å…¥ç“¶å­ï¼Taèƒ½æ„Ÿå—åˆ°ä½ çš„æ€å¿µï¼âœ¨", "success");
    };

    const handleClearStars = (senderId, starCount) => {
        if (starCount > 0) {
            clearStars(user.id, senderId, cabin.id);
        }
    };
    
    const handleCreate = async () => { if(!inputName) return; setIsLoading(true); await createCabin(inputName); setIsLoading(false); };
    const handleJoin = async () => { if(!inputCode) return; setIsLoading(true); await joinCabin(inputCode); setIsLoading(false); };
    const handlePostMsg = () => { if(!msgContent.trim()) return; addMessage(msgContent, cabin.id); setMsgContent(''); showFeedback("ç•™è¨€å·²å¼ è´´"); };
    const handleCreateProj = () => { if(!projName || !projGoal) return; createProject(projName, Number(projGoal), cabin.id); setProjName(''); setProjGoal(''); showFeedback("å‹Ÿæè®¡åˆ’å·²è®¾ç«‹"); };
    const handleDonate = (pid) => { 
        if(!donateVal || Number(donateVal) <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢"); 
        if ((donateSource==='pocket' ? stats.pocket : stats.savings) < Number(donateVal)) return alert("ä½™é¢ä¸è¶³ï¼");
        donateProject(pid, Number(donateVal), donateSource); setDonateVal(''); 
        showFeedback("æèµ æˆåŠŸï¼");
    };
    const handleChangeStatus = async (s) => { await updateStatus(s.id); setShowStatusMenu(false); setMembers(prev => prev.map(m => m.id === user.id ? { ...m, status: s.id } : m)); showFeedback(`çŠ¶æ€æ›´æ–°ä¸ºï¼š${s.label}`); };
    
    const handleAddInv = () => {
        if(!invName) return alert("è¯·è¾“å…¥ç‰©å“åç§°");
        addInventory(invName, Number(invQty), invDate, cabin.id);
        setInvName(''); setInvQty('1'); setInvDate(new Date().toISOString().split('T')[0]); showFeedback("å·²å­˜å…¥æ”¶çº³");
    };
    const handleQty = (item, delta) => {
        const newQ = item.quantity + delta;
        if(newQ <= 0) { if(confirm("ç”¨å®Œäº†å—ï¼Ÿè¦åˆ é™¤å—ï¼Ÿ")) deleteInventory(item.id); }
        else updateInventory(item.id, newQ);
    };
    const getStoredDays = (d) => { 
        if(!d) return 0; 
        const today = new Date().setHours(0,0,0,0);
        const stored = new Date(d).setHours(0,0,0,0);
        const diff = today - stored;
        if (diff < 0) return 0; // é¿å…æœªæ¥æ—¥æœŸå‡ºç°è´Ÿå€¼
        return Math.floor(diff / (86400000)); 
    };
    const getStatusIcon = (sid) => STATUS_OPTIONS.find(s => s.id === sid)?.icon || 'ğŸŸ¢';


    // æ¬¢è¿ç•Œé¢ (ä¿æŒä¸å˜)
    if (!cabin) return (<div className="flex flex-col flex-1 min-h-0 screen-enter h-full items-center justify-center p-6 pb-20"><div className="w-20 h-20 bg-[#FF9F43] rounded-full flex items-center justify-center text-white shadow-lg mb-4 animate-bounce"><Icon path={Icons.Home} size={40}/></div><h2 className="text-2xl font-black text-[#59584D] mb-2">Nook å°å±‹</h2><p className="text-sm text-gray-500 font-bold mb-8 text-center">ä½ çš„çº¿ä¸Šå…±äº«å²›å±¿</p><div className="w-full max-w-xs space-y-6"><div className="nook-card animate-pop"><h3 className="font-bold text-[#59584D] mb-2 text-center">åˆ›å»ºæ–°å°å±‹</h3><input value={inputName} onChange={e=>setInputName(e.target.value)} className="nook-input mb-3 text-center" placeholder="ç»™å°å±‹èµ·ä¸ªåå­—"/><button onClick={handleCreate} disabled={isLoading} className="nook-btn w-full bg-[#FF9F43] shadow-[0_5px_0_#E67E22]">{isLoading?'...':'åˆ›å»º'}</button></div><div className="relative flex justify-center"><span className="bg-[#7FE2C3] px-2 text-white font-bold text-xs">OR</span></div><div className="nook-card animate-pop" style={{animationDelay:'100ms'}}><h3 className="font-bold text-[#59584D] mb-2 text-center">åŠ å…¥å°å±‹</h3><input value={inputCode} onChange={e=>setInputCode(e.target.value)} className="nook-input mb-3 text-center" placeholder="è¾“å…¥é‚€è¯·ç "/><button onClick={handleJoin} disabled={isLoading} className="nook-btn-secondary w-full bg-white">{isLoading?'...':'åŠ å…¥'}</button></div></div></div>);

    
    const MODULE_LIST = [
        {id:'tasks',l:'å…±äº«ä»»åŠ¡',i:Icons.Leaf,c:'#3DAA86', count: sharedTasks.filter(t => !t.completed).length},
        {id:'shopping',l:'è´­ç‰©æ¸…å•',i:Icons.ShoppingBag,c:'#F6E05E', count: sharedShopping.filter(i => !i.checked).length},
        {id:'starjar',l:'æ˜Ÿæ˜Ÿç“¶',i:Icons.Star,c:'#FF9F43', count: myReceivedStars.reduce((sum, s) => sum + (s.stars || 0), 0)},
        {id:'inventory',l:'æ”¶çº³ç®±',i:Icons.Box,c:'#4299E1', count: sharedInventory.length},
        {id:'funds',l:'å‹Ÿæè®¡åˆ’',i:Icons.Gift,c:'#E53E3E', count: sharedProjects.filter(p => p.current < p.goal).length},
        {id:'board',l:'å…¬å‘Šç•™è¨€',i:Icons.Megaphone,c:'#F59E0B', count: sharedMessages.length},
        {id:'wiki',l:'å…±äº«çŸ¥è¯†',i:Icons.Bookmark,c:'#667EEA', count: sharedWiki.length},
        {id:'report',l:'å²›åŠ¡å‘¨æŠ¥',i:Icons.Clipboard,c:'#805AD5', count: null},
    ];

    // --- æ¸²æŸ“æ¨¡å—è¯¦ç»†å†…å®¹ ---
    const renderModuleDetail = () => {
        // [è¾…åŠ©å‡½æ•°] æ¸²æŸ“è¯¦æƒ…å¤´ï¼ŒåŒ…å«è¿”å›æŒ‰é’®
        const DetailHeader = ({ title, icon, color }) => (
            <div className="flex items-center justify-between mb-4 shrink-0">
                <button 
                    onClick={() => setActiveModule(null)} 
                    className="p-2 -ml-2 rounded-full text-gray-500 transition-colors hover:bg-gray-200"
                >
                    <Icon path={Icons.ArrowLeft} size={24}/>
                </button>
                <div className="flex items-center gap-3 flex-1">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm`} style={{ backgroundColor: color }}><Icon path={icon} size={20}/></div>
                    <h2 className="text-xl font-black opacity-80">{title}</h2>
                </div>
                {/* å ä½ç¬¦æˆ–ç‰¹å®šæ“ä½œæŒ‰é’® */}
                <div className="w-8"></div>
            </div>
        );

        switch (activeModule) {
            case 'tasks':
                return (
                    <div className="flex flex-col flex-1 min-h-0 h-full">
                        <DetailHeader title="å…±äº«ä»»åŠ¡" icon={Icons.Leaf} color="#3DAA86" />
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-4">
                            {sharedTasks.length === 0 && <CabinEmptyState icon="ğŸ“" text="å°å±‹æš‚æ— å…±äº«ä»»åŠ¡" />}
                            {sharedTasks.map((t, i) => (
                                <div key={t.id} className="nook-card border-l-8 border-[#3DAA86] p-4 flex items-center justify-between animate-pop" style={{animationDelay: `${i*30}ms`}}>
                                    <div className="flex items-center gap-3 min-w-0">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${t.completed ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}`}>
                                            <Icon path={Icons.Leaf} size={20} />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <div className="font-bold text-[#59584D] text-sm truncate">{t.title}</div>
                                            <div className="text-[10px] text-gray-400 font-bold mt-0.5">{t.completed ? 'å·²å…¨å‘˜å®Œæˆ' : 'è¿›è¡Œä¸­'}</div>
                                        </div>
                                    </div>
                                    <span className="text-xs font-black text-[#3DAA86] bg-[#E6FFFA] px-2 py-1 rounded-full shrink-0">({t.completedBy?.length||0}/{memberCount})</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            case 'shopping':
                return (
                    <div className="flex flex-col flex-1 min-h-0 h-full">
                        <DetailHeader title="è´­ç‰©æ¸…å•" icon={Icons.ShoppingBag} color="#F6E05E" />
                        <div className="space-y-3">
                            {sharedShopping.length === 0 && <CabinEmptyState icon="ğŸ›’" text="è´­ç‰©æ¸…å•æ˜¯ç©ºçš„" />}
                            {sharedShopping.map((i, idx) => (
                                <div key={i.id} className={`nook-card border-l-8 border-[#F6E05E] p-4 flex items-center justify-between ${i.checked ? 'opacity-50 grayscale' : ''} animate-pop`} style={{animationDelay: `${idx*30}ms`}}>
                                    <div className="flex items-center gap-3 min-w-0">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${i.checked ? 'bg-gray-200 text-gray-400' : 'bg-yellow-100 text-yellow-600'}`}>
                                            <Icon path={Icons.ShoppingBag} size={20} />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <div className={`font-bold text-[#59584D] text-sm truncate ${i.checked ? 'line-through' : ''}`}>{i.name}</div>
                                            <span className="text-[10px] font-black text-[#D69E2E] bg-[#FFFBEB] px-1.5 py-0.5 rounded mt-0.5 inline-block">({i.checkedBy?.length||0}/{memberCount})</span>
                                        </div>
                                    </div>
                                    {i.price > 0 && <div className="text-xs font-black text-purple-600 bg-purple-100 px-2 py-1 rounded-full shrink-0">{i.price.toLocaleString()}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            case 'inventory':
                return (
                    <div className='space-y-3'>
                        <DetailHeader title="æ”¶çº³ç®±" icon={Icons.Box} color="#4299E1" />
                        {/* é¡¶éƒ¨æ·»åŠ å¡ç‰‡ - é‡æ–°è®¾è®¡ï¼Œæ›´ç´§å‡‘ */}
                        <div className="nook-card border-l-8 border-[#4299E1] p-4 flex flex-col gap-3 animate-pop">
                            <h4 className='text-xs font-bold text-gray-400'>å¿«é€Ÿå­˜å…¥æ”¶çº³ç®±</h4>
                            <div className="flex gap-2 items-center">
                                <input value={invName} onChange={e=>setInvName(e.target.value)} className="flex-[2] nook-input text-sm" placeholder="ç‰©å“åç§° (å¦‚: é¸¡è›‹)"/>
                                <input type="number" value={invQty} onChange={e=>setInvQty(e.target.value)} className="w-12 nook-input text-sm text-center" placeholder="Qty"/>
                            </div>
                            <div className='flex gap-2 items-center'>
                                <input type="date" value={invDate} onChange={e=>setInvDate(e.target.value)} className="flex-1 nook-input text-sm text-center" title="å…¥åº“æ—¥æœŸ"/>
                                <button onClick={handleAddInv} className="bg-[#4299E1] text-white rounded-xl px-4 py-2 font-bold text-sm shadow-sm active:scale-95 flex items-center justify-center gap-1 shrink-0"><Icon path={Icons.Plus} size={16}/> å­˜å…¥</button>
                            </div>
                        </div>

                        {/* åˆ—è¡¨ */}
                        <div className="space-y-2">
                            {sharedInventory.length === 0 && <CabinEmptyState icon="ğŸ“¦" text="æ”¶çº³ç®±æ˜¯ç©ºçš„ï¼Œå¿«å»å­˜ç‚¹ä¸œè¥¿å§" />}
                            {sharedInventory.map((item, i) => { 
                                const storedDays = getStoredDays(item.expire); 
                                let sCol = 'bg-green-100 text-green-600 border-green-200'; 
                                if (storedDays > 30) { sCol = 'bg-orange-100 text-orange-500 border-orange-200'; } 
                                if (storedDays > 90) { sCol = 'bg-red-100 text-red-500 border-red-200'; } 
                                return (
                                    <div key={item.id} className="nook-card p-3 flex items-center justify-between group animate-pop" style={{animationDelay: `${i*30}ms`}}>
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-xl flex flex-col items-center justify-center text-[10px] font-black border-2 ${sCol} shrink-0`}>
                                                <span className="opacity-60 text-[8px]">å·²å­˜</span>
                                                <span className='text-base leading-none'>{storedDays}</span>
                                            </div>
                                            <div>
                                                <div className="font-bold text-[#59584D] text-sm">{item.name}</div>
                                                <div className="text-[10px] text-gray-400 font-bold">{item.expire ? `${item.expire} å…¥åº“` : 'æœªçŸ¥æ—¶é—´'}</div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 bg-gray-50 rounded-lg p-1 shrink-0">
                                            <button onClick={()=>handleQty(item, -1)} className="w-6 h-6 bg-white rounded text-gray-500 shadow-sm flex items-center justify-center hover:text-red-500 active:scale-95 font-bold">-</button>
                                            <span className="text-sm font-black w-6 text-center">{item.quantity}</span>
                                            <button onClick={()=>handleQty(item, 1)} className="w-6 h-6 bg-white rounded text-gray-500 shadow-sm flex items-center justify-center hover:text-[#4299E1] active:scale-95 font-bold">+</button>
                                        </div>
                                    </div>
                                ); 
                            })}
                        </div>
                    </div>
                );
            case 'funds':
                return (
                    <div className='space-y-4'>
                        <DetailHeader title="å‹Ÿæè®¡åˆ’" icon={Icons.Gift} color="#E53E3E" />
                        {/* å‘èµ·å‹Ÿæå¡ç‰‡ - çªå‡ºæ˜¾ç¤º */}
                        <div className="nook-card border-2 border-dashed border-[#E53E3E] bg-red-50/50 p-4 animate-pop">
                            <h4 className="text-xs font-bold text-red-500 mb-3 text-center">å‘èµ·æ–°çš„å‹Ÿæè®¡åˆ’</h4>
                            <div className="flex flex-col gap-2">
                                <input value={projName} onChange={e=>setProjName(e.target.value)} className="nook-input text-sm" placeholder="ç›®æ ‡åç§° (å¦‚: å‘¨æœ«å¤§é¤)"/>
                                <div className="flex gap-2">
                                    <input type="number" value={projGoal} onChange={e=>setProjGoal(e.target.value)} className="nook-input text-sm flex-1 text-center" placeholder="ç›®æ ‡é‡‘é¢"/>
                                    <button onClick={handleCreateProj} className="bg-[#E53E3E] text-white rounded-xl px-4 font-bold text-sm shadow-[0_3px_0_#9B2C2C] active:shadow-none active:translate-y-[3px] transition-all shrink-0">å‘èµ·</button>
                                </div>
                            </div>
                        </div>
                        
                        {/* å‹Ÿæé¡¹ç›®åˆ—è¡¨ */}
                        {sharedProjects.length === 0 && <CabinEmptyState icon="ğŸ" text="æš‚æ— å‹Ÿæé¡¹ç›®" />}
                        {sharedProjects.map((p, i) => { 
                            const percent = Math.min(100, (p.current / p.goal) * 100); 
                            const isCompleted = percent >= 100;
                            return (
                                <div key={p.id} className={`nook-card p-4 rounded-2xl shadow-sm border-[4px] border-[#E2E8F0] relative overflow-hidden animate-pop ${isCompleted ? 'opacity-70 grayscale' : 'border-[#E67E22]'}`}>
                                    
                                    {isCompleted && <div className="absolute inset-0 bg-[#E67E22]/10 flex items-center justify-center font-black text-[#D35400] text-xl z-20 backdrop-blur-[1px]">å‹Ÿæè¾¾æˆï¼ğŸ‰</div>}
                                    
                                    <div className="flex gap-4 relative z-10">
                                        <div className="w-14 h-16 shrink-0"><GyroidIcon dancing={!isCompleted}/></div>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-black text-[#59584D] text-lg truncate mb-1">{p.title}</div>
                                            <div className="w-full bg-gray-100 h-3 rounded-full overflow-hidden mb-2 border border-gray-200">
                                                <div className="bg-[#E67E22] h-full transition-all duration-1000" style={{width: `${percent}%`}}></div>
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <div className="text-xs font-bold text-gray-400">{percent.toFixed(0)}%</div>
                                                <div className="text-sm font-black text-[#E67E22]">{p.current.toLocaleString()} <span className="text-gray-400 text-[10px]">/ {p.goal.toLocaleString()}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {!isCompleted && (
                                        <div className="mt-4 pt-3 border-t border-dashed border-gray-200">
                                            <div className="flex items-center gap-3 mb-2 text-[10px] font-bold text-gray-500">
                                                <span className="shrink-0">æ”¯ä»˜æ¥æº:</span>
                                                <label className="flex items-center gap-1 cursor-pointer hover:text-[#3DAA86]"><input type="radio" name={`pay-${p.id}`} checked={donateSource==='pocket'} onChange={()=>setDonateSource('pocket')}/> å£è¢‹ ({stats?.pocket.toLocaleString()})</label>
                                                <label className="flex items-center gap-1 cursor-pointer hover:text-[#3DAA86]"><input type="radio" name={`pay-${p.id}`} checked={donateSource==='savings'} onChange={()=>setDonateSource('savings')}/> å­˜æ¬¾ ({stats?.savings.toLocaleString()})</label>
                                            </div>
                                            <div className="flex gap-2">
                                                <input type="number" placeholder="é‡‘é¢" value={donateVal} onChange={e=>setDonateVal(e.target.value)} className="w-20 bg-gray-50 rounded-lg px-2 text-center text-sm font-bold outline-none border border-gray-200 focus:border-[#E67E22]"/>
                                                <button onClick={()=>handleDonate(p.id)} className="flex-1 bg-[#E67E22] text-white rounded-lg text-sm font-bold py-2 shadow-[0_3px_0_#D35400] active:shadow-none active:translate-y-[3px] relative transition-all">æèµ </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            case 'board':
                return (
                    <div className='space-y-3'>
                        <DetailHeader title="å…¬å‘Šç•™è¨€" icon={Icons.Megaphone} color="#F59E0B" />
                        {/* ç•™è¨€è¾“å…¥å¡ç‰‡ */}
                        <div className="nook-card border-l-8 border-[#F59E0B] p-4 flex gap-3 animate-pop">
                            <textarea value={msgContent} onChange={e=>setMsgContent(e.target.value)} placeholder="å‘å¸ƒæ–°å…¬å‘Š..." className="flex-1 bg-[#FFFBEB] rounded-lg p-2 text-sm font-bold text-[#92400E] placeholder-[#D97706]/50 outline-none resize-none h-16 border-2 border-yellow-100 focus:border-[#F59E0B] transition-colors"/>
                            <button onClick={handlePostMsg} className="bg-[#F59E0B] text-white rounded-xl w-10 h-10 flex items-center justify-center shadow-sm active:scale-95 shrink-0 self-start"><Icon path={Icons.Send} size={16}/></button>
                        </div>

                        {/* ç•™è¨€åˆ—è¡¨ - é‡‡ç”¨ç€‘å¸ƒæµæˆ–ç½‘æ ¼ï¼Œè¿™é‡Œä½¿ç”¨ç½‘æ ¼ */}
                        <div className="grid grid-cols-2 gap-3">
                            {sharedMessages.length === 0 && <CabinEmptyState icon="ğŸ“¢" text="æš‚æ— å…¬å‘Š" />}
                            {sharedMessages.map((m, i) => (
                                <div key={m.id} className="bg-[#FEF9E3] p-3 rounded-xl shadow-sm border-t-8 border-[#FCD34D] relative animate-pop" style={{animationDelay: `${i*50}ms`}}>
                                    <div className="text-sm font-bold text-[#78350F] leading-relaxed break-all min-h-[40px]">{m.content}</div>
                                    <div className="mt-2 flex justify-between items-center border-t border-[#FDE68A] pt-1">
                                        <span className="text-[10px] text-[#B45309] font-bold">{m.author}</span>
                                        <span className="text-[8px] text-[#D97706] opacity-70">{new Date(m.createdAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            case 'wiki':
                return (
                    <div className="space-y-3">
                        <DetailHeader title="å…±äº«çŸ¥è¯†" icon={Icons.Bookmark} color="#667EEA" />
                        {sharedWiki.length === 0 && <CabinEmptyState icon="ğŸ“š" text="å°å±‹æš‚æ— å…±äº«çŸ¥è¯†" />}
                        {sharedWiki.map((item, i) => (
                            <div key={item.id} className="nook-card border-l-8 border-[#667EEA] p-4 flex items-center justify-between animate-pop" style={{animationDelay: `${i*30}ms`}}>
                                <div className="flex items-center gap-3 min-w-0">
                                    <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0"><Icon path={Icons.Bookmark} size={20}/></div>
                                    <div className="min-w-0 flex-1">
                                        <div className="font-bold text-[#59584D] text-sm truncate">{item.title}</div>
                                        <div className="text-[10px] text-gray-400 font-bold mt-0.5 truncate">{item.content}</div>
                                    </div>
                                </div>
                                {item.image && <div className='w-12 h-12 rounded-lg overflow-hidden shrink-0 border border-gray-100 bg-gray-200'><img src={item.image} alt='thumb' className='w-full h-full object-cover'/></div>}
                            </div>
                        ))}
                    </div>
                );
            case 'report':
                return (
                    <div className="space-y-4 animate-pop">
                        <DetailHeader title="å²›åŠ¡å‘¨æŠ¥" icon={Icons.Clipboard} color="#805AD5" />
                        {/* æ ‡é¢˜å¡ç‰‡ */}
                        <div className="nook-card border-l-8 border-[#805AD5] bg-gradient-to-r from-purple-50 to-white">
                            <p className="text-xs text-gray-400 font-bold">è¿‡å» 7 å¤©çš„å²›å±¿ç”Ÿæ´»è®°å½•</p>
                        </div>

                        {/* æœ¬å‘¨æ•°æ®æ¦‚è§ˆ */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="nook-card border-2 border-green-100 text-center">
                                <div className="text-3xl font-black text-[#3DAA86]">{weeklyReport?.totalCompleted}</div>
                                <div className="text-[10px] text-gray-400 font-bold mt-1">æœ¬å‘¨å®Œæˆä»»åŠ¡</div>
                            </div>
                            <div className="nook-card border-2 border-yellow-100 text-center">
                                <div className="text-3xl font-black text-[#D69E2E]">{weeklyReport?.totalSpent?.toLocaleString()}</div>
                                <div className="text-[10px] text-gray-400 font-bold mt-1">æœ¬å‘¨è´­ç‰©èŠ±è´¹</div>
                            </div>
                        </div>

                        {/* å®¶åŠ¡ä¹‹æ˜Ÿ MVP */}
                        {weeklyReport?.mvpUser ? (
                            <div className="bg-gradient-to-br from-[#FFFBEB] to-white p-4 rounded-3xl shadow-md border-4 border-yellow-200 relative overflow-hidden text-center">
                                <div className="absolute top-0 left-0 w-full h-2 bg-yellow-300"></div>
                                <div className="text-xs font-black text-yellow-600 mb-3 tracking-widest uppercase">âœ¨ Star of the Week âœ¨</div>
                                <div className="w-20 h-20 rounded-full border-4 border-white shadow-md mx-auto mb-2 overflow-hidden relative">
                                    <img src={weeklyReport.mvpUser.avatar} className="w-full h-full object-cover"/>
                                    <div className="absolute bottom-0 left-0 right-0 bg-yellow-400 text-white text-[9px] font-black py-0.5">MVP</div>
                                </div>
                                <div className="font-black text-[#59584D] text-lg">{weeklyReport.mvpUser.username}</div>
                                <div className="text-xs font-bold text-gray-400">æœ¬å‘¨å®Œæˆäº† {weeklyReport.maxScore} ä¸ªä»»åŠ¡ï¼Œè¾›è‹¦å•¦ï¼</div>
                            </div>
                        ) : (
                            <CabinEmptyState icon="ğŸ…" text="æœ¬å‘¨è¿˜æ²¡æœ‰äº§ç”Ÿå®¶åŠ¡ä¹‹æ˜Ÿå“¦" />
                        )}

                        {/* æ´»è·ƒåº¦æŸ±çŠ¶å›¾ - ä¼˜åŒ–å¸ƒå±€ */}
                        <div className="nook-card p-5">
                            <h4 className="text-xs font-bold text-gray-400 mb-4 ml-1">æ´»è·ƒåº¦ç»Ÿè®¡ (ä»»åŠ¡å®Œæˆæ•°)</h4>
                            <div className="flex items-end justify-around gap-2 h-32 px-2 pb-2">
                                {weeklyReport?.chartData.map(d => {
                                    const heightPercent = d.score > 0 ? (d.score / weeklyReport.chartMax) * 100 : 5;
                                    return (
                                        <div key={d.name} className="flex flex-col items-center justify-end h-full w-10 group">
                                            <div className="text-[10px] font-black text-[#3DAA86] mb-1 opacity-0 group-hover:opacity-100 transition-opacity">{d.score}</div>
                                            <div className="w-full bg-[#3DAA86] rounded-t-lg transition-all duration-1000 ease-out relative group-hover:bg-[#2F855A]" style={{height: `${heightPercent}%`}}></div>
                                            <div className="w-8 h-8 rounded-full border-2 border-white shadow-sm overflow-hidden -mt-3 z-10">
                                                <img src={d.avatar} className="w-full h-full object-cover"/>
                                            </div>
                                            <span className="text-[8px] font-bold text-gray-500 mt-1 truncate max-w-full">{d.name}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            case 'starjar':
                 return (
                    <div className="flex flex-col flex-1 min-h-0 animate-pop h-full relative">
                        <DetailHeader title="æ˜Ÿæ˜Ÿç“¶" icon={Icons.Star} color="#FF9F43" />
                        
                        {cabin && members.length > 1 && (
                             <div className='flex flex-wrap gap-2 mb-4 items-center shrink-0 justify-center'>
                                <span className='text-xs font-bold text-gray-500 shrink-0'>å‘é€ç»™ï¼š</span>
                                {members.filter(m => m.id !== user.id).map(m => (
                                    <button 
                                        key={m.id} 
                                        onClick={() => setRecipientId(m.id)} 
                                        className={`text-xs font-black px-3 py-1 rounded-full transition-all ${recipientId === m.id ? 'bg-[#FF9F43] text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-white'}`}
                                    >
                                        {m.username}
                                    </button>
                                ))}
                            </div>
                        )}

                        <div className='grid grid-cols-1 md:grid-cols-2 gap-3 flex-1'>
                            {/* A. å‘é€æ˜Ÿæ˜ŸåŒºåŸŸ */}
                            <div className='nook-card p-4 border-2 border-dashed border-[#FF9F43] text-center relative overflow-hidden flex flex-col justify-center min-h-[180px]'>
                                <div className='text-[10px] font-black text-gray-400 mb-3'>ä½ çš„æ€å¿µï¼ˆå·²å‘é€ï¼‰</div>
                                <div className='text-6xl font-black text-[#FF9F43] mb-4'>
                                    {recipientId && recipientId !== user.id ? (mySentStars.find(s => s.recipientId === recipientId)?.stars || 0) : '0'}
                                </div>
                                
                                <button 
                                    onClick={handleAddStar} 
                                    disabled={!recipientId || recipientId === user.id} 
                                    className="nook-btn w-full bg-[#FF9F43] shadow-[0_5px_0_#E67E22] py-3 text-sm flex items-center justify-center gap-2"
                                >
                                    <Icon path={Icons.Star} size={16}/> æ”¾ä¸€é¢—æ˜Ÿæ˜Ÿ
                                </button>
                            </div>
                            
                            {/* B. æ¥æ”¶æ˜Ÿæ˜ŸåŒºåŸŸ */}
                            <div className='nook-card p-4 border-2 border-dashed border-[#667EEA] relative overflow-hidden flex flex-col min-h-[180px]'>
                                <div className='text-[10px] font-black text-gray-400 mb-1'>Taä»¬æƒ³ä½ äº†ï¼ˆæ”¶ä»¶ç®±ï¼‰</div>
                                <div className='flex-1 overflow-y-auto space-y-2 pt-2'>
                                    {myReceivedStars.filter(s => s.stars > 0).length === 0 ? (
                                        <p className='text-xs text-gray-500'>ç“¶å­ç©ºç©ºçš„... Taä»¬å¯èƒ½åœ¨å¿™å“¦ã€‚</p>
                                    ) : (
                                        myReceivedStars.filter(s => s.stars > 0).map(s => {
                                            const sender = members.find(m => m.id === s.senderId);
                                            if (!sender) return null;
                                            return (
                                                <div key={s.senderId} className='flex justify-between items-center bg-indigo-50/50 p-2 rounded-lg animate-pop'>
                                                    <span className='text-sm font-black text-[#59584D]'>{sender.username}</span>
                                                    <div className='flex items-center gap-2'>
                                                        <span className='text-xl font-black text-[#667EEA]'>{s.stars}</span>
                                                        <button onClick={() => handleClearStars(s.senderId, s.stars)} className='bg-[#667EEA] text-white px-3 py-1 rounded-full text-xs font-bold active:scale-95 transition-all'>
                                                            æ”¶ä¸‹
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            default: 
                return <CabinEmptyState icon="â“" text="åº”ç”¨åŠ è½½é”™è¯¯æˆ–é¡µé¢ä¸å­˜åœ¨" />;
        }
    };


    // --- ä¸»æ¸²æŸ“é€»è¾‘ ---
    
    // å¦‚æœé€‰ä¸­äº†æ¨¡å—ï¼Œæ¸²æŸ“æ¨¡å—è¯¦æƒ…é¡µ
    if (activeModule) {
        return (
            <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
                <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-4">
                    {renderModuleDetail()}
                </div>
                {/* åº•éƒ¨é€€å‡ºå°å±‹æŒ‰é’® */}
                <div className="pt-4 pb-6">
                    <button onClick={()=>{if(confirm("ç¡®å®šè¦é€€å‡ºå°å±‹å—ï¼Ÿ")) leaveCabin();}} className="w-full text-center text-xs text-red-400 font-bold opacity-60 hover:opacity-100 transition-opacity py-3 bg-red-50/50 rounded-xl">é€€å‡ºå½“å‰å°å±‹</button>
                </div>
            </div>
        );
    }


    // æ¸²æŸ“æ¨¡å—æ¦‚è§ˆæ¡Œé¢ (Dashboard)
    return (
        <div className="flex flex-col flex-1 min-h-0 screen-enter h-full relative">
            
            {/* é¡¶éƒ¨æ ‡é¢˜åŒº - ä¿æŒä¸å˜ */}
            <div className="shrink-0 space-y-3 mb-4">
                <div className="bg-[#FF9F43] rounded-[28px] text-white p-5 shadow-xl relative overflow-hidden">
                    <div className="relative z-10 flex justify-between items-start">
                        <div>
                            <h2 className="text-2xl font-black leading-tight">{cabin.name}</h2>
                            <div className="text-[10px] font-bold opacity-80 mt-1 flex items-center gap-1">
                                é‚€è¯·ç : <span onClick={() => { navigator.clipboard.writeText(cabin.code); showFeedback('é‚€è¯·ç å·²å¤åˆ¶ï¼'); }} className="bg-white/20 px-2 py-0.5 rounded select-all font-mono tracking-widest cursor-pointer hover:bg-white/40 active:scale-95 transition-all">{cabin.code}</span>
                            </div>
                        </div>
                        <div className='flex flex-col items-center gap-1'>
                            <button onClick={fetchMembers} className={`p-2 rounded-full bg-white/30 hover:bg-white/50 active:scale-90 transition-all ${isRefreshing?'animate-spin':''}`} title="åˆ·æ–°æˆå‘˜"><Icon path={Icons.Refresh} size={16} className="text-white"/></button>
                            <span className="text-xs font-bold bg-white/30 px-2 py-0.5 rounded-full">{memberCount}äºº</span>
                        </div>
                    </div>
                    <div className="absolute -right-4 -bottom-8 text-white opacity-10 pointer-events-none"><Icon path={Icons.Home} size={100}/></div>
                </div>
            </div>

            {/* æˆå‘˜çŠ¶æ€ & çŠ¶æ€åˆ‡æ¢é¢æ¿ - ä¿æŒä¸å˜ */}
            <div className="bg-white/60 p-2 rounded-xl backdrop-blur-sm shadow-sm flex items-center gap-2 overflow-x-auto no-scrollbar relative mb-4 shrink-0">
                <span className="text-xs font-black text-gray-500 shrink-0 ml-1">åœ¨çº¿ï¼š</span>
                {members.map(m => (
                    <div key={m.id} className="flex flex-col items-center shrink-0 w-12 relative group">
                        <div 
                            className={`w-10 h-10 rounded-full border-2 shadow-sm overflow-hidden bg-gray-200 cursor-pointer transition-transform hover:scale-105 ${m.id===user.id?'border-[#3DAA86] ring-2 ring-[#3DAA86]/30': 'border-white'}`} 
                            onClick={() => m.id === user.id ? setShowStatusMenu(!showStatusMenu) : showFeedback(`${m.username} å½“å‰çŠ¶æ€ï¼š${STATUS_OPTIONS.find(s => s.id === m.status)?.label || 'åœ¨çº¿'}`, 'success')}
                        >
                            <img src={m.avatar} className="w-full h-full object-cover"/>
                        </div>
                        <div className="absolute -bottom-1 -right-1 bg-white rounded-full text-[10px] shadow-sm leading-none p-0.5 border border-gray-100">{getStatusIcon(m.status)}</div>
                        <span className="text-[9px] font-bold text-[#59584D] truncate w-full text-center mt-1">{m.username}</span>
                    </div>
                ))}
                
                {/* çŠ¶æ€åˆ‡æ¢æ°”æ³¡ */}
                {showStatusMenu && (
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-full mb-2 bg-white rounded-xl shadow-xl p-2 z-50 flex flex-wrap gap-2 animate-pop border-4 border-[#3DAA86] after:content-[''] after:absolute after:bottom-[-8px] after:left-1/2 after:-translate-x-1/2 after:w-0 after:h-0 after:border-l-[10px] after:border-r-[10px] after:border-t-[10px] after:border-t-[#3DAA86] after:border-l-transparent after:border-r-transparent">
                        <div className='absolute inset-1 rounded-lg border-2 border-dashed border-gray-200 pointer-events-none'></div>
                        {STATUS_OPTIONS.map(s => (
                            <button key={s.id} onClick={()=>handleChangeStatus(s)} className="text-xl hover:scale-110 transition-transform p-1.5 rounded-full hover:bg-gray-50" title={s.label}>
                                {s.icon}
                            </button>
                        ))}
                    </div>
                )}
            </div>

            {/* --- æ¨¡å—åŒ–æ¡Œé¢ (æ ¸å¿ƒå†…å®¹) --- */}
            <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-4">
                
                {/* 1. æ ¸å¿ƒæ•°æ®æ¦‚è§ˆ (å‘¨æŠ¥æ‘˜è¦) */}
                <div className="nook-card border-l-8 border-[#805AD5] p-4">
                    <div className='flex justify-between items-center mb-2'>
                        <h4 className='text-xs font-black text-gray-400'>å²›åŠ¡å‘¨æŠ¥æ‘˜è¦</h4>
                        <button onClick={() => setActiveModule('report')} className='text-[10px] font-bold text-[#805AD5] transition'>å®Œæ•´æŠ¥å‘Š â†’</button>
                    </div>
                    <div className='grid grid-cols-3 text-center'>
                        <div><div className='text-xl font-black text-[#3DAA86]'>{weeklyReport?.totalCompleted}</div><div className='text-[10px] text-gray-500'>ä»»åŠ¡å®Œæˆ</div></div>
                        <div><div className='text-xl font-black text-[#D69E2E]'>{weeklyReport?.totalSpent?.toLocaleString()}</div><div className='text-[10px] text-gray-500'>æœ¬å‘¨èŠ±è´¹</div></div>
                        <div><div className='text-xl font-black text-purple-500'>{(weeklyReport?.mvpUser ? weeklyReport.maxScore : 0)}</div><div className='text-[10px] text-gray-500'>MVP è´¡çŒ®</div></div>
                    </div>
                </div>

                {/* 2. æ¨¡å—æŠ½å±‰ (Widget Grid) */}
                <h4 className='text-xs font-black text-gray-500 ml-2 mt-4'>åŠŸèƒ½æ¨¡å—</h4>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {MODULE_LIST.filter(m => m.id !== 'report').map(item => (
                        <CabinWidget 
                            key={item.id} 
                            id={item.id}
                            label={item.l}
                            icon={item.i}
                            color={item.c}
                            count={item.count}
                            onClick={() => setActiveModule(item.id)}
                            isActive={activeModule === item.id}
                        />
                    ))}
                </div>

                {/* 3. é€€å‡ºå°å±‹ */}
                <div className="pt-4 pb-6">
                    <button onClick={()=>{if(confirm("ç¡®å®šè¦é€€å‡ºå°å±‹å—ï¼Ÿ")) leaveCabin();}} className="w-full text-center text-xs text-red-400 font-bold opacity-60 hover:opacity-100 transition-opacity py-3 bg-red-50/50 rounded-xl">é€€å‡ºå½“å‰å°å±‹</button>
                </div>
            </div>
            
        </div>
    );
};

// é€šç”¨ç©ºçŠ¶æ€ç»„ä»¶ - å…¨å±€å®šä¹‰
const CabinEmptyState = ({ icon, text }) => (
    <div className="text-center text-gray-400 py-10 text-xs font-bold opacity-60 flex flex-col items-center gap-2 bg-white/50 rounded-xl">
        <div className="text-3xl grayscale opacity-50">{icon}</div> 
        {text}
    </div>
);

// ç¡®ä¿ GyroidIcon å’Œ CabinEmptyState åœ¨æ­¤ä¹‹å‰å®šä¹‰ (å·²åœ¨æ‚¨çš„æ–‡ä»¶ä¸­ç¡®è®¤)



// å°† App ç»„ä»¶å’Œæ¸²æŸ“é€»è¾‘æ”¾åœ¨è¿™é‡Œï¼Œä»¥æ›¿æ¢åŸå§‹æ–‡ä»¶æœ«å°¾çš„å†…å®¹
const App = () => {
    const [localUser, setLocalUser] = useState(null); 
    const [userDoc, setUserDoc] = useState(null);
    
    const [stats, setStats] = useState(null);
    const [tasks, setTasks] = useState([]);
    const [ledger, setLedger] = useState([]);
    const [fitProfile, setFitProfile] = useState(null);
    const [fitLogs, setFitLogs] = useState([]);
    const [voiceWorks, setVoiceWorks] = useState([]);
    const [wikiItems, setWikiItems] = useState([]);
    const [passport, setPassport] = useState(null);
    const [shoppingItems, setShoppingItems] = useState([]);
    const [decisionOptions, setDecisionOptions] = useState([]);
    
    const [messages, setMessages] = useState([]);
    const [projects, setProjects] = useState([]);
    const [inventory, setInventory] = useState([]); 
	const [starJar, setStarJar] = useState([]);

    const [cabin, setCabin] = useState(null);
    const [memberCount, setMemberCount] = useState(1);
    
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isCoreLoading, setIsCoreLoading] = useState(true);
    const [isSyncing, setIsSyncing] = useState(false); 
    const [currentApp, setCurrentApp] = useState(null);
    const [currentTime, setCurrentTime] = useState(new Date());
    const [resetStep, setResetStep] = useState(0);
    const [feedback, setFeedback] = useState(null);
    const [fetchError, setFetchError] = useState(null);

    useEffect(() => { const t = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(t); }, []);
    
    const fetchData = useCallback(async (currentUser, isFullRefresh = false) => {
        if (!currentUser) {
            setUserDoc(null); setStats(null); setTasks([]); setLedger([]); 
            setFitProfile(null); setFitLogs([]); setVoiceWorks([]); setWikiItems([]); setPassport(null); setShoppingItems([]); setDecisionOptions([]); setCabin(null); setMessages([]); setProjects([]); setInventory([]);
            setIsCoreLoading(false);
            return;
        }

        if (isFullRefresh) setIsCoreLoading(true); else setIsSyncing(true);
        setFetchError(null);
        
        try {
            await currentUser.fetch(); 
            const cabinPointer = currentUser.get('cabin');
            let cabinData = null;
            let count = 1;

            if (cabinPointer) {
                try {
                    const cObj = await cabinPointer.fetch();
                    cabinData = simplify(cObj);
                    const countQuery = new AV.Query('_User');
                    countQuery.equalTo('cabin', cabinPointer);
                    count = await countQuery.count(); 
                } catch(e) { console.log("Fetch cabin info failed (non-critical)", e); }
            }
            setCabin(cabinData);
            setMemberCount(count);

            const getOne = async (className) => { try { return await new AV.Query(className).equalTo('user', currentUser).first(); } catch (e) { return null; } };
            const [statsObj, passportObj, fitObj] = await Promise.all([ getOne('NookStats'), getOne('NookPassport'), getOne('NookFitProfile') ]);

            let finalStats = statsObj;
            if (!finalStats) {
                const S = AV.Object.extend('NookStats'); const s = new S(); s.set('user', currentUser); s.set('level', 1); s.set('miles', 500); s.set('pocket', 3000); s.set('savings', 50000); s.set('xp', 0); s.set('loan', 98000);
                try { finalStats = await s.save(); } catch(e){}
            } else if (finalStats.get('loan') === undefined) { finalStats.set('loan', 0); }

            setUserDoc({ id: currentUser.id, username: currentUser.getUsername(), email: currentUser.getEmail(), avatar: currentUser.get('avatar') || AVATAR_LIBRARY[0], themeId: currentUser.get('themeId') || 'nook', status: currentUser.get('status') || 'online' });
            setStats(simplify(finalStats));
            setPassport(simplify(passportObj));
            setFitProfile(simplify(fitObj));
            setIsCoreLoading(false); 

            // --- åˆ—è¡¨æŸ¥è¯¢ ---
            const getList = async (className) => {
                try {
                    const qUser = new AV.Query(className).equalTo('user', currentUser);
                    let finalQuery = qUser;
                    if (cabinPointer) {
                        const qCabin = new AV.Query(className).equalTo('cabin', cabinPointer);
                        finalQuery = AV.Query.or(qUser, qCabin);
                    }
                    return await finalQuery.limit(100).descending('createdAt').find();
                } catch (e) { return []; }
            };

            const [tasksObjs, ledgerObjs] = await Promise.all([ getList('NookTask'), getList('NookLedger') ]);
            await new Promise(r => setTimeout(r, 100));
            const [fitLogsObjs, voiceObjs, wikiObjs, shoppingObjs, decisionObjs] = await Promise.all([ getList('NookFitLog'), getList('NookVoiceWork'), getList('NookWiki'), getList('NookShoppingItem'), getList('NookDecisionOption') ]);
            
            // --- ç‹¬ç«‹æ‹‰å–æ–°è¡¨ (å®¹é”™) ---
            // åœ¨ fetchData ä¸­ï¼Œç¡®ä¿æ‰€æœ‰å±€éƒ¨å˜é‡éƒ½è¢«æ­£ç¡®åˆå§‹åŒ–
            // --- ç‹¬ç«‹æ‹‰å–æ–°è¡¨ (å®¹é”™) ---
            let msgObjs = [], projObjs = [], invObjs = [], starJarObjs = []; // <-- ã€ä¿®æ­£ã€‘ç¡®ä¿ starJarObjs è¢«å£°æ˜
            if (cabinPointer) {
                try { msgObjs = await new AV.Query('NookMessage').equalTo('cabin', cabinPointer).descending('createdAt').limit(20).find(); } catch(e){}
                try { projObjs = await new AV.Query('NookProject').equalTo('cabin', cabinPointer).descending('createdAt').find(); } catch(e){}
                try { invObjs = await new AV.Query('NookInventoryItem').equalTo('cabin', cabinPointer).limit(100).find(); } catch(e){}
                try { starJarObjs = await new AV.Query('NookStarJar').equalTo('cabin', cabinPointer).find(); } catch(e){} // æ‹‰å–æ˜Ÿæ˜Ÿç“¶æ•°æ®
            }
            
            // ...
            // ç¡®ä¿ starJarObjs åœ¨è®¾ç½®çŠ¶æ€æ—¶è¢«æ­£ç¡®ä½¿ç”¨ï¼š
            // ...
            setInventory(invObjs.map(i => ({ ...simplify(i), cabinId: i.get('cabin')?.id }))); 
            setStarJar(starJarObjs.map(s => ({ ...simplify(s), cabinId: s.get('cabin')?.id }))); // ã€ä¿®æ­£ã€‘
            // ...

            const simplifyWithExtra = (obj) => {
                const simple = simplify(obj); if (!simple) return null;
                const cPtr = obj.get('cabin'); if (cPtr) simple.cabinId = cPtr.id;
                simple.completedBy = obj.get('completedBy') || [];
                simple.checkedBy = obj.get('checkedBy') || [];
                return simple;
            };

            setTasks(tasksObjs.map(simplifyWithExtra));
            setLedger(ledgerObjs.map(simplify)); 
            setFitLogs(fitLogsObjs.map(simplify));
            setVoiceWorks(voiceObjs.map(simplify));
            setWikiItems(wikiObjs.map(simplifyWithExtra));
            setShoppingItems(shoppingObjs.map(simplifyWithExtra));
            setDecisionOptions(decisionObjs.map(simplify));
            
            setMessages(msgObjs.map(m => ({ ...simplify(m), cabinId: m.get('cabin')?.id, author: m.get('authorName') })));
            setProjects(projObjs.map(p => ({ ...simplify(p), cabinId: p.get('cabin')?.id })));
            setInventory(invObjs.map(i => ({ ...simplify(i), cabinId: i.get('cabin')?.id })));
			setStarJar(starJarObjs.map(s => ({ ...simplify(s), cabinId: s.get('cabin')?.id })));

        } catch (e) { console.error("Fetch Error", e); setFetchError("åŒæ­¥éƒ¨åˆ†æ•°æ®é‡åˆ°æ³¢åŠ¨ï¼Œè¯·é‡è¯•"); } 
        finally { setIsCoreLoading(false); setIsSyncing(false); }
    }, []);

    useEffect(() => {
        if (typeof AV === 'undefined') { setIsAuthReady(true); return; }
        const currentUser = AV.User.current();
        if (currentUser) {
            currentUser.isAuthenticated().then(auth => {
                if(auth) { setLocalUser(currentUser); fetchData(currentUser, true); } 
                else { AV.User.logOut(); setLocalUser(null); }
                setIsAuthReady(true);
            });
        } else { setIsAuthReady(true); }
    }, [fetchData]);

    const handleAuthSuccess = useCallback((userData) => { setLocalUser(userData); fetchData(userData, true); }, [fetchData]);
    const updateTheme = async (id) => { if(!localUser) return; const r = document.documentElement.style; const t = THEMES.find(x => x.id === id) || THEMES[0]; r.setProperty('--theme-bg', t.bg); r.setProperty('--theme-primary', t.primary); r.setProperty('--theme-text', t.text); r.setProperty('--theme-btn-shadow', t.shadow); setUserDoc(prev => ({...prev, themeId: id})); localUser.set('themeId', id); await localUser.save(); };
    const changeAvatar = async (url) => { setUserDoc(prev => ({ ...prev, avatar: url })); try { const user = AV.User.current(); if (user) { user.set('avatar', url); await user.save(); showFeedback("è¯ä»¶ç…§å·²æ›´æ–°"); setLocalUser(user); } } catch (e) { showFeedback("å¤´åƒä¿å­˜å¤±è´¥", "error"); } };
    useEffect(() => { if (userDoc && userDoc.themeId) { const r = document.documentElement.style; const t = THEMES.find(x => x.id === userDoc.themeId) || THEMES[0]; r.setProperty('--theme-bg', t.bg); r.setProperty('--theme-primary', t.primary); r.setProperty('--theme-text', t.text); r.setProperty('--theme-btn-shadow', t.shadow); } }, [userDoc]);
    const showFeedback = useCallback((message, type='success') => { setFeedback({ message, type, id: Date.now() }); }, []);
    const handleLogout = () => { AV.User.logOut(); setLocalUser(null); setCurrentApp(null); setUserDoc(null); fetchData(null); };

    // ================= åŠ¨ä½œé›†åˆ =================
    const cabinActions = {
        createCabin: async (name) => { const Cabin = AV.Object.extend('NookCabin'); const c = new Cabin(); const code = Math.floor(100000 + Math.random() * 900000).toString(); c.set('name', name); c.set('code', code); c.set('owner', localUser); try { const savedCabin = await c.save(); localUser.set('cabin', savedCabin); await localUser.save(); setCabin(simplify(savedCabin)); setMemberCount(1); showFeedback("å°å±‹åˆ›å»ºæˆåŠŸï¼"); } catch(e) { showFeedback("åˆ›å»ºå¤±è´¥", "error"); } },
        joinCabin: async (code) => { const q = new AV.Query('NookCabin'); q.equalTo('code', code); try { const foundCabin = await q.first(); if (!foundCabin) return alert("æ‰¾ä¸åˆ°è¯¥é‚€è¯·ç "); localUser.set('cabin', foundCabin); await localUser.save(); setCabin(simplify(foundCabin)); showFeedback("æ¬¢è¿å…¥ä½ï¼"); fetchData(localUser, false); } catch(e) { showFeedback("åŠ å…¥å¤±è´¥", "error"); } },
        leaveCabin: async () => { localUser.unset('cabin'); try { await localUser.save(); setCabin(null); setMemberCount(1); showFeedback("å·²é€€å‡ºå°å±‹"); fetchData(localUser, false); } catch(e) { showFeedback("é€€å‡ºå¤±è´¥", "error"); } },
        addMessage: async (content, cabinId) => {
            const Msg = AV.Object.extend('NookMessage'); const m = new Msg();
            m.set('content', content); m.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId)); m.set('author', localUser); m.set('authorName', localUser.getUsername());
            const optim = { id: 'temp'+Date.now(), content, author: localUser.getUsername(), createdAt: new Date().toISOString(), cabinId };
            setMessages(prev => [optim, ...prev]);
            try { await m.save(); } catch(e){ console.log(e); }
        },
        createProject: async (title, goal, cabinId) => {
            const Proj = AV.Object.extend('NookProject'); const p = new Proj();
            p.set('title', title); p.set('goal', goal); p.set('current', 0); p.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId));
            const optim = { id: 'temp'+Date.now(), title, goal, current: 0, cabinId };
            setProjects(prev => [optim, ...prev]);
            try { const saved = await p.save(); setProjects(prev => prev.map(x => x.id === optim.id ? { ...simplify(saved), cabinId } : x)); } catch(e){}
        },
        donateProject: async (pid, amount, source) => {
            const proj = projects.find(p => p.id === pid); if(!proj) return;
            if ((source==='pocket' ? stats.pocket : stats.savings) < amount) return showFeedback("ä½™é¢ä¸è¶³ï¼", "error");
            
            setProjects(prev => prev.map(p => p.id === pid ? { ...p, current: p.current + amount } : p));
            const newStats = { ...stats }; newStats[source] -= amount; setStats(newStats);
            
            const tempLedgerId = 'temp_l_' + Date.now();
            const optimLedger = { id: tempLedgerId, type: 'expense', amount: amount, category: 'å‹Ÿæ', note: `æèµ ç»™: ${proj.title}`, date: new Date().toLocaleDateString(), timestamp: Date.now() };
            setLedger(prev => [optimLedger, ...prev]);

            try {
                const pObj = AV.Object.createWithoutData('NookProject', pid); pObj.increment('current', amount);
                const sObj = AV.Object.createWithoutData('NookStats', stats.id); sObj.increment(source, -amount);
                const Ledger = AV.Object.extend('NookLedger'); const lObj = new Ledger(); lObj.set('user', localUser); lObj.set('type', 'expense'); lObj.set('amount', amount); lObj.set('category', 'å‹Ÿæ'); lObj.set('note', `æèµ ç»™: ${proj.title}`); lObj.set('date', new Date().toLocaleDateString()); lObj.set('timestamp', Date.now());
                await AV.Object.saveAll([pObj, sObj, lObj]);
                setLedger(prev => prev.map(x => x.id === tempLedgerId ? simplify(lObj) : x));
                showFeedback("æèµ æˆåŠŸï¼å·²è®°è´¦ã€‚");
            } catch(e) { console.error(e); }
        },
        updateStatus: async (statusId) => { localUser.set('status', statusId); try { await localUser.save(); setUserDoc(prev => ({...prev, status: statusId})); } catch(e){} },
        
        // [æ–°å¢] åº“å­˜ç®¡ç†
        addInventory: async (name, qty, date, cabinId) => {
            const Inv = AV.Object.extend('NookInventoryItem'); const i = new Inv();
            i.set('name', name); i.set('quantity', qty); i.set('expire', date); i.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId));
            const optim = { id: 'temp'+Date.now(), name, quantity: qty, expire: date, cabinId };
            setInventory(prev => [optim, ...prev]);
            try { const saved = await i.save(); setInventory(prev => prev.map(x => x.id === optim.id ? { ...simplify(saved), cabinId } : x)); } catch(e){}
        },
        updateInventory: async (id, qty) => {
            setInventory(prev => prev.map(i => i.id === id ? { ...i, quantity: qty } : i));
            try { const obj = AV.Object.createWithoutData('NookInventoryItem', id); obj.set('quantity', qty); await obj.save(); } catch(e){}
        },
        deleteInventory: async (id) => {
            setInventory(prev => prev.filter(i => i.id !== id));
            try { const obj = AV.Object.createWithoutData('NookInventoryItem', id); await obj.destroy(); } catch(e){}
        }
    };
	// ... (cabinActions ç»“æŸ)
	
	// â†“â†“â†“ ã€æ–°å¢ã€‘æ˜Ÿæ˜Ÿç“¶åŠ¨ä½œ â†“â†“â†“
	const starJarActions = {
	    // å¢åŠ æ˜Ÿæ˜Ÿï¼šA æƒ³ B äº†
	    addStar: async (recipientId, cabinId) => {
	        const senderId = localUser.id;
	        const StarJar = AV.Object.extend('NookStarJar');
	        
	        // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºæ˜Ÿæ˜Ÿç“¶è®°å½•
	        const q = new AV.Query('NookStarJar');
	        q.equalTo('cabin', AV.Object.createWithoutData('NookCabin', cabinId));
	        q.equalTo('senderId', senderId);
	        q.equalTo('recipientId', recipientId);
	
	        let starObj = await q.first();
	
	        if (!starObj) {
	            starObj = new StarJar();
	            starObj.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId));
	            starObj.set('senderId', senderId);
	            starObj.set('recipientId', recipientId);
	            starObj.set('stars', 0);
	        }
	
	        starObj.increment('stars', 1);
	        starObj.set('lastSentAt', Date.now()); 
	
	        // 2. ä¹è§‚æ›´æ–° UI
	        const optim = simplify(starObj);
	        optim.stars = (starObj.get('stars') || 0) + 1;
	
	        setStarJar(prev => {
	            const index = prev.findIndex(s => s.senderId === senderId && s.recipientId === recipientId);
	            if (index !== -1) {
	                return prev.map((s, i) => i === index ? optim : s);
	            }
	            return [...prev, optim];
	        });
	
	        try {
	            await starObj.save();
	        } catch(e) {
	            console.error("ä¿å­˜æ˜Ÿæ˜Ÿå¤±è´¥", e);
	            showFeedback("æ˜Ÿæ˜Ÿæœªèƒ½ä¿å­˜åˆ°äº‘ç«¯", "error");
	        }
	    },
	    
	    // æ¸…ç©ºæ˜Ÿæ˜Ÿï¼šB çœ‹åˆ°æ˜Ÿæ˜Ÿå¹¶æ”¶ä¸‹
	    clearStars: async (recipientId, senderId, cabinId) => {
	        const q = new AV.Query('NookStarJar');
	        q.equalTo('cabin', AV.Object.createWithoutData('NookCabin', cabinId));
	        q.equalTo('senderId', senderId);
	        q.equalTo('recipientId', recipientId);
	        
	        const starObj = await q.first();
	        if (!starObj) return;
	
	        // 1. ä¹è§‚æ›´æ–° UI
	        setStarJar(prev => prev.map(s => 
	            s.senderId === senderId && s.recipientId === recipientId ? { ...s, stars: 0 } : s
	        ));
	
	        starObj.set('stars', 0);
	
	        try {
	            await starObj.save();
	            showFeedback("æ˜Ÿæ˜Ÿå·²æ”¶ä¸‹ï¼");
	        } catch(e) {
	            console.error("æ¸…ç©ºæ˜Ÿæ˜Ÿå¤±è´¥", e);
	            showFeedback("æ¸…ç©ºå¤±è´¥", "error");
	        }
	    }
	};
	// ...

    const taskActions = {
        addTask: async (title, diff, type, reward, money, calories, cabinId) => { const Task = AV.Object.extend('NookTask'); const t = new Task(); t.set('user', localUser); t.set('title', title); t.set('difficulty', diff); t.set('type', type); t.set('reward', reward); t.set('completed', false); t.set('completedBy', []); if(money) t.set('money', money); if(calories) t.set('calories', calories); t.set('date', new Date().toLocaleDateString()); if (cabinId) t.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId)); const tempId = 'temp_' + Date.now(); const optimTask = { id: tempId, title, difficulty: diff, type, reward, completed: false, completedBy: [], money, calories, timestamp: Date.now(), createdAt: new Date().toISOString(), cabinId }; setTasks(prev => [optimTask, ...prev]); try { const saved = await t.save(); setTasks(prev => prev.map(x => x.id === tempId ? { ...simplify(saved), cabinId: saved.get('cabin')?.id, completedBy: [] } : x)); } catch(e) { setTasks(prev => prev.filter(x => x.id !== tempId)); } },
        updateTask: async (id, updates) => { if (id.toString().startsWith('temp_')) return; setTasks(prev => prev.map(t => t.id === id ? { ...t, ...updates } : t)); try { const tObj = AV.Object.createWithoutData('NookTask', id); if(updates.title!==undefined) tObj.set('title', updates.title); if(updates.difficulty!==undefined) tObj.set('difficulty', updates.difficulty); if(updates.type!==undefined) tObj.set('type', updates.type); if(updates.reward!==undefined) tObj.set('reward', updates.reward); if(updates.money!==undefined) { if (updates.money===null) tObj.unset('money'); else tObj.set('money', updates.money); } if(updates.calories!==undefined) { if (updates.calories===null) tObj.unset('calories'); else tObj.set('calories', updates.calories); } if(updates.cabinId!==undefined) { if (updates.cabinId) tObj.set('cabin', AV.Object.createWithoutData('NookCabin', updates.cabinId)); else tObj.unset('cabin'); } await tObj.save(); showFeedback("ä»»åŠ¡å·²æ›´æ–°"); } catch(e) { showFeedback("æ›´æ–°å¤±è´¥", "error"); } },
        deleteTask: async (id) => { if (id.toString().startsWith('temp_')) return; const task = tasks.find(t => t.id === id); if (!task) return; if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return; setTasks(prev => prev.filter(t => t.id !== id)); try { const tObj = AV.Object.createWithoutData('NookTask', id); await tObj.destroy(); showFeedback("ä»»åŠ¡å·²åˆ é™¤"); } catch(e) { showFeedback("åˆ é™¤å¤±è´¥", "error"); } },
        completeTask: async (taskId) => { if (taskId.toString().startsWith('temp_')) return; const task = tasks.find(t => t.id === taskId); if(!task) return; const myId = localUser.id; const oldCompletedBy = task.completedBy || []; if (oldCompletedBy.includes(myId)) return; const newCompletedBy = [...oldCompletedBy, myId]; const isFullyCompleted = task.cabinId ? (newCompletedBy.length >= memberCount) : true; setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completedBy: newCompletedBy, completed: isFullyCompleted } : t)); setStats(prev => ({ ...prev, miles: (prev.miles || 0) + task.reward, xp: (prev.xp || 0) + task.reward })); try { const tObj = AV.Object.createWithoutData('NookTask', taskId); tObj.addUnique('completedBy', myId); if (isFullyCompleted) tObj.set('completed', true); await tObj.save(); const sObj = AV.Object.createWithoutData('NookStats', stats.id); sObj.increment('miles', task.reward); sObj.increment('xp', task.reward); await sObj.save(); } catch(e) { setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completedBy: oldCompletedBy, completed: task.completed } : t)); } }
    };

    const shoppingActions = {
        addItem: async (name, price, type, cabinId) => { const Item = AV.Object.extend('NookShoppingItem'); const i = new Item(); i.set('user', localUser); i.set('name', name); i.set('price', Number(price || 0)); i.set('type', type); i.set('checked', false); i.set('checkedBy', []); if (cabinId) i.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId)); const tempId = 'temp_' + Date.now(); const optim = { id: tempId, name, price: Number(price||0), type, checked: false, checkedBy: [], cabinId }; setShoppingItems(prev => [optim, ...prev]); try { const saved = await i.save(); setShoppingItems(prev => prev.map(x => x.id === tempId ? { ...simplify(saved), cabinId: saved.get('cabin')?.id, checkedBy:[] } : x)); } catch(e) { setShoppingItems(prev => prev.filter(x => x.id !== tempId)); } },
        toggleItem: async (id) => { if (id.toString().startsWith('temp_')) return; const item = shoppingItems.find(x => x.id === id); if(!item) return; const myId = localUser.id; const oldCheckedBy = item.checkedBy || []; let newCheckedBy; let op = ''; if (oldCheckedBy.includes(myId)) { newCheckedBy = oldCheckedBy.filter(uid => uid !== myId); op = 'remove'; } else { newCheckedBy = [...oldCheckedBy, myId]; op = 'add'; } const isFullyChecked = item.cabinId ? (newCheckedBy.length >= memberCount) : (newCheckedBy.length > 0); setShoppingItems(prev => prev.map(x => x.id === id ? { ...x, checkedBy: newCheckedBy, checked: isFullyChecked } : x)); try { const obj = AV.Object.createWithoutData('NookShoppingItem', id); if (op === 'add') obj.addUnique('checkedBy', myId); else obj.remove('checkedBy', myId); obj.set('checked', isFullyChecked); await obj.save(); } catch(e) {} },
        deleteItem: async (id) => { if (id.toString().startsWith('temp_')) return; setShoppingItems(prev => prev.filter(x => x.id !== id)); try { const obj = AV.Object.createWithoutData('NookShoppingItem', id); await obj.destroy(); } catch(e) {} }
    };

    const wikiActionsFull = {
        add: async (title, content, file, cabinId) => { let imageUrl = null; if (file) { try { const avFile = new AV.File(file.name, file); const savedFile = await avFile.save(); imageUrl = savedFile.url(); } catch (e) { return; } } const tempId = 'temp_' + Date.now(); const displayImage = file ? URL.createObjectURL(file) : null; const optim = { id: tempId, title, content, image: displayImage, updatedTimestamp: Date.now(), cabinId }; setWikiItems(prev => [optim, ...prev]); const Wiki = AV.Object.extend('NookWiki'); const w = new Wiki(); w.set('user', localUser); w.set('title', title); w.set('content', content); if (imageUrl) w.set('image', imageUrl); if (cabinId) w.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId)); try { const saved = await w.save(); setWikiItems(prev => prev.map(x => x.id === tempId ? { ...simplify(saved), cabinId: saved.get('cabin')?.id } : x)); showFeedback("ä¿å­˜æˆåŠŸï¼"); } catch(e) {} },
        update: async (id, title, content, file, oldImageUrl, cabinId) => { if (id.toString().startsWith('temp_')) return; let finalImageUrl = oldImageUrl; if (file) { try { const avFile = new AV.File(file.name, file); const savedFile = await avFile.save(); finalImageUrl = savedFile.url(); } catch (e) { return; } } else if (oldImageUrl === null) { finalImageUrl = null; } const displayImage = file ? URL.createObjectURL(file) : finalImageUrl; setWikiItems(prev => prev.map(x => x.id === id ? { ...x, title, content, image: displayImage, updatedTimestamp: Date.now(), cabinId } : x)); try { const w = AV.Object.createWithoutData('NookWiki', id); w.set('title', title); w.set('content', content); if (finalImageUrl) w.set('image', finalImageUrl); else w.unset('image'); if (cabinId) w.set('cabin', AV.Object.createWithoutData('NookCabin', cabinId)); else w.unset('cabin'); await w.save(); showFeedback("å·²æ›´æ–°ï¼"); if (file) URL.revokeObjectURL(displayImage); } catch(e) { showFeedback("æ›´æ–°å¤±è´¥", "error"); } },
        remove: async (id) => { setWikiItems(prev => prev.filter(x => x.id !== id)); try { const obj = AV.Object.createWithoutData('NookWiki', id); await obj.destroy(); } catch(e) {} }
    };

   // ==========================================
   // App ç»„ä»¶ - è®°è´¦åŠ¨ä½œ (ledgerActions) ä¿®æ­£ç‰ˆ
   // ==========================================
   const ledgerActions = {
       // [ä¿®æ”¹] åŸæœ‰çš„ addRecord æ”¯æŒæ–°çš„ isPending æ ‡å¿—
       addRecord: async (type, amount, cat, note, isPending = false) => { 
           const Ledger = AV.Object.extend('NookLedger'); 
           const l = new Ledger(); 
           const numericAmount = Number(amount);
           
           if (isNaN(numericAmount) || numericAmount <= 0) {
               showFeedback("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢", "error");
               return;
           }
   
           l.set('user', localUser); 
           l.set('type', type); 
           l.set('amount', numericAmount); 
           l.set('category', cat); 
           l.set('note', note); 
           l.set('date', new Date().toLocaleDateString()); 
           l.set('timestamp', Date.now()); 
           
           // [æ–°å¢å…³é”®å­—æ®µ]
           if (type === 'income') {
               l.set('isPending', isPending);
               if (isPending) {
                    l.set('isSalary', true); // æ ‡è®°ä¸ºå·¥èµ„æ€§è´¨çš„å¾…ç»“ç®—æ”¶å…¥
               } else {
                    l.set('isSalary', false); // éå¾…ç»“ç®—æ”¶å…¥
               }
           } else {
               l.set('isPending', false); // æ”¯å‡ºæ²¡æœ‰å¾…ç»“ç®—çŠ¶æ€
           }
   
           const tempId = 'temp_' + Date.now(); 
           const optim = { 
               id: tempId, 
               type, 
               amount: numericAmount, 
               category: cat, 
               note, 
               date: new Date().toLocaleDateString(), 
               timestamp: Date.now(),
               isPending: isPending,
               isSalary: (type === 'income' && isPending)
           }; 
           setLedger(prev => [optim, ...prev]); 
           
           try { 
               const saved = await l.save(); 
               setLedger(prev => prev.map(x => x.id === tempId ? simplify(saved) : x)); 
           } catch(e) {
               console.error("è®°è´¦å¤±è´¥:", e);
               setLedger(prev => prev.filter(x => x.id !== tempId));
           }
       }, 
       
       deleteRecord: async (id) => { 
           setLedger(prev => prev.filter(x => x.id !== id)); 
           try { 
               const obj = AV.Object.createWithoutData('NookLedger', id); 
               await obj.destroy(); 
           } catch(e) {} 
       },
   
       // [æ–°å¢] æœˆåº¦å·¥èµ„ç»“ç®—å…¥è´¦
       settleMonthlySalary: async (finalSettlementAmount, recordsToClear) => {
           if (!finalSettlementAmount || finalSettlementAmount <= 0) {
               showFeedback("ç»“ç®—é‡‘é¢å¿…é¡»å¤§äº 0", "error");
               return;
           }
           
           // 1. ä¹è§‚æ›´æ–°ç”¨æˆ·ä½™é¢ (åŠ å…¥åˆ° pocket)
           const newPocket = stats.pocket + finalSettlementAmount;
           const sObj = AV.Object.createWithoutData('NookStats', stats.id);
           sObj.increment('pocket', finalSettlementAmount);
   
           // 2. ä¹è§‚æ›´æ–° Ledger çŠ¶æ€ (æœ¬åœ°æ¸…é›¶)
           setLedger(prev => prev.map(r => 
               recordsToClear.some(s => s.id === r.id) 
               ? { ...r, isPending: false, settledAt: new Date().toISOString() } 
               : r
           ));
   
           // 3. LeanCloud æ‰¹é‡æ›´æ–°å¾…ç»“ç®—è®°å½•
           const ledgerObjectsToSettle = recordsToClear.map(r => {
               const obj = AV.Object.createWithoutData('NookLedger', r.id);
               obj.set('isPending', false);
               obj.set('settledAt', new Date());
               return obj;
           });
           
           // 4. LeanCloud è®°å½•æœ€ç»ˆçš„ç»“ç®—å…¥è´¦è®°å½•ï¼ˆä½œä¸ºå®é™…çš„æ”¶å…¥è®°å½•ï¼‰
           const Ledger = AV.Object.extend('NookLedger'); 
           const actualIncome = new Ledger();
           actualIncome.set('user', localUser);
           actualIncome.set('type', 'income');
           actualIncome.set('amount', finalSettlementAmount);
           actualIncome.set('category', 'æœˆç»“å·¥èµ„');
           actualIncome.set('note', 'å·¥èµ„å…¥è´¦');
           actualIncome.set('date', new Date().toLocaleDateString());
           actualIncome.set('timestamp', Date.now() + 1); // ç¡®ä¿åœ¨ Ledger ä¸­æ’åœ¨æ¸…é›¶è®°å½•ä¹‹å
           actualIncome.set('isPending', false);
           actualIncome.set('isSalary', false);
   
   
           try {
               await AV.Object.saveAll([...ledgerObjectsToSettle, sObj, actualIncome]);
               // ã€é‡è¦ã€‘æœ€ç»ˆæ›´æ–° stats å’Œ ledger
               setStats(prev => ({...prev, pocket: newPocket}));
               setLedger(prev => [...prev.filter(r => !r.id.startsWith('temp_') && !recordsToClear.some(rc => rc.id === r.id)), simplify(actualIncome), ...prev.filter(r => r.id.startsWith('temp_') || recordsToClear.some(rc => rc.id === r.id))]); // ç®€å•æ›´æ–°åˆ—è¡¨
               
               showFeedback(`æœˆå·¥èµ„ ${finalSettlementAmount.toLocaleString()} é“ƒé’±å·²å…¥è´¦ï¼`, "success");
           } catch (e) {
               console.error("ç»“ç®—å¤±è´¥:", e);
               showFeedback("ç»“ç®—å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚", "error");
           }
       }
   };
   const fitnessActions = { updateProfile: async (p) => { setFitProfile(p); try { const f = AV.Object.createWithoutData('NookFitProfile', fitProfile.id); f.set('height', p.height); f.set('weight', p.weight); f.set('age', p.age); f.set('gender', p.gender); await f.save(); } catch(e) {} }, addLog: async (type, val, note) => { const Log = AV.Object.extend('NookFitLog'); const l = new Log(); l.set('user', localUser); l.set('type', type); l.set('val', val); l.set('note', note); l.set('date', new Date().toLocaleDateString()); l.set('timestamp', Date.now()); l.set('time', new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})); const tempId = 'temp_'+Date.now(); const optim = { id: tempId, type, val, note, date: new Date().toLocaleDateString(), timestamp: Date.now(), time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }; setFitLogs(prev => [optim, ...prev]); try { const saved = await l.save(); setFitLogs(prev => prev.map(x => x.id === tempId ? simplify(saved) : x)); } catch(e) {} } };
    // ... (åœ¨å…¶ä»– actions å®šä¹‰ä¹‹å)
const voiceWorkActions = { 
    addWork: async (title, price) => { 
        const Work = AV.Object.extend('NookVoiceWork'); 
        const w = new Work(); 
        const numericPrice = Number(price);

        w.set('user', localUser); 
        w.set('title', title); 
        w.set('price', numericPrice); 
        w.set('settled', false); 
        
        // ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶ ID è¿›è¡Œä¹è§‚æ›´æ–°
        const tempId = 'temp_'+Date.now(); 
        const optim = { 
            id: tempId, 
            title, 
            price: numericPrice, 
            settled: false, 
            createdAt: new Date().toISOString() 
        }; 
        setVoiceWorks(prev => [optim, ...prev]); 
        
        try { 
            const saved = await w.save(); 
            // æˆåŠŸåï¼Œç”¨çœŸå®çš„ ID æ›¿æ¢ä¸´æ—¶ ID
            setVoiceWorks(prev => prev.map(x => x.id === tempId ? simplify(saved) : x)); 
        } catch(e) {
            console.error("ä¿å­˜å½•éŸ³å·¥ä½œå¤±è´¥", e);
            // å¤±è´¥åï¼Œç§»é™¤ä¹è§‚æ›´æ–°çš„ä¸´æ—¶è®°å½•
            setVoiceWorks(prev => prev.filter(x => x.id !== tempId));
        }
    }, 
    toggleSettled: async (id) => { 
        const w = voiceWorks.find(x => x.id === id); 
        if(!w) return; 
        setVoiceWorks(prev => prev.map(x => x.id === id ? { ...x, settled: !x.settled } : x)); 
        try { 
            const obj = AV.Object.createWithoutData('NookVoiceWork', id); 
            obj.set('settled', !w.settled); 
            await obj.save(); 
        } catch(e) {} 
    }, 
    deleteWork: async (id) => { 
        setVoiceWorks(prev => prev.filter(x => x.id !== id)); 
        try { 
            const obj = AV.Object.createWithoutData('NookVoiceWork', id); 
            await obj.destroy(); 
        } catch(e) {} 
    } 
};
// ...
	const financeActions = { updateStats: async (newStats) => { setStats(prev => ({...prev, ...newStats})); try { const s = AV.Object.createWithoutData('NookStats', stats.id); if(newStats.pocket!==undefined)s.set('pocket', newStats.pocket); if(newStats.savings!==undefined)s.set('savings', newStats.savings); if(newStats.loan!==undefined)s.set('loan', newStats.loan); await s.save(); } catch(e) {} } };
    const decisionActions = { addOption: async (name) => { const Option = AV.Object.extend('NookDecisionOption'); const o = new Option(); o.set('user', localUser); o.set('name', name); const tempId = 'temp_' + Date.now(); const optim = { id: tempId, name }; setDecisionOptions(prev => [optim, ...prev]); try { const saved = await o.save(); setDecisionOptions(prev => prev.map(x => x.id === tempId ? simplify(saved) : x)); } catch(e) {} }, deleteOption: async (id) => { setDecisionOptions(prev => prev.filter(x => x.id !== id)); try { const obj = AV.Object.createWithoutData('NookDecisionOption', id); await obj.destroy(); } catch(e) {} } };
    const passportActions = { updatePassport: async (newPassport) => { setPassport(newPassport); try { const p = AV.Object.createWithoutData('NookPassport', passport.id); p.set('title1', newPassport.title1); p.set('title2', newPassport.title2); p.set('islandName', newPassport.islandName); p.set('fruit', newPassport.fruit); p.set('birthday', newPassport.birthday); p.set('comment', newPassport.comment); await p.save(); showFeedback("æŠ¤ç…§ä¿¡æ¯å·²æ›´æ–°ï¼"); } catch(e) {} } };

    if (!isAuthReady) return <div className="w-full h-full flex flex-col items-center justify-center bg-[#7FE2C3] animate-pop"><div className="w-24 h-24 bg-white rounded-[30px] flex items-center justify-center shadow-lg animate-bounce"><Icon path={Icons.Leaf} size={60} color="#3DAA86"/></div></div>;
    if (resetStep > 0) return (<div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-pop"><div className="nook-card w-full max-w-xs text-center border-4 border-red-500 shadow-2xl"><h2 className="text-xl font-black text-[#59584D] mb-2">{resetStep === 1 ? "ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ" : "æœ€åè­¦å‘Šï¼"}</h2><p className="text-sm text-gray-500 font-bold mb-6">é€€å‡ºåä¸‹æ¬¡éœ€è¦é‡æ–°ç™»å½•ã€‚</p><div className="space-y-3"><button onClick={() => resetStep === 1 ? setResetStep(2) : handleReset()} className="nook-btn w-full bg-red-500">{resetStep === 1 ? "ç¡®å®šé€€å‡º" : "ç¡®è®¤"}</button><button onClick={() => setResetStep(0)} className="nook-btn-secondary w-full">å–æ¶ˆ</button></div></div></div>);
    if (!localUser) return <AuthScreen onAuthSuccess={handleAuthSuccess} />;
    if (isCoreLoading) return <div className="w-full h-full flex flex-col items-center justify-center bg-[#7FE2C3] animate-pop"><div className="w-24 h-24 bg-white rounded-[30px] flex items-center justify-center shadow-lg animate-bounce"><Icon path={Icons.Leaf} size={60} color="#3DAA86"/></div><p className="mt-4 font-bold text-[#59584D] animate-pulse">æ­£åœ¨è¿æ¥ NookPhone ç½‘ç»œ...</p></div>;
    if (fetchError) return (<div className="w-full h-full flex flex-col items-center justify-center bg-[#7FE2C3] p-6 animate-pop"><div className="nook-card w-full max-w-xs text-center shadow-2xl"><div className="text-4xl mb-2">ğŸ“¡</div><h2 className="text-xl font-black text-[#59584D] mb-2">è¿æ¥å—é˜»</h2><p className="text-sm text-gray-500 font-bold mb-4">{fetchError}</p><button onClick={() => fetchData(localUser, true)} className="nook-btn w-full">é‡è¯•è¿æ¥</button></div></div>);
    if (!userDoc || !stats) return null;

    return (
        <div className="w-full h-full flex flex-col items-center justify-center md:p-4 md:transition-all">
            <div className="w-full h-full md:h-[85vh] md:max-w-[520px] md:min-h-[700px] bg-white/20 backdrop-blur-xl md:rounded-[45px] shadow-2xl md:border-[8px] border-white/40 relative overflow-hidden flex flex-col md:transition-all md:duration-500">
                <div className="h-12 flex justify-between items-center px-8 shrink-0 z-20 pt-2 text-[#59584D] select-none">
                    <div className="bg-white/40 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm shadow-sm">{currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    <button onClick={() => !isSyncing && fetchData(localUser, false)} disabled={isSyncing} className={`bg-white/40 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm flex items-center gap-2 shadow-sm transition-all active:scale-95 ${isSyncing ? 'opacity-80' : 'hover:bg-white/60 cursor-pointer'}`}><div className={`w-2 h-2 rounded-full ${isSyncing ? 'bg-yellow-400 animate-ping' : 'bg-blue-400'}`}></div>{isSyncing ? 'åŒæ­¥ä¸­...' : <><Icon path={Icons.Refresh} size={12}/> äº‘ç«¯</>}</button>
                </div>
                <div className="flex-1 overflow-hidden relative p-4 md:p-6">
                    <div className={`absolute inset-0 p-8 grid grid-cols-3 content-start gap-y-8 gap-x-4 md:transition-all md:duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] ${currentApp ? '-translate-x-12 opacity-0 scale-90 pointer-events-none' : 'translate-x-0 opacity-100 scale-100'}`}>
                        <AppIcon icon={Icons.Leaf} label="é›†é‡Œæ¸¸+" onClick={()=>setCurrentApp('miles')}/>
                        <AppIcon icon={Icons.Home} label="Nookå°å±‹" onClick={()=>setCurrentApp('cabin')}/>
                        <AppIcon icon={Icons.Book} label="è®°è´¦æœ¬" onClick={()=>setCurrentApp('ledger')}/>
                        <AppIcon icon={Icons.Activity} label="NookFit" onClick={()=>setCurrentApp('fitness')}/>
                        <AppIcon icon={Icons.ShoppingBag} label="Nookè´­ç‰©" onClick={()=>setCurrentApp('shopping')}/>
                        <AppIcon icon={Icons.CreditCard} label="ABD" onClick={()=>setCurrentApp('finance')}/>
                        <AppIcon icon={Icons.Mic} label="Nookå½•éŸ³" onClick={()=>setCurrentApp('voice')}/> 
                        <AppIcon icon={Icons.Bookmark} label="Nookå°çŸ¥è¯†" onClick={()=>setCurrentApp('wiki')}/> 
                        <AppIcon icon={Icons.Dice} label="Nook Decision" onClick={()=>setCurrentApp('decision')}/>
                        <AppIcon icon={Icons.Radio} label="æ¯æ—¥æ’­æŠ¥" onClick={()=>setCurrentApp('daily')}/> 
                        <AppIcon icon={Icons.User} label="æŠ¤ç…§" onClick={()=>setCurrentApp('passport')}/>
                        <AppIcon icon={Icons.Settings} label="è®¾ç½®" onClick={()=>setCurrentApp('settings')}/>
                    </div>
                    <div className={`absolute inset-0 p-0 md:p-6 md:transition-all md:duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] flex flex-col ${currentApp ? 'translate-y-0 opacity-100 scale-100' : 'translate-y-20 opacity-0 scale-90 pointer-events-none'}`}>
                        <div className="glass-panel w-full h-full rounded-none md:rounded-[35px] shadow-inner flex flex-col p-4 md:p-6 relative overflow-hidden">
                            {feedback && <FeedbackToast key={feedback.id} message={feedback.message} type={feedback.type} onClose={()=>setFeedback(null)} />}
                            
                            {currentApp === 'daily' && <DailyBroadcastApp tasks={tasks} ledger={ledger} fitLogs={fitLogs} voiceWorks={voiceWorks} wikiItems={wikiItems} stats={stats} />} 
                            {currentApp === 'miles' && <NookMilesApp stats={stats} tasks={tasks} showFeedback={showFeedback} cabin={cabin} memberCount={memberCount} {...taskActions}/>}
                            {currentApp === 'cabin' && <CabinApp 
                                user={userDoc} 
                                cabin={cabin} 
                                tasks={tasks} 
                                shoppingItems={shoppingItems} 
                                wikiItems={wikiItems} 
                                messages={messages} 
                                projects={projects} 
                                inventory={inventory} 
                                // â†“â†“â†“ ã€æ–°å¢ Propsã€‘â†“â†“â†“
                                starJar={starJar} 
                                addStar={starJarActions.addStar}
                                clearStars={starJarActions.clearStars}
                                // â†‘â†‘â†‘ ã€æ–°å¢ Propsã€‘â†‘â†‘â†‘
                                showFeedback={showFeedback} 
                                memberCount={memberCount} 
                                stats={stats} 
                                {...cabinActions} 
                            />}
							{currentApp === 'ledger' && <LedgerApp ledger={ledger} showFeedback={showFeedback} {...ledgerActions}/>}
                            {currentApp === 'fitness' && <FitnessApp profile={fitProfile} logs={fitLogs} user={userDoc.username} showFeedback={showFeedback} {...fitnessActions}/>}
                            {currentApp === 'voice' && <VoiceWorkApp voiceWorks={voiceWorks} showFeedback={showFeedback} {...voiceWorkActions}/>} 
                            {currentApp === 'wiki' && <WikiApp items={wikiItems} showFeedback={showFeedback} cabin={cabin} {...wikiActionsFull}/>} 
                            {currentApp === 'finance' && <FinanceApp stats={stats} showFeedback={showFeedback} {...financeActions}/>}
                            {currentApp === 'passport' && <PassportApp user={userDoc} stats={stats} passport={passport} {...passportActions}/>}
                            {currentApp === 'shopping' && <ShoppingApp items={shoppingItems} showFeedback={showFeedback} cabin={cabin} memberCount={memberCount} {...shoppingActions}/>}
                            {currentApp === 'decision' && <DecisionApp options={decisionOptions} showFeedback={showFeedback} {...decisionActions}/>}
                            {currentApp === 'settings' && (<SettingsApp user={userDoc} currentTheme={userDoc.themeId} currentAvatar={userDoc.avatar} changeTheme={updateTheme} changeAvatar={changeAvatar} onReset={()=>setResetStep(1)} onLogout={handleLogout}/>)}
                            <div className="mt-auto pt-2 flex justify-center shrink-0 absolute bottom-4 left-0 right-0 z-40 pointer-events-none"><button onClick={()=>setCurrentApp(null)} className="nook-btn-secondary px-6 py-2 rounded-full font-bold text-sm shadow-lg pointer-events-auto opacity-90 hover:opacity-100 hover:scale-105 transition-all active:scale-95 backdrop-blur-md bg-white/80">è¿”å›æ¡Œé¢</button></div>
                        </div>
                    </div>
                </div>
                <div className="hidden md:flex h-8 w-full justify-center items-center shrink-0 z-20 pb-2"><div className="w-1/3 h-1.5 bg-white/60 rounded-full"></div></div>
            </div>
            <div className="hidden md:block mt-4 text-white/80 font-bold text-xs tracking-widest opacity-80 uppercase">Nook Inc. Cloud OS v7.95 (Multi-User)</div>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);  
    </script>
</body>
</html>