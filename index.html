<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NookPhone OS - NookLink</title>
    
    <meta name="theme-color" content="#7FE2C3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --theme-bg: #7FE2C3;
            --theme-pattern: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' fill='%23ffffff' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
            --theme-primary: #3DAA86; 
            --theme-secondary: #FDFDF6;
            --theme-text: #59584D;
            --theme-btn-shadow: #2D8666;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Varela Round', 'Kosugi Maru', sans-serif;
            background-color: var(--theme-bg);
            background-image: var(--theme-pattern);
            color: var(--theme-text);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.6s ease;
        }

        /* Nook UI Elements */
        .nook-card {
            background-color: #FDFDF6;
            border-radius: 30px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.05), 0 12px 24px rgba(0,0,0,0.05); 
            padding: 20px;
            position: relative;
        }
        
        .nook-btn {
            background-color: var(--theme-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 800;
            box-shadow: 0 6px 0 var(--theme-btn-shadow);
            transition: all 0.1s;
            position: relative;
            top: 0;
        }
        .nook-btn:active { top: 6px; box-shadow: 0 0 0 var(--theme-btn-shadow); }
        .nook-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }

        .nook-btn-secondary {
            background-color: #E0E0E0;
            color: #7A7A7A;
            box-shadow: 0 6px 0 #BDBDBD;
        }
        .nook-btn-secondary:active { top: 6px; box-shadow: none; }

        .nook-input {
            width: 100%;
            background: #F0F0F0;
            border: 2px solid transparent;
            padding: 12px 16px;
            border-radius: 16px;
            font-weight: bold;
            color: #59584D;
            outline: none;
            transition: all 0.2s;
        }
        .nook-input:focus {
            background: #FFFFFF;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 4px rgba(61, 170, 134, 0.2);
        }

        .app-icon {
            width: 64px; height: 64px;
            border-radius: 22px;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .app-icon:active { transform: scale(0.95); }

        .animate-pop { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop-in { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        /* æ»šåŠ¨æ¡éšè—ä½†å¯æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-bar-fill { transition: width 0.5s ease-out; }
        
        /* Toggle Switch */
        .nook-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .nook-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #3DAA86; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const AV = window.AV;

        // --- é…ç½®åŒº ---
        const LEANCLOUD_APP_ID = "Cc5uslAHhf3AdOb6NLsVdNn1-gzGzoHsz"; 
        const LEANCLOUD_APP_KEY = "OQNPvAZWG2bXRm9vTqRL5r8S";
        const LEANCLOUD_SERVER_URL = "https://cc5uslah.lc-cn-n1-shared.com";

        const AVATAR_LIBRARY = [
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2359584D' stroke-width='2'%3E%3Cpath d='M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Zack",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Molly",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Bear",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Leo",
            "https://api.dicebear.com/7.x/notionists/svg?seed=Lola",
            "https://api.dicebear.com/7.x/notionists/svg?seed=Sam"
        ];

        try {
            if (!AV.applicationId) {
                AV.init({ appId: LEANCLOUD_APP_ID, appKey: LEANCLOUD_APP_KEY, serverURLs: LEANCLOUD_SERVER_URL });
            }
        } catch(e) { console.error("AV init error", e); }

        const Icon = ({ path, size=24, color="currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                {path}
            </svg>
        );
        const Icons = {
            Leaf: <><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            CreditCard: <><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></>,
            Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
            Cloud: <><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-3.1-2.9-5.5-6-5.5a6 6 0 0 0-5.6 8H17.5Z"/><path d="M12 2v8"/><path d="m9 7 3-3 3 3"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Book: <><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>,
            Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
            Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
            Check: <><path d="M20 6 9 17l-5-5"/></>,
            Coin: <><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></>,
            ArrowLeft: <><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>,
            Activity: <><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></>,
            Scale: <><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M12 6a6 6 0 0 0 0 12 6 6 0 0 0 0-12zm0 2a4 4 0 0 1 0 8 4 4 0 0 1 0-8z"/><path d="M12 10l2 2"/></>,
            Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
            Refresh: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>,
            Danger: <><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>
        };

        // --- é»˜è®¤æ•°æ® ---
        const DEFAULT_DATA = {
            stats: { level: 1, miles: 500, pocket: 3000, savings: 50000, xp: 500 }, 
            tasks: [
                { id: 1, title: 'åˆæ¬¡æŠµè¾¾', reward: 2, difficulty: 'simple', type: 'ç”Ÿæ´»', completed: false, money: {type: 'income', amount: 500} },
                { id: 2, title: 'å‘ç‹¸å…‹é—®å¥½', reward: 5, difficulty: 'normal', type: 'å·¥ä½œ', completed: false },
            ],
            themeId: 'nook',
            avatar: AVATAR_LIBRARY[0],
            ledger: [],
            fitness: {
                profile: null, // { height, weight, age, gender }
                logs: {} // YYYY-MM-DD: { exercise: 0, intake: 0, weight: 0, records: [] }
            }
        };

        // éš¾åº¦é…ç½®
        const DIFFICULTIES = {
            simple: { label: 'ç®€å•', xp: 2, color: 'bg-green-400', ring: 'ring-green-200' },
            normal: { label: 'æ™®é€š', xp: 5, color: 'bg-blue-400', ring: 'ring-blue-200' },
            hard: { label: 'å›°éš¾', xp: 10, color: 'bg-orange-400', ring: 'ring-orange-200' },
            hell: { label: 'åœ°ç‹±', xp: 20, color: 'bg-purple-500', ring: 'ring-purple-200' }
        };

        const getLevelInfo = (totalXP) => {
            let level = 1;
            let xp = totalXP;
            while (level < 100) {
                const required = level * 256;
                if (xp >= required) { xp -= required; level++; } else { break; }
            }
            return { level, currentXP: xp, requiredXP: level * 256, progress: (xp / (level * 256)) * 100 };
        };

        const AuthScreen = ({ onLogin }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [username, setUsername] = useState("");
            const [password, setPassword] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");

            const handleSubmit = async () => {
                if (!username || !password) return setError("è¯·å¡«å†™è´¦å·å’Œå¯†ç ");
                setLoading(true);
                setError("");
                try {
                    if (isRegister) {
                        const user = new AV.User();
                        user.setUsername(username);
                        user.setPassword(password);
                        user.set('gameData', JSON.stringify(DEFAULT_DATA));
                        await user.signUp();
                        onLogin(user, DEFAULT_DATA);
                    } else {
                        const user = await AV.User.logIn(username, password);
                        let gameData = DEFAULT_DATA;
                        const cloudDataStr = user.get('gameData');
                        if (cloudDataStr) {
                            try { 
                                const parsed = JSON.parse(cloudDataStr);
                                gameData = { ...DEFAULT_DATA, ...parsed };
                                if (!gameData.stats.xp) gameData.stats.xp = gameData.stats.miles;
                                if (!gameData.ledger) gameData.ledger = [];
                                if (!gameData.fitness) gameData.fitness = DEFAULT_DATA.fitness;
                            } catch(e){}
                        }
                        onLogin(user, gameData);
                    }
                } catch (err) {
                    console.error(err);
                    setError(isRegister ? "æ³¨å†Œå¤±è´¥: ç”¨æˆ·åå¯èƒ½å·²å­˜åœ¨" : "ç™»å½•å¤±è´¥: è´¦å·æˆ–å¯†ç é”™è¯¯");
                } finally { setLoading(false); }
            };

            return (
                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-[#7FE2C3] bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTAgNDBMNDAgMEgyMEwwIDIwTTQwIDQwVjIwTDIwIDQwIiBmaWxsPSIjZmZmZmZmIiBmaWxsLW9wYWNpdHk9IjAuMiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+')] animate-pop">
                    <div className="mb-8 flex flex-col items-center">
                        <div className="w-24 h-24 bg-white rounded-[30px] flex items-center justify-center shadow-lg mb-4 transform rotate-3"><Icon path={Icons.Leaf} size={60} color="#3DAA86"/></div>
                        <h1 className="text-3xl font-black text-[#59584D] tracking-wide">NookLink</h1>
                        <p className="text-[#3DAA86] font-bold text-sm bg-white/50 px-3 py-1 rounded-full mt-2 backdrop-blur-sm">{isRegister ? "å±…æ°‘ç™»è®°å¤„" : "æ¬¢è¿å›å®¶"}</p>
                    </div>
                    <div className="nook-card w-full max-w-xs shadow-2xl border-[6px] border-white/40">
                        {error && <div className="bg-red-100 text-red-500 text-xs font-bold p-3 rounded-xl mb-4 text-center border-l-4 border-red-500">{error}</div>}
                        <div className="space-y-4">
                            <div><label className="text-xs font-bold text-gray-500 ml-2 mb-1 block">æŠ¤ç…§åç§° (è´¦å·)</label><input className="nook-input" placeholder="è¾“å…¥æ‚¨çš„åå­—" value={username} onChange={e=>setUsername(e.target.value)}/></div>
                            <div><label className="text-xs font-bold text-gray-500 ml-2 mb-1 block">å¯†ç </label><input className="nook-input" type="password" placeholder="********" value={password} onChange={e=>setPassword(e.target.value)}/></div>
                        </div>
                        <button onClick={handleSubmit} disabled={loading} className="nook-btn w-full mt-6 flex justify-center items-center gap-2">{loading ? "é€šè®¯ä¸­..." : (isRegister ? "åˆ›å»ºæ¡£æ¡ˆ" : "ç«‹å³ç™»å²›")}</button>
                        <div className="mt-4 text-center"><button onClick={() => { setIsRegister(!isRegister); setError(""); }} className="text-xs font-bold text-[#3DAA86] underline decoration-2 underline-offset-2 hover:text-[#2D8666]">{isRegister ? "å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•" : "æ–°å±…æ°‘ï¼Ÿå»åŠç†æŠ¤ç…§"}</button></div>
                    </div>
                    <div className="mt-8 text-white/60 font-bold text-xs">NOOK INC. SECURE LOGIN</div>
                </div>
            );
        };

        const THEMES = [
            { id: 'nook', name: 'Nook ç»å…¸', bg: '#7FE2C3', primary: '#3DAA86', text: '#59584D' },
            { id: 'sakura', name: 'æ¨±èŠ±å­£', bg: '#FFC6D0', primary: '#FF7D9A', text: '#7A4A53' },
            { id: 'summer', name: 'å¤æ—¥è´å£³', bg: '#6AC4F6', primary: '#3490DC', text: '#2C5282' },
            { id: 'dodo', name: 'DAL èˆªç©º', bg: '#2C5282', primary: '#ECC94B', text: '#ffffff' }
        ];

        // --- ğŸŸ¢ NookFit (Fitness App) ---
        const FitnessApp = ({ fitness, updateFitness }) => {
            const [view, setView] = useState('dashboard');
            const [profile, setProfile] = useState(fitness.profile || {});
            const [timeView, setTimeView] = useState('day'); // 'day', 'week', 'month'
            
            const [logType, setLogType] = useState('exercise'); 
            const [logValue, setLogValue] = useState('');

            const [pHeight, setPHeight] = useState(profile.height || '');
            const [pWeight, setPWeight] = useState(profile.weight || '');
            const [pAge, setPAge] = useState(profile.age || '');
            const [pGender, setPGender] = useState(profile.gender || 'male');

            const today = new Date().toLocaleDateString();
            const todayLog = fitness.logs[today] || { exercise: 0, intake: 0, weight: profile.weight || 0, records: [] };

            const aggregatedData = useMemo(() => {
                const dates = [];
                const now = new Date();
                const numDays = timeView === 'week' ? 7 : (timeView === 'month' ? 30 : 1);
                
                for (let i = 0; i < numDays; i++) {
                    const d = new Date(now);
                    d.setDate(now.getDate() - i);
                    dates.push(d.toLocaleDateString());
                }

                let totalExercise = 0;
                let totalIntake = 0;
                let weightSum = 0;
                let weightCount = 0;
                let history = []; 

                dates.forEach(date => {
                    const log = fitness.logs[date];
                    if (log) {
                        totalExercise += (log.exercise || 0);
                        totalIntake += (log.intake || 0);
                        if (log.weight) {
                            weightSum += log.weight;
                            weightCount++;
                        }
                        
                        if (timeView !== 'day' && (log.exercise > 0 || log.intake > 0)) {
                            history.push({
                                id: date,
                                type: 'summary',
                                date: date,
                                exercise: log.exercise,
                                intake: log.intake
                            });
                        }
                    }
                });

                if (timeView === 'day') {
                    history = todayLog.records || [];
                }

                let displayWeight = 0;
                if (timeView === 'day') {
                    displayWeight = todayLog.weight || profile.weight || 0;
                } else {
                    displayWeight = weightCount > 0 ? (weightSum / weightCount).toFixed(1) : (profile.weight || 0);
                }

                return { totalExercise, totalIntake, displayWeight, history };
            }, [fitness.logs, timeView, profile, todayLog]);

            const bmr = useMemo(() => {
                if (!profile.weight || !profile.height || !profile.age) return 0;
                let val = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age);
                return profile.gender === 'male' ? val + 5 : val - 161;
            }, [profile]);

            const periodBmr = useMemo(() => {
                const days = timeView === 'week' ? 7 : (timeView === 'month' ? 30 : 1);
                return bmr * days;
            }, [bmr, timeView]);

            const bmi = useMemo(() => {
                if (!profile.weight || !profile.height) return 0;
                return (profile.weight / Math.pow(profile.height/100, 2)).toFixed(1);
            }, [profile]);

            const handleSaveProfile = () => {
                if(!pHeight || !pWeight || !pAge) return alert("è¯·å®Œæ•´å¡«å†™ä¿¡æ¯");
                const newProfile = { height: parseFloat(pHeight), weight: parseFloat(pWeight), age: parseInt(pAge), gender: pGender };
                setProfile(newProfile);
                
                const newLogs = { ...fitness.logs };
                if (!newLogs[today]) newLogs[today] = { exercise: 0, intake: 0, weight: parseFloat(pWeight), records: [] };
                else newLogs[today].weight = parseFloat(pWeight);

                updateFitness({ profile: newProfile, logs: newLogs });
                setView('dashboard');
            };

            const handleSaveLog = () => {
                if (!logValue) return alert("è¯·è¾“å…¥æ•°å€¼");
                const val = parseFloat(logValue);
                const newLogs = { ...fitness.logs };
                if (!newLogs[today]) newLogs[today] = { exercise: 0, intake: 0, weight: profile.weight || 0, records: [] };
                if (!newLogs[today].records) newLogs[today].records = []; 

                if (logType === 'exercise') newLogs[today].exercise += val;
                if (logType === 'intake') newLogs[today].intake += val;
                if (logType === 'weight') {
                    newLogs[today].weight = val;
                    const newProfile = { ...profile, weight: val };
                    updateFitness({ profile: newProfile, logs: newLogs });
                    setProfile(newProfile);
                    setLogValue(''); setView('dashboard');
                    return;
                }

                newLogs[today].records.unshift({
                    id: Date.now(),
                    type: logType,
                    val: val,
                    note: logType === 'exercise' ? 'æ‰‹åŠ¨è®°å½•' : 'æ‰‹åŠ¨è®°å½•',
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });

                updateFitness({ ...fitness, logs: newLogs });
                setLogValue(''); setView('dashboard');
            };

            if (view === 'setup' || !fitness.profile) {
                return (
                    <div className="flex flex-col flex-1 min-h-0 animate-pop justify-center">
                        <div className="flex items-center gap-2 mb-4">
                            {fitness.profile && <button onClick={()=>setView('dashboard')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button>}
                        </div>
                        <div className="text-center mb-6">
                            <div className="w-20 h-20 bg-[#4299E1] rounded-full flex items-center justify-center text-white mx-auto mb-4 shadow-lg"><Icon path={Icons.Activity} size={40}/></div>
                            <h2 className="text-xl font-black text-[#59584D]">NookFit</h2>
                            <p className="text-sm text-gray-500 font-bold mt-2">{fitness.profile ? 'ä¿®æ”¹æ‚¨çš„èº«ä½“æ¡£æ¡ˆ' : 'è¯·å…ˆå®Œå–„æ‚¨çš„èº«ä½“æ¡£æ¡ˆ'}</p>
                        </div>
                        <div className="nook-card space-y-4">
                            <div><label className="text-xs font-bold text-gray-400 ml-2">èº«é«˜ (cm)</label><input type="number" value={pHeight} onChange={e=>setPHeight(e.target.value)} className="nook-input"/></div>
                            <div><label className="text-xs font-bold text-gray-400 ml-2">ä½“é‡ (kg)</label><input type="number" value={pWeight} onChange={e=>setPWeight(e.target.value)} className="nook-input"/></div>
                            <div><label className="text-xs font-bold text-gray-400 ml-2">å¹´é¾„</label><input type="number" value={pAge} onChange={e=>setPAge(e.target.value)} className="nook-input"/></div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 ml-2">æ€§åˆ«</label>
                                <div className="flex bg-gray-100 p-1 rounded-xl mt-1">
                                    <button onClick={()=>setPGender('male')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${pGender==='male'?'bg-white text-blue-500 shadow-sm':'text-gray-400'}`}>ç”·</button>
                                    <button onClick={()=>setPGender('female')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${pGender==='female'?'bg-white text-pink-500 shadow-sm':'text-gray-400'}`}>å¥³</button>
                                </div>
                            </div>
                            <button onClick={handleSaveProfile} className="nook-btn w-full bg-[#4299E1] mt-2">{fitness.profile ? 'ä¿å­˜ä¿®æ”¹' : 'å¼€å§‹å¥èº«'}</button>
                        </div>
                    </div>
                );
            }

            if (view === 'log') {
                return (
                    <div className="flex flex-col flex-1 min-h-0 animate-pop">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={()=>setView('dashboard')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button>
                            <h2 className="text-xl font-black opacity-80">è®°å½•æ•°æ®</h2>
                        </div>
                        <div className="nook-card space-y-6">
                            <div className="flex bg-gray-100 p-1 rounded-xl">
                                <button onClick={()=>setLogType('exercise')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${logType==='exercise'?'bg-white text-orange-500 shadow-sm':'text-gray-400'}`}>è¿åŠ¨æ¶ˆè€—</button>
                                <button onClick={()=>setLogType('intake')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${logType==='intake'?'bg-white text-green-500 shadow-sm':'text-gray-400'}`}>é¥®é£Ÿæ‘„å…¥</button>
                                <button onClick={()=>setLogType('weight')} className={`flex-1 py-2 rounded-lg font-bold text-xs transition-all ${logType==='weight'?'bg-white text-blue-500 shadow-sm':'text-gray-400'}`}>ä½“é‡</button>
                            </div>
                            
                            <div className="text-center">
                                <div className="text-xs font-bold text-gray-400 mb-2 uppercase">
                                    {logType==='weight' ? 'å½“å‰ä½“é‡ (kg)' : (logType==='exercise' ? 'æ¶ˆè€—çƒ­é‡ (kcal)' : 'æ‘„å…¥çƒ­é‡ (kcal)')}
                                </div>
                                <input type="number" autoFocus value={logValue} onChange={e=>setLogValue(e.target.value)} className="w-full text-center text-4xl font-black bg-transparent outline-none border-b-2 border-gray-200 focus:border-[#4299E1] pb-2 transition-colors" placeholder="0"/>
                            </div>

                            <button onClick={handleSaveLog} className="nook-btn w-full bg-[#4299E1]">ç¡®è®¤è®°å½•</button>
                        </div>
                    </div>
                );
            }

            // Dashboard View with History List and View Switcher
            return (
                <div className="flex flex-col flex-1 min-h-0 animate-pop relative">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2">
                            <div className="w-10 h-10 bg-[#4299E1] rounded-full flex items-center justify-center text-white"><Icon path={Icons.Activity} /></div>
                            <h2 className="text-xl font-black opacity-80">NookFit</h2>
                        </div>
                        <button onClick={()=>{ setPHeight(profile.height); setPWeight(profile.weight); setPAge(profile.age); setPGender(profile.gender); setView('setup');}} className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500"><Icon path={Icons.Settings} size={16}/></button>
                    </div>

                    <div className="flex bg-white/50 p-1 rounded-xl mb-4 backdrop-blur-sm">
                        <button onClick={()=>setTimeView('day')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView==='day'?'bg-white text-[#4299E1] shadow-sm':'text-gray-500'}`}>æ—¥</button>
                        <button onClick={()=>setTimeView('week')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView==='week'?'bg-white text-[#4299E1] shadow-sm':'text-gray-500'}`}>å‘¨</button>
                        <button onClick={()=>setTimeView('month')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all ${timeView==='month'?'bg-white text-[#4299E1] shadow-sm':'text-gray-500'}`}>æœˆ</button>
                    </div>

                    <div className="bg-[#2D3748] rounded-[30px] p-6 text-white shadow-lg mb-6 relative overflow-hidden shrink-0">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-8 -mt-8"></div>
                        
                        <div className="grid grid-cols-2 gap-6 relative z-10 mt-2">
                            <div><div className="text-[10px] font-bold opacity-50 mb-1">{timeView==='day'?'TODAY\'S WEIGHT':'AVG WEIGHT'}</div><div className="text-2xl font-black">{aggregatedData.displayWeight} <span className="text-sm font-bold opacity-50">kg</span></div></div>
                            <div><div className="text-[10px] font-bold opacity-50 mb-1">BMI SCORE</div><div className="text-2xl font-black text-[#63B3ED]">{bmi}</div></div>
                            <div className="col-span-2 pt-4 border-t border-white/10">
                                <div className="flex justify-between items-end mb-2"><div className="text-[10px] font-bold opacity-50">TOTAL BURN ({timeView.toUpperCase()})</div><div className="text-3xl font-black text-[#F6AD55]">{(periodBmr + aggregatedData.totalExercise).toFixed(0)} <span className="text-xs">kcal</span></div></div>
                                <div className="h-2 bg-gray-700 rounded-full overflow-hidden"><div className="h-full bg-[#F6AD55]" style={{width: `${Math.min((aggregatedData.totalIntake / (periodBmr + aggregatedData.totalExercise)) * 100, 100)}%`}}></div></div>
                                <div className="flex justify-between text-[10px] font-bold mt-1 opacity-60"><span>æ‘„å…¥: {aggregatedData.totalIntake}</span><span>åŸºç¡€ä»£è°¢: {periodBmr.toFixed(0)}</span></div>
                            </div>
                        </div>
                    </div>

                    {/* ğŸŸ¢ FAB Button for Logging (Bottom Right) */}
                    <button onClick={()=>setView('log')} className="absolute bottom-6 right-2 bg-[#4299E1] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#3182CE] transition active:scale-95 flex items-center gap-2 z-50 font-bold">
                        <Icon path={Icons.Plus} size={18}/> è®°ä¸€ç¬”
                    </button>

                    <div className="flex-1 overflow-y-auto no-scrollbar pb-20"> {/* Increased padding bottom */}
                        <div className="flex items-center gap-2 mb-2 px-2">
                            <div className="w-1 h-4 bg-gray-300 rounded-full"></div>
                            <h3 className="text-xs font-bold text-gray-400">{timeView === 'day' ? 'ä»Šæ—¥è®°å½•' : 'æ¯æ—¥æ±‡æ€»'}</h3>
                        </div>
                        <div className="space-y-2">
                            {(!aggregatedData.history || aggregatedData.history.length === 0) && (
                                <div className="text-center text-xs text-gray-300 py-4 font-bold">æš‚æ— è®°å½•</div>
                            )}
                            {aggregatedData.history.map((rec, idx) => (
                                <div key={rec.id || idx} className="bg-white rounded-xl p-3 flex justify-between items-center shadow-sm">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${rec.type==='exercise'?'bg-orange-100 text-orange-500': (rec.type==='summary' ? 'bg-blue-100 text-blue-500' : 'bg-green-100 text-green-500')}`}>
                                            <Icon path={rec.type==='exercise'?Icons.Activity: (rec.type==='summary'?Icons.Book:Icons.Leaf)} size={16}/>
                                        </div>
                                        <div>
                                            <div className="text-xs font-bold text-[#59584D]">{rec.note || (rec.type === 'summary' ? rec.date : '')}</div>
                                            <div className="text-[10px] text-gray-400 font-bold">{rec.time || (rec.type==='summary' ? 'æ•°æ®æ±‡æ€»' : '')}</div>
                                        </div>
                                    </div>
                                    <div className={`text-sm font-black ${rec.type==='exercise'?'text-orange-500':(rec.type==='summary'?'text-blue-500':'text-green-500')}`}>
                                        {rec.type === 'summary' ? 
                                            <span className="text-[10px] flex flex-col text-right"><span>æ¶ˆè€— {rec.exercise}</span><span>æ‘„å…¥ {rec.intake}</span></span> 
                                            : 
                                            `${rec.type==='exercise' ? '-' : '+'}${rec.val}`
                                        }
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ğŸŸ¢ Finance & Ledger Apps (Existing) ---
        const FinanceApp = ({ stats, setStats }) => {
            const [mode, setMode] = useState('transfer'); 
            const [amount, setAmount] = useState('');
            const [editPocket, setEditPocket] = useState(stats.pocket);
            const [editSavings, setEditSavings] = useState(stats.savings);

            useEffect(() => { if (mode === 'transfer') { setEditPocket(stats.pocket); setEditSavings(stats.savings); } }, [stats, mode]);
            const handleTrans = (type) => {
                const val = parseInt(amount);
                if (!val || val <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢");
                if (type === 'deposit') { if (stats.pocket < val) return alert("é’±åŒ…é‡Œçš„é“ƒé’±ä¸å¤Ÿå“¦ï¼"); setStats({ ...stats, pocket: stats.pocket - val, savings: stats.savings + val }); } 
                else { if (stats.savings < val) return alert("ABD å­˜æ¬¾ä½™é¢ä¸è¶³ï¼"); setStats({ ...stats, pocket: stats.pocket + val, savings: stats.savings - val }); }
                setAmount('');
            };
            const handleSaveManagement = () => {
                const p = parseInt(editPocket); const s = parseInt(editSavings);
                if (isNaN(p) || isNaN(s) || p < 0 || s < 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
                setStats({ ...stats, pocket: p, savings: s }); alert("è´¦æˆ·èµ„é‡‘å·²ä¿®æ­£ï¼"); setMode('transfer');
            };

            return (
                <div className="flex flex-col flex-1 min-h-0 animate-pop text-[#59584D]">
                     <div className="bg-[#E2E8F0] p-6 rounded-[30px] shadow-inner border-8 border-[#CBD5E0] mb-4 relative">
                        <button onClick={() => setMode(mode === 'transfer' ? 'manage' : 'transfer')} className={`absolute top-3 right-3 p-2 rounded-full transition-all ${mode==='manage' ? 'bg-[#3DAA86] text-white shadow-md' : 'text-gray-400 hover:bg-white/50'}`}><Icon path={Icons.Edit} size={16} /></button>
                        <div className="bg-[#2D3748] rounded-xl p-4 mb-4 text-[#48BB78] font-mono text-right shadow-inner border-4 border-[#1A202C]"><div className="text-xs opacity-50 mb-1 font-bold">ABD BALANCE</div><div className="text-3xl font-bold tracking-widest">{stats.savings.toLocaleString()}</div></div>
                        <div className="flex justify-between items-end"><div className="text-center"><div className="text-[10px] font-bold text-gray-500 mb-1">POCKET</div><div className="text-xl font-black text-[#D69E2E]">{stats.pocket.toLocaleString()}</div></div><div className="w-16 h-2 bg-gray-300 rounded-full mb-2"></div></div>
                     </div>
                     {mode === 'transfer' && (
                         <div className="nook-card flex-1 flex flex-col justify-center gap-4 animate-pop">
                            <div className="text-center font-bold mb-2 text-sm opacity-80">æ¬¢è¿ä½¿ç”¨ Nook è‡ªåŠ¨å­˜å–æ¬¾æœº</div>
                            <div className="relative"><input type="number" placeholder="è¾“å…¥é‡‘é¢" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full bg-[#F0F0F0] p-4 rounded-2xl text-center text-2xl font-black outline-none border-b-4 border-transparent focus:border-[#3DAA86] transition-colors placeholder-gray-300"/><div className="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold text-gray-400">BELLS</div></div>
                            <div className="grid grid-cols-2 gap-4 mt-2"><button onClick={()=>handleTrans('deposit')} className="nook-btn bg-[#48BB78] text-white py-4 shadow-[0_6px_0_#2F855A] active:shadow-none active:top-1.5 transition-all">å­˜å…¥</button><button onClick={()=>handleTrans('withdraw')} className="nook-btn bg-[#E53E3E] text-white py-4 shadow-[0_6px_0_#9B2C2C] active:shadow-none active:top-1.5 transition-all">å–å‡º</button></div>
                         </div>
                     )}
                     {mode === 'manage' && (
                         <div className="nook-card flex-1 flex flex-col gap-4 animate-pop border-l-8 border-[#3DAA86]">
                            <div className="text-center font-bold mb-2 text-sm opacity-80 flex items-center justify-center gap-2"><Icon path={Icons.Settings} size={16}/> è´¦æˆ·èµ„é‡‘ä¿®æ­£</div>
                            <div><label className="text-xs font-bold text-gray-400 block mb-1 ml-2">ä¿®æ”¹é’±åŒ…é‡‘é¢ (POCKET)</label><div className="relative"><input type="number" value={editPocket} onChange={e=>setEditPocket(e.target.value)} className="w-full bg-[#FFFBEB] p-3 rounded-xl text-center text-xl font-bold outline-none border-2 border-transparent focus:border-[#D69E2E] text-[#D69E2E]"/></div></div>
                            <div><label className="text-xs font-bold text-gray-400 block mb-1 ml-2">ä¿®æ”¹å­˜æ¬¾é‡‘é¢ (ABD)</label><div className="relative"><input type="number" value={editSavings} onChange={e=>setEditSavings(e.target.value)} className="w-full bg-[#F0FFF4] p-3 rounded-xl text-center text-xl font-bold outline-none border-2 border-transparent focus:border-[#48BB78] text-[#48BB78]"/></div></div>
                            <button onClick={handleSaveManagement} className="nook-btn mt-auto w-full flex justify-center items-center gap-2">ä¿å­˜ä¿®æ”¹</button>
                         </div>
                     )}
                </div>
            );
        };

        const LedgerApp = ({ ledger, setLedger }) => {
            const [view, setView] = useState('list'); 
            const [type, setType] = useState('expense');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('å…¶ä»–');
            const [note, setNote] = useState('');
            const categories = type === 'expense' ? ['åƒé¥­', 'é›¶é£Ÿ', 'å¨±ä¹', 'ç”Ÿæ´»', 'äº¤é€š', 'æœé¥°', 'æ—¥ç”¨å“'] : ['å·¥ä½œ', 'åˆ©æ¯', 'å…¶ä»–'];
            const summary = useMemo(() => {
                let inc = 0, exp = 0;
                ledger.forEach(r => r.type === 'income' ? inc += Number(r.amount) : exp += Number(r.amount));
                return { income: inc, expense: exp, balance: inc - exp };
            }, [ledger]);

            const handleAdd = () => {
                if(!amount) return alert("è¯·è¾“å…¥é‡‘é¢");
                const newRecord = { id: Date.now(), type, amount: Number(amount), category, note, date: new Date().toLocaleDateString() };
                setLedger([newRecord, ...ledger]);
                setAmount(''); setNote(''); setView('list');
            };
            const handleDelete = (id) => { if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) setLedger(ledger.filter(r => r.id !== id)); };

            if (view === 'add') {
                return (
                    <div className="flex flex-col flex-1 min-h-0 animate-pop">
                        <div className="flex items-center gap-2 mb-4"><button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button><h2 className="text-xl font-black opacity-80">è®°ä¸€ç¬”</h2></div>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-4">
                            <div className="flex bg-gray-200 p-1 rounded-xl">
                                <button onClick={()=>setType('expense')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type==='expense'?'bg-white text-red-500 shadow-sm':'text-gray-500'}`}>æ”¯å‡º</button>
                                <button onClick={()=>setType('income')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${type==='income'?'bg-white text-green-500 shadow-sm':'text-gray-500'}`}>æ”¶å…¥</button>
                            </div>
                            <div className="nook-card"><label className="text-xs font-bold text-gray-400 mb-1 block">é‡‘é¢</label><input type="number" value={amount} onChange={e=>setAmount(e.target.value)} className="w-full text-3xl font-black bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="0"/></div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 mb-2 block ml-2">é€‰æ‹©åˆ†ç±»</label>
                                <div className="grid grid-cols-4 gap-2">{categories.map(c => (<button key={c} onClick={()=>setCategory(c)} className={`py-2 rounded-xl text-xs font-bold border-2 ${category===c?'border-[#3DAA86] bg-white text-[#3DAA86]':'border-transparent bg-white/50 text-gray-500'}`}>{c}</button>))}</div>
                            </div>
                            <div className="nook-card p-3"><input value={note} onChange={e=>setNote(e.target.value)} className="w-full bg-transparent outline-none text-sm font-bold placeholder-gray-300" placeholder="æ·»åŠ å¤‡æ³¨ (é€‰å¡«)"/></div>
                            <button onClick={handleAdd} className="nook-btn w-full flex justify-center mt-4">å®Œæˆ</button>
                        </div>
                    </div>
                );
            }
            return (
                <div className="flex flex-col flex-1 min-h-0 animate-pop relative">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2"><div className="w-10 h-10 bg-[#FFD166] rounded-full flex items-center justify-center text-white"><Icon path={Icons.Book} /></div><h2 className="text-xl font-black opacity-80">è®°è´¦æœ¬</h2></div>
                        {/* Old Button Removed */}
                    </div>

                    <div className="bg-[#3D405B] rounded-[24px] p-5 text-[#F4F1DE] shadow-lg mb-4 flex justify-between items-center relative overflow-hidden shrink-0">
                        <div className="absolute right-0 bottom-0 w-24 h-24 bg-white/5 rounded-full -mr-6 -mb-6"></div>
                        <div><div className="text-[10px] opacity-60 font-bold mb-1">æœ¬æœˆç»“ä½™</div><div className="text-2xl font-black tracking-wide">{summary.balance.toLocaleString()}</div></div>
                        <div className="text-right space-y-1"><div><span className="text-[10px] bg-green-500/20 text-green-300 px-1.5 rounded mr-1">æ”¶</span><span className="text-sm font-bold">{summary.income.toLocaleString()}</span></div><div><span className="text-[10px] bg-red-500/20 text-red-300 px-1.5 rounded mr-1">æ”¯</span><span className="text-sm font-bold">{summary.expense.toLocaleString()}</span></div></div>
                    </div>
                    
                    {/* ğŸŸ¢ FAB Button for Ledger */}
                    <button onClick={()=>setView('add')} className="absolute bottom-6 right-2 bg-[#3DAA86] text-white px-4 py-3 rounded-full shadow-xl hover:bg-[#2F855A] transition active:scale-95 flex items-center gap-2 z-50 font-bold">
                        <Icon path={Icons.Plus} size={18}/> è®°ä¸€ç¬”
                    </button>

                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-20"> {/* Added padding bottom to clear FAB */}
                        {ledger.length === 0 && <div className="text-center text-gray-400 py-10 text-xs font-bold">æš‚æ— è®°å½•ï¼Œå¿«å»è®°ä¸€ç¬”å§ï¼</div>}
                        {ledger.map(item => (
                            <div key={item.id} className="bg-white rounded-2xl p-4 shadow-sm flex justify-between items-center group">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-xs shadow-sm ${item.type==='expense'?'bg-red-400':'bg-green-400'}`}>{item.category.substring(0,2)}</div>
                                    <div><div className="font-bold text-[#59584D] text-sm">{item.category} <span className="text-xs font-normal text-gray-400 ml-1">{item.note}</span></div><div className="text-[10px] text-gray-400 font-bold">{item.date}</div></div>
                                </div>
                                <div className="flex items-center gap-3"><span className={`font-black ${item.type==='expense'?'text-red-500':'text-green-500'}`}>{item.type==='expense'?'-':'+'}{item.amount.toLocaleString()}</span><button onClick={()=>handleDelete(item.id)} className="text-gray-300 hover:text-red-400 transition"><Icon path={Icons.Trash} size={14}/></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- ğŸŸ¢ NookMilesApp ---
        const NookMilesApp = ({ userStats, tasks, setTasks, updateStats, addLedgerRecord, addFitnessRecord }) => {
            const [view, setView] = useState('list');
            const [newTitle, setNewTitle] = useState('');
            const [newDiff, setNewDiff] = useState('normal');
            const [newType, setNewType] = useState('ç”Ÿæ´»');
            const taskTypes = ['å·¥ä½œ', 'å¨±ä¹', 'ç”Ÿæ´»', 'å¥èº«', 'åƒé¥­'];
            const [linkMoney, setLinkMoney] = useState(false);
            const [moneyType, setMoneyType] = useState('income');
            const [moneyAmount, setMoneyAmount] = useState('');
            const [fitnessValue, setFitnessValue] = useState('');
            const levelInfo = useMemo(() => getLevelInfo(userStats.xp || 0), [userStats.xp]);

            const handleAddTask = () => {
                if(!newTitle) return alert("è¯·è¾“å…¥ä»»åŠ¡å†…å®¹");
                if(linkMoney && (!moneyAmount || moneyAmount <= 0)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é’±æ•°é¢");
                if((newType === 'å¥èº«' || newType === 'åƒé¥­') && (!fitnessValue || fitnessValue <= 0)) return alert("è¯·è¾“å…¥çƒ­é‡æ•°å€¼");

                const newTask = {
                    id: Date.now(),
                    title: newTitle,
                    difficulty: newDiff,
                    type: newType,
                    reward: DIFFICULTIES[newDiff].xp,
                    completed: false,
                    money: linkMoney ? { type: moneyType, amount: parseInt(moneyAmount) } : null,
                    calories: (newType === 'å¥èº«' || newType === 'åƒé¥­') ? parseInt(fitnessValue) : null
                };
                setTasks([newTask, ...tasks]);
                setNewTitle(''); setView('list'); 
                setLinkMoney(false); setMoneyAmount(''); setFitnessValue('');
            };

            const completeTask = (id) => {
                const t = tasks.find(i=>i.id===id);
                if(t && !t.completed) {
                    let newStats = { 
                        ...userStats, 
                        miles: userStats.miles + t.reward, 
                        xp: (userStats.xp || 0) + t.reward 
                    };

                    if (t.money) {
                        if (t.money.type === 'income') newStats.pocket = (newStats.pocket || 0) + t.money.amount;
                        else newStats.pocket = (newStats.pocket || 0) - t.money.amount;

                        const ledgerRecord = {
                            id: Date.now(), type: t.money.type, amount: t.money.amount, category: 'ä»»åŠ¡', note: t.title, date: new Date().toLocaleDateString()
                        };
                        addLedgerRecord(ledgerRecord);
                    }
                    
                    // ğŸŸ¢ Fitness Logic with Note
                    if (t.type === 'å¥èº«' && t.calories) {
                        addFitnessRecord('exercise', t.calories, t.title);
                    }
                    if (t.type === 'åƒé¥­' && t.calories) {
                        addFitnessRecord('intake', t.calories, t.title);
                    }

                    updateStats(newStats);
                    setTasks(tasks.map(item => item.id === id ? {...item, completed: true} : item));
                }
            };

            if (view === 'add') {
                return (
                    <div className="flex flex-col flex-1 min-h-0 animate-pop">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={()=>setView('list')} className="p-2 -ml-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"><Icon path={Icons.ArrowLeft} size={24}/></button>
                            <h2 className="text-xl font-black opacity-80">å‘å¸ƒä»»åŠ¡</h2>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-4">
                            <div className="nook-card p-4">
                                <label className="text-xs font-bold text-gray-400 mb-1 block">ä»»åŠ¡å†…å®¹</label>
                                <input value={newTitle} onChange={e=>setNewTitle(e.target.value)} className="w-full text-lg font-bold bg-transparent outline-none border-b-2 border-gray-100 py-2" placeholder="ä¾‹å¦‚ï¼šå»é’“é±¼..."/>
                            </div>
                            
                            <div>
                                <label className="text-xs font-bold text-gray-500 mb-2 block ml-2">é€‰æ‹©ç±»å‹</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {taskTypes.map(t => (
                                        <button key={t} onClick={()=>setNewType(t)} className={`py-2 rounded-xl text-xs font-bold border-2 ${newType===t?'border-[#3DAA86] bg-white text-[#3DAA86]':'border-transparent bg-white/50 text-gray-500'}`}>{t}</button>
                                    ))}
                                </div>
                            </div>
                            
                            {(newType === 'å¥èº«' || newType === 'åƒé¥­') && (
                                <div className={`nook-card border-l-8 ${newType==='å¥èº«'?'border-orange-400':'border-green-400'}`}>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">{newType === 'å¥èº«' ? 'é¢„è®¡æ¶ˆè€— (kcal)' : 'é¢„è®¡æ‘„å…¥ (kcal)'}</label>
                                    <input type="number" value={fitnessValue} onChange={e=>setFitnessValue(e.target.value)} className="w-full bg-transparent border-b-2 border-gray-200 py-1 text-center font-black text-xl outline-none transition-colors" placeholder="0"/>
                                </div>
                            )}

                            <div>
                                <label className="text-xs font-bold text-gray-500 mb-2 block ml-2">é€‰æ‹©éš¾åº¦ (XPå¥–åŠ±)</label>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.entries(DIFFICULTIES).map(([key, cfg]) => (
                                        <button key={key} onClick={()=>setNewDiff(key)} 
                                            className={`p-3 rounded-xl border-4 text-left transition-all relative overflow-hidden
                                            ${newDiff===key ? 'border-[#3DAA86] bg-white shadow-md' : 'border-transparent bg-white/50'}`}>
                                            <div className={`absolute top-0 right-0 p-1 px-2 text-[10px] text-white font-bold rounded-bl-lg ${cfg.color}`}>{cfg.xp} XP</div>
                                            <div className="font-bold text-[#59584D]">{cfg.label}</div>
                                            <div className={`w-2 h-2 rounded-full mt-1 ${cfg.color}`}></div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="nook-card border-l-8 border-yellow-400">
                                <div className="flex items-center justify-between mb-2">
                                    <label className="text-xs font-bold text-gray-500">å…³è”é‡‘é’±å˜åŠ¨ (é€‰å¡«)</label>
                                    <label className="nook-switch scale-75">
                                        <input type="checkbox" checked={linkMoney} onChange={e=>setLinkMoney(e.target.checked)}/>
                                        <span className="slider"></span>
                                    </label>
                                </div>
                                {linkMoney && (
                                    <div className="space-y-3 animate-pop">
                                        <div className="flex bg-gray-100 p-1 rounded-lg">
                                            <button onClick={()=>setMoneyType('income')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${moneyType==='income'?'bg-white text-green-600 shadow-sm':'text-gray-400'}`}>è·å¾—é‡‘é’±</button>
                                            <button onClick={()=>setMoneyType('expense')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${moneyType==='expense'?'bg-white text-red-500 shadow-sm':'text-gray-400'}`}>æ¶ˆè€—é‡‘é’±</button>
                                        </div>
                                        <div className="relative">
                                            <input type="number" value={moneyAmount} onChange={e=>setMoneyAmount(e.target.value)} className="w-full bg-transparent border-b-2 border-gray-200 py-1 text-center font-black text-xl outline-none focus:border-yellow-400 transition-colors" placeholder="0"/>
                                            <div className="absolute right-0 top-2 text-[10px] font-bold text-gray-400">BELLS</div>
                                        </div>
                                        <p className="text-[10px] text-gray-400 text-center">å®Œæˆä»»åŠ¡æ—¶å°†è‡ªåŠ¨è®°è´¦å¹¶ä¿®æ”¹ä½™é¢</p>
                                    </div>
                                )}
                            </div>
                            <button onClick={handleAddTask} className="nook-btn w-full flex justify-center mt-4">å‘å¸ƒä»»åŠ¡</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col flex-1 min-h-0 animate-pop">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-[#3DAA86] rounded-full flex items-center justify-center text-white shadow-md relative">
                                <Icon path={Icons.Leaf} size={24}/>
                                <div className="absolute -bottom-1 -right-1 bg-yellow-400 text-yellow-900 text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center border-2 border-white">{levelInfo.level}</div>
                            </div>
                            <div>
                                <h2 className="text-lg font-black opacity-80">é›†é‡Œæ¸¸+</h2>
                                <div className="w-24 h-2 bg-gray-200 rounded-full mt-1 overflow-hidden"><div className="h-full bg-yellow-400 progress-bar-fill" style={{width: `${levelInfo.progress}%`}}></div></div>
                                <div className="text-[10px] text-gray-400 font-bold mt-0.5">LV.{levelInfo.level} ({parseInt(levelInfo.currentXP)}/{levelInfo.requiredXP})</div>
                            </div>
                        </div>
                        <button onClick={()=>setView('add')} className="w-8 h-8 bg-[#3DAA86] rounded-full flex items-center justify-center text-white shadow-md active:scale-95 transition"><Icon path={Icons.Plus} size={18}/></button>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-4">
                        {tasks.map(t => {
                            const diff = DIFFICULTIES[t.difficulty || 'normal']; 
                            return (
                                <div key={t.id} className={`bg-white rounded-2xl p-4 border-l-8 shadow-sm flex justify-between items-center ${t.completed ? 'border-gray-300 opacity-60' : 'border-[#F4A261]'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-3 h-3 rounded-full ${diff.color} shadow-sm ring-2 ${diff.ring}`}></div>
                                        <div>
                                            <div className="font-bold text-[#59584D] flex items-center gap-2">
                                                {t.title}
                                                {/* ğŸŸ¢ Display Task Type */}
                                                {t.type && (
                                                    <span className="text-[9px] bg-gray-200 text-gray-500 px-1.5 py-0.5 rounded-md font-bold">{t.type}</span>
                                                )}
                                                {t.money && (
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded-full flex items-center gap-1 ${t.money.type==='income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'}`}>
                                                        <Icon path={Icons.Coin} size={10}/> {t.money.amount}
                                                    </span>
                                                )}
                                                {t.calories && <span className={`text-[10px] px-1.5 py-0.5 rounded-full flex items-center gap-1 ${t.type==='å¥èº«' ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}`}><Icon path={t.type==='å¥èº«' ? Icons.Activity : Icons.Utensils} size={10}/> {t.calories}</span>}
                                            </div>
                                            <div className="text-[10px] font-black text-[#38B2AC] bg-[#E6FFFA] px-1.5 py-0.5 rounded inline-block mt-1">{diff.label} +{t.reward} XP</div>
                                        </div>
                                    </div>
                                    {t.completed ? <div className="text-[#3DAA86]"><Icon path={Icons.Leaf}/></div> : <button onClick={() => completeTask(t.id)} className="w-10 h-10 rounded-full border-4 border-[#E2E8F0] text-[#CBD5E0] flex items-center justify-center hover:bg-[#3DAA86] hover:text-white transition-colors"><Icon path={Icons.Check} size={20}/></button>}
                                </div>
                            );
                        })}
                        <div className="text-center text-xs opacity-50 py-4">æ›´å¤šä»»åŠ¡å°†åœ¨ç¬¬äºŒå¤©åˆ·æ–°...</div>
                    </div>
                </div>
            );
        };

        const SettingsApp = ({ user, currentTheme, currentAvatar, changeTheme, changeAvatar, onSave, onReset, onLogout, loading }) => (
            <div className="flex flex-col flex-1 min-h-0 animate-pop">
                <div className="flex items-center gap-2 mb-6"><div className="w-10 h-10 bg-gray-500 rounded-full flex items-center justify-center text-white"><Icon path={Icons.Settings} /></div><h2 className="text-xl font-black opacity-80">è®¾ç½®</h2></div>
                <div className="flex-1 overflow-y-auto no-scrollbar space-y-6">
                    <div className="nook-card border-l-8 border-[#3DAA86]">
                        <h3 className="font-bold text-[#59584D] mb-2">å±…æ°‘ä¿¡æ¯</h3>
                        <div className="flex items-center gap-3 mb-4"><div className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-gray-400 overflow-hidden border-2 border-gray-100 shadow-sm"><img src={currentAvatar} alt="avatar" className="w-full h-full object-cover"/></div><div><div className="text-lg font-black text-[#59584D]">{user.getUsername()}</div><div className="text-xs text-gray-500 font-bold">å·²ç™»å½• NookLink</div></div></div>
                        <div className="grid grid-cols-2 gap-2"><button onClick={onSave} disabled={loading} className="nook-btn text-sm flex justify-center items-center gap-2">{loading ? "ä¿å­˜ä¸­..." : <><Icon path={Icons.Cloud} size={16}/> ä¿å­˜æ•°æ®</>}</button><button onClick={onLogout} className="nook-btn-secondary py-3 px-4 rounded-full font-bold text-sm text-gray-600 flex justify-center items-center gap-2"><Icon path={Icons.LogOut} size={16}/> é€€å‡º</button></div>
                    </div>
                    <div className="nook-card">
                        <h3 className="font-bold text-[#59584D] mb-3">æ›´æ¢è¯ä»¶ç…§</h3>
                        <div className="grid grid-cols-4 gap-2">{AVATAR_LIBRARY.map((url, idx) => (<button key={idx} onClick={()=>changeAvatar(url)} className={`w-full aspect-square rounded-full border-4 overflow-hidden bg-white flex items-center justify-center transition-transform hover:scale-105 ${currentAvatar === url ? 'border-[#3DAA86]' : 'border-transparent'}`}><img src={url} className="w-full h-full object-cover"/></button>))}</div>
                    </div>
                    <div className="nook-card">
                        <h3 className="font-bold text-[#59584D] mb-3">æ›´æ¢æ‰‹æœºå£³</h3>
                        <div className="grid grid-cols-2 gap-3">{THEMES.map(t => (<button key={t.id} onClick={()=>changeTheme(t.id)} className={`p-3 rounded-xl border-4 transition-all flex items-center gap-2 text-left bg-gray-100 ${currentTheme === t.id ? 'border-[#3DAA86] bg-white shadow-md' : 'border-transparent'}`}><div className="w-6 h-6 rounded-full border border-white shadow-sm" style={{background: t.bg}}></div><span className="text-xs font-bold text-gray-600">{t.name}</span></button>))}</div>
                    </div>
                    {/* ğŸŸ¢ Data Reset Button */}
                    <div className="pb-4">
                        <button onClick={onReset} className="w-full py-4 rounded-3xl border-2 border-red-100 bg-red-50 text-red-500 font-black text-sm flex items-center justify-center gap-2 hover:bg-red-100 transition active:scale-95">
                            <Icon path={Icons.Danger} size={18}/> é‡ç½®å²›å±¿æ•°æ®
                        </button>
                        <p className="text-center text-[10px] text-gray-400 mt-2">æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ— æ³•æ¢å¤</p>
                    </div>
                </div>
            </div>
        );

        const PassportApp = ({ user, stats, avatar }) => {
            const levelInfo = getLevelInfo(stats.xp || 0); 
            return (
                <div className="flex flex-col flex-1 min-h-0 animate-pop">
                    <div className="bg-[#3D405B] rounded-[24px] overflow-hidden shadow-lg mb-6 text-[#F4F1DE] relative border-4 border-white/20 p-5">
                        <div className="flex gap-4 items-center border-b border-white/10 pb-4 mb-4">
                            <div className="w-20 h-20 bg-[#F4F1DE] rounded-2xl flex items-center justify-center overflow-hidden border-4 border-white/10 shadow-inner"><img src={avatar} className="w-full h-full object-cover"/></div>
                            <div><div className="text-xl font-black">{user.getUsername()}</div><div className="text-sm opacity-80">Lv.{levelInfo.level} å±…æ°‘</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4"><div><div className="text-[10px] opacity-50 font-bold">TITLE</div><div className="text-sm font-bold">æœªæ¥å¯æœŸçš„ / å²›æ°‘</div></div><div><div className="text-[10px] opacity-50 font-bold">BIRTHDAY</div><div className="text-sm font-bold">12/10</div></div></div>
                    </div>
                     <div className="nook-card flex-1 flex items-center justify-center text-center p-6"><div className="opacity-50"><div className="text-4xl mb-2">âœˆï¸</div><p className="font-bold">æ›´å¤šæŠ¤ç…§åŠŸèƒ½å¼€å‘ä¸­...</p></div></div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [data, setData] = useState(null);
            const [currentApp, setCurrentApp] = useState(null);
            const [saveLoading, setSaveLoading] = useState(false);
            const [isCheckingSession, setIsCheckingSession] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            
            // ğŸŸ¢ Reset Logic State
            const [resetStep, setResetStep] = useState(0); // 0: idle, 1: confirm 1, 2: confirm 2
            
            // ğŸŸ¢ Time State
            const [currentTime, setCurrentTime] = useState(new Date());

            // ğŸŸ¢ Timer Effect
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const checkSession = async () => {
                    const user = AV.User.current();
                    if (user) {
                        try {
                            const cloudDataStr = user.get('gameData');
                            let gameData = DEFAULT_DATA;
                            if (cloudDataStr) {
                                try { 
                                    const parsed = JSON.parse(cloudDataStr);
                                    gameData = { ...DEFAULT_DATA, ...parsed };
                                    if (!gameData.ledger) gameData.ledger = [];
                                    if (!gameData.stats.xp) gameData.stats.xp = gameData.stats.miles;
                                    // ğŸŸ¢ New Fitness App Data Initialization
                                    if (!gameData.fitness) gameData.fitness = DEFAULT_DATA.fitness;
                                } catch(e){}
                            }
                            setCurrentUser(user);
                            setData(gameData);
                        } catch(e) { console.error("Auto login error", e); await AV.User.logOut(); }
                    }
                    setTimeout(() => setIsCheckingSession(false), 800);
                };
                checkSession();
            }, []);

            useEffect(() => {
                if (data && data.themeId) {
                    const t = THEMES.find(x => x.id === data.themeId) || THEMES[0];
                    const r = document.documentElement.style;
                    r.setProperty('--theme-bg', t.bg);
                    r.setProperty('--theme-primary', t.primary);
                    r.setProperty('--theme-text', t.text);
                    r.setProperty('--theme-btn-shadow', t.id==='sakura'?'#D65D7A':(t.id==='dodo'?'#D69E2E':'#2D8666'));
                }
            }, [data]);

            // ğŸŸ¢ Auto Save Effect
            useEffect(() => {
                if (!currentUser || !data) return;
                
                const timer = setTimeout(async () => {
                    setIsSaving(true);
                    try {
                        currentUser.set('gameData', JSON.stringify(data));
                        await currentUser.save();
                        console.log("Auto-saved to cloud");
                    } catch (error) {
                        console.error("Save failed", error);
                    } finally {
                        setIsSaving(false);
                    }
                }, 2000); 

                return () => clearTimeout(timer);
            }, [data, currentUser]);

            const handleLogin = (user, gameData) => { setCurrentUser(user); setData(gameData); };
            const handleLogout = async () => { await AV.User.logOut(); setCurrentUser(null); setData(null); setCurrentApp(null); };
            const handleSave = async () => {
                if (!currentUser) return;
                setSaveLoading(true);
                try { currentUser.set('gameData', JSON.stringify(data)); await currentUser.save(); alert("ä¿å­˜æˆåŠŸï¼æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ã€‚"); } 
                catch(e) { alert("ä¿å­˜å¤±è´¥: " + e.message); } 
                finally { setSaveLoading(false); }
            };

            // ğŸŸ¢ Reset Handler
            const handleReset = async () => {
                if (!currentUser) return;
                setSaveLoading(true);
                try {
                    // Reset local
                    setData(DEFAULT_DATA);
                    // Reset cloud
                    currentUser.set('gameData', JSON.stringify(DEFAULT_DATA));
                    await currentUser.save();
                    alert("é‡ç½®æˆåŠŸï¼ä¸€åˆ‡å›åˆ°äº†æœ€åˆçš„èµ·ç‚¹ã€‚");
                    setResetStep(0); // Reset UI
                } catch(e) {
                    alert("é‡ç½®å¤±è´¥: " + e.message);
                } finally {
                    setSaveLoading(false);
                }
            };

            const updateData = (key, val) => { setData(prev => ({ ...prev, [key]: val })); };
            
            // ğŸŸ¢ Ledger Helper
            const addLedgerRecord = (record) => {
                setData(prev => ({ ...prev, ledger: [record, ...(prev.ledger || [])] }));
            };

            // ğŸŸ¢ Fitness Helper (Updated)
            const addFitnessRecord = (type, val, note = '') => {
                const today = new Date().toLocaleDateString();
                const newLogs = { ...data.fitness.logs };
                const currentWeight = data.fitness.profile?.weight || 0;
                
                if (!newLogs[today]) newLogs[today] = { exercise: 0, intake: 0, weight: currentWeight, records: [] };
                if (!newLogs[today].records) newLogs[today].records = []; // Ensure existence

                if (type === 'exercise') newLogs[today].exercise += val;
                if (type === 'intake') newLogs[today].intake += val;
                
                // Add to history
                newLogs[today].records.unshift({
                    id: Date.now(),
                    type,
                    val,
                    note: note || (type === 'exercise' ? 'è¿åŠ¨æ‰“å¡' : 'é¥®é£Ÿè®°å½•'),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                
                updateData('fitness', { ...data.fitness, logs: newLogs });
            };
            
            const formatTime = (date) => {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            };

            const AppIcon = ({ icon, label, onClick }) => (
                <div className="flex flex-col items-center gap-2 cursor-pointer group" onClick={onClick}>
                    <div className="app-icon group-active:scale-90 transition-transform"><Icon path={icon} size={32} color="#59584D"/></div>
                    <span className="text-xs font-bold bg-white/40 px-2 py-0.5 rounded-full text-[#59584D]">{label}</span>
                </div>
            );

            // ğŸŸ¢ Reset Confirmation Dialog
            if (resetStep > 0) {
                return (
                     <div className="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-pop">
                        <div className="nook-card w-full max-w-xs text-center border-4 border-red-500 shadow-2xl">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                <Icon path={Icons.Danger} size={32}/>
                            </div>
                            <h2 className="text-xl font-black text-[#59584D] mb-2">
                                {resetStep === 1 ? "ç¡®å®šè¦é‡ç½®å—ï¼Ÿ" : "æœ€åè­¦å‘Šï¼"}
                            </h2>
                            <p className="text-sm text-gray-500 font-bold mb-6">
                                {resetStep === 1 ? "æ‰€æœ‰æ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼Œæ— æ³•æ¢å¤ã€‚" : "æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼é‡‘é’±ã€å›¾é‰´ã€å¥èº«è®°å½•éƒ½å°†æ¶ˆå¤±ï¼"}
                            </p>
                            
                            <div className="space-y-3">
                                <button 
                                    onClick={() => resetStep === 1 ? setResetStep(2) : handleReset()} 
                                    className="nook-btn w-full bg-red-500 text-white shadow-none hover:bg-red-600"
                                >
                                    {resetStep === 1 ? "ç¡®å®š" : "æ¯ç­å§"}
                                </button>
                                <button 
                                    onClick={() => setResetStep(0)} 
                                    className="nook-btn-secondary w-full py-3 rounded-full font-bold text-sm"
                                >
                                    {resetStep === 1 ? "å†æƒ³æƒ³" : "å–æ¶ˆ"}
                                </button>
                            </div>
                        </div>
                     </div>
                );
            }

            if (isCheckingSession) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center p-6 bg-[#7FE2C3] animate-pop">
                         <div className="w-24 h-24 bg-white rounded-[30px] flex items-center justify-center shadow-lg mb-4 animate-bounce"><Icon path={Icons.Leaf} size={60} color="#3DAA86"/></div>
                        <div className="text-white/80 font-bold text-lg tracking-widest animate-pulse">NOOKLINK OS...</div>
                    </div>
                );
            }

            if (!currentUser || !data) return <AuthScreen onLogin={handleLogin} />;

            return (
                <div className="w-full h-full flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md h-[85vh] bg-white/20 backdrop-blur-xl rounded-[45px] shadow-2xl border-[8px] border-white/40 relative overflow-hidden flex flex-col transition-all duration-500">
                        <div className="h-12 flex justify-between items-center px-8 shrink-0 z-20 pt-2 text-[#59584D]">
                            {/* ğŸŸ¢ Update Time Display */}
                            <div className="bg-white/40 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm">{formatTime(currentTime)}</div>
                            
                            {/* ğŸŸ¢ Status Bar Indicator */}
                            <div className="bg-white/40 px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm flex items-center gap-1 transition-all">
                                {isSaving ? (
                                    <><div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div> ğŸ”„ åŒæ­¥ä¸­...</>
                                ) : (
                                    <><div className="w-2 h-2 bg-green-400 rounded-full"></div> â˜ï¸ å·²åŒæ­¥</>
                                )}
                            </div>
                        </div>

                        <div className="flex-1 overflow-hidden relative p-6">
                            <div className={`absolute inset-0 p-8 grid grid-cols-3 content-start gap-y-8 gap-x-4 transition-all duration-500 ${currentApp ? '-translate-x-full opacity-0' : 'translate-x-0 opacity-100'}`}>
                                <AppIcon icon={Icons.Leaf} label="é›†é‡Œæ¸¸+" onClick={()=>setCurrentApp('miles')}/>
                                <AppIcon icon={Icons.Book} label="è®°è´¦æœ¬" onClick={()=>setCurrentApp('ledger')}/>
                                <AppIcon icon={Icons.Activity} label="NookFit" onClick={()=>setCurrentApp('fitness')}/>
                                <AppIcon icon={Icons.User} label="æŠ¤ç…§" onClick={()=>setCurrentApp('passport')}/>
                                <AppIcon icon={Icons.CreditCard} label="ABD" onClick={()=>setCurrentApp('finance')}/>
                                <AppIcon icon={Icons.Settings} label="è®¾ç½®" onClick={()=>setCurrentApp('settings')}/>
                            </div>

                            <div className={`absolute inset-0 p-6 bg-[#FDFDF6]/95 backdrop-blur-md rounded-[35px] transition-all duration-500 flex flex-col shadow-inner ${currentApp ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}`}>
                                {currentApp === 'miles' && <NookMilesApp 
                                    userStats={data.stats} 
                                    tasks={data.tasks} 
                                    setTasks={(v)=>updateData('tasks', v)} 
                                    updateStats={(v)=>updateData('stats', v)}
                                    addLedgerRecord={addLedgerRecord}
                                    addFitnessRecord={addFitnessRecord}
                                />}
                                {currentApp === 'ledger' && <LedgerApp ledger={data.ledger} setLedger={(v)=>updateData('ledger', v)}/>}
                                {currentApp === 'fitness' && <FitnessApp fitness={data.fitness} updateFitness={(v)=>updateData('fitness', v)}/>}
                                {currentApp === 'settings' && <SettingsApp 
                                    user={currentUser} 
                                    currentTheme={data.themeId} 
                                    currentAvatar={data.avatar}
                                    changeTheme={(id)=>updateData('themeId', id)}
                                    changeAvatar={(url)=>updateData('avatar', url)}
                                    onSave={handleSave}
                                    onLogout={handleLogout}
                                    onReset={()=>setResetStep(1)}
                                    loading={saveLoading}
                                />}
                                {currentApp === 'passport' && <PassportApp user={currentUser} stats={data.stats} avatar={data.avatar}/>}
                                {currentApp === 'finance' && <FinanceApp stats={data.stats} setStats={(newStats) => updateData('stats', newStats)}/>}
                                <div className="mt-auto pt-4 flex justify-center shrink-0">
                                    <button onClick={()=>setCurrentApp(null)} className="nook-btn-secondary px-6 py-2 rounded-full font-bold text-sm">è¿”å›æ¡Œé¢</button>
                                </div>
                            </div>
                        </div>
                        <div className="h-8 w-full flex justify-center items-center shrink-0 z-20 pb-2">
                            <div className="w-1/3 h-1.5 bg-white/60 rounded-full"></div>
                        </div>
                    </div>
                    <div className="mt-4 text-white/80 font-bold text-xs tracking-widest opacity-80 uppercase">Nook Inc. OS v5.4 (FAB UI)</div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>